import t from"@firebase/app";import{Logger as e,LogLevel as s}from"@firebase/logger";import{getUA as n,isReactNative as i,isElectron as r,isIE as o,isUWP as h,isBrowserExtension as a}from"@firebase/util";import{Component as u}from"@firebase/component";import{XhrIo as c,EventType as l,ErrorCode as _,createWebChannelTransport as d,WebChannel as f}from"@firebase/webchannel-wrapper";const m=t.SDK_VERSION,T=new e("@firebase/firestore");var E;function w(){return T.logLevel===s.DEBUG?E.DEBUG:T.logLevel===s.SILENT?E.SILENT:E.ERROR}function I(t){switch(t){case E.DEBUG:T.logLevel=s.DEBUG;break;case E.ERROR:T.logLevel=s.ERROR;break;case E.SILENT:T.logLevel=s.SILENT;break;default:T.error(`Firestore (${m}): Invalid value passed to \`setLogLevel\``)}}function R(t,e,...n){if(T.logLevel<=s.DEBUG){const s=n.map(P);T.debug(`Firestore (${m}) [${t}]: ${e}`,...s)}}function A(t,...e){if(T.logLevel<=s.ERROR){const s=e.map(P);T.error(`Firestore (${m}): ${t}`,...s)}}function P(t){if("string"==typeof t)return t;{const e=Ss.t();try{return e.s(t)}catch(e){return t}}}function V(t){const e=`FIRESTORE (${m}) INTERNAL ASSERTION FAILED: `+t;throw A(e),new Error(e)}function p(t,e){t||V(e)}!function(t){t[t.DEBUG=0]="DEBUG",t[t.ERROR=1]="ERROR",t[t.SILENT=2]="SILENT"}(E||(E={}));class g{static i(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let s=0;s<20;s++)e+=t.charAt(Math.floor(Math.random()*t.length));return p(20===e.length,"Invalid auto ID: "+e),e}}function y(t,e){return t<e?-1:t>e?1:0}function b(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!t[s].isEqual(e[s]))return!1;return!0}function v(t){return t+"\0"}class S{constructor(t,e,s,n,i){this.o=t,this.persistenceKey=e,this.host=s,this.ssl=n,this.forceLongPolling=i}}const D="(default)";class C{constructor(t,e){this.projectId=t,this.database=e||D}get h(){return this.database===D}isEqual(t){return t instanceof C&&t.projectId===this.projectId&&t.database===this.database}u(t){return y(this.projectId,t.projectId)||y(this.database,t.database)}}var k,N,F,$;(N=k||(k={}))[N.l=0]="__PRIVATE_Unknown",N[N._=1]="__PRIVATE_Online",N[N.m=2]="__PRIVATE_Offline",($=F||(F={}))[$.T=0]="__PRIVATE_RemoteStore",$[$.I=1]="__PRIVATE_SharedClientState";class M{constructor(t){this.uid=t}R(){return null!=this.uid}A(){return this.R()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}M.P=new M(null),M.V=new M("google-credentials-uid"),M.p=new M("first-party-uid");const x={g:"ok",v:"cancelled",S:"unknown",D:"invalid-argument",C:"deadline-exceeded",k:"not-found",N:"already-exists",PERMISSION_DENIED:"permission-denied",P:"unauthenticated",F:"resource-exhausted",$:"failed-precondition",M:"aborted",L:"out-of-range",q:"unimplemented",INTERNAL:"internal",O:"unavailable",B:"data-loss"};class L extends Error{constructor(t,e){super(e),this.code=t,this.message=e,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class q{constructor(t,e){this.user=e,this.type="OAuth",this.U={},this.U.Authorization=`Bearer ${t}`}}class O{constructor(){this.W=null}getToken(){return Promise.resolve(null)}j(){}K(t){p(!this.W,"Can only call setChangeListener() once."),this.W=t,t(M.P)}G(){p(null!==this.W,"removeChangeListener() when no listener registered"),this.W=null}}class B{constructor(t){this.H=null,this.currentUser=M.P,this.J=!1,this.Y=0,this.W=null,this.forceRefresh=!1,this.H=()=>{this.Y++,this.currentUser=this.X(),this.J=!0,this.W&&this.W(this.currentUser)},this.Y=0,this.auth=t.getImmediate({optional:!0}),this.auth?this.auth.addAuthTokenListener(this.H):(this.H(null),t.get().then(t=>{this.auth=t,this.H&&this.auth.addAuthTokenListener(this.H)},()=>{}))}getToken(){p(null!=this.H,"getToken cannot be called after listener removed.");const t=this.Y,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>{if(this.Y!==t)throw new L(x.M,"getToken aborted due to token change.");return e?(p("string"==typeof e.accessToken,"Invalid tokenData returned from getToken():"+e),new q(e.accessToken,this.currentUser)):null}):Promise.resolve(null)}j(){this.forceRefresh=!0}K(t){p(!this.W,"Can only call setChangeListener() once."),this.W=t,this.J&&t(this.currentUser)}G(){p(null!=this.H,"removeChangeListener() called twice"),p(null!==this.W,"removeChangeListener() called when no listener registered"),this.auth&&this.auth.removeAuthTokenListener(this.H),this.H=null,this.W=null}X(){const t=this.auth&&this.auth.getUid();return p(null===t||"string"==typeof t,"Received invalid UID: "+t),new M(t)}}class U{constructor(t,e){this.Z=t,this.tt=e,this.type="FirstParty",this.user=M.p}get U(){const t={"X-Goog-AuthUser":this.tt},e=this.Z.auth.et([]);return e&&(t.Authorization=e),t}}class Q{constructor(t,e){this.Z=t,this.tt=e}getToken(){return Promise.resolve(new U(this.Z,this.tt))}K(t){t(M.p)}G(){}j(){}}function W(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function j(t,e){return void 0!==t?t:e}function K(t,e){for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)){const n=Number(s);isNaN(n)||e(n,t[s])}}function G(t,e){for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&e(s,t[s])}function z(t){p(null!=t&&"object"==typeof t,"isEmpty() expects object parameter.");for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}function H(t,e){if(0!==e.length)throw new L(x.D,`Function ${t}() does not support arguments, `+"but was called with "+dt(e.length,"argument")+".")}function J(t,e,s){if(e.length!==s)throw new L(x.D,`Function ${t}() requires `+dt(s,"argument")+", but was called with "+dt(e.length,"argument")+".")}function Y(t,e,s){if(e.length<s)throw new L(x.D,`Function ${t}() requires at least `+dt(s,"argument")+", but was called with "+dt(e.length,"argument")+".")}function X(t,e,s,n){if(e.length<s||e.length>n)throw new L(x.D,`Function ${t}() requires between ${s} and `+`${n} arguments, but was called with `+dt(e.length,"argument")+".")}function Z(t,e,s,n){rt(t,e,`${_t(s)} argument`,n)}function tt(t,e,s,n){void 0!==n&&Z(t,e,s,n)}function et(t,e,s,n){rt(t,e,`${s} option`,n)}function st(t,e,s,n){void 0!==n&&et(t,e,s,n)}function nt(t,e,s,n,i){void 0!==n&&function(t,e,s,n,i){if(!(n instanceof Array))throw new L(x.D,`Function ${t}() requires its ${e} `+`option to be an array, but it was: ${ht(n)}`);for(let r=0;r<n.length;++r)if(!i(n[r]))throw new L(x.D,`Function ${t}() requires all ${e} `+`elements to be ${s}, but the value at index ${r} `+`was: ${ht(n[r])}`)}(t,e,s,n,i)}function it(t,e,s,n,i){void 0!==n&&function(t,e,s,n,i){const r=[];for(const t of i){if(t===n)return;r.push(ht(t))}const o=ht(n);throw new L(x.D,`Invalid value ${o} provided to function ${t}() for option `+`"${s}". Acceptable values: ${r.join(", ")}`)}(t,0,s,n,i)}function rt(t,e,s,n){let i=!1;if(!(i="object"===e?ot(n):"non-empty string"===e?"string"==typeof n&&""!==n:typeof n===e)){const i=ht(n);throw new L(x.D,`Function ${t}() requires its ${s} `+`to be of type ${e}, but it was: ${i}`)}}function ot(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}function ht(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){if(t.constructor){const e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&e.length>1)return e[1]}return null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":V("Unknown wrong type: "+typeof t)}function at(t,e,s){if(void 0===s)throw new L(x.D,`Function ${t}() requires a valid ${_t(e)} `+"argument, but it was undefined.")}function ut(t,e,s){G(e,(e,n)=>{if(s.indexOf(e)<0)throw new L(x.D,`Unknown option '${e}' passed to function ${t}(). `+"Available options: "+s.join(", "))})}function ct(t,e,s,n){const i=ht(n);return new L(x.D,`Function ${t}() requires its ${_t(s)} `+`argument to be a ${e}, but it was: ${i}`)}function lt(t,e,s){if(s<=0)throw new L(x.D,`Function "${t}()" requires its ${_t(e)} argument to be a positive number, but it was: ${s}.`)}function _t(t){switch(t){case 1:return"first";case 2:return"second";case 3:return"third";default:return t+"th"}}function dt(t,e){return`${t} ${e}`+(1===t?"":"s")}class ft{constructor(t,e){if(J("GeoPoint",arguments,2),Z("GeoPoint","number",1,t),Z("GeoPoint","number",2,e),!isFinite(t)||t<-90||t>90)throw new L(x.D,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new L(x.D,"Longitude must be a number between -180 and 180, but was: "+e);this.st=t,this.nt=e}get latitude(){return this.st}get longitude(){return this.nt}isEqual(t){return this.st===t.st&&this.nt===t.nt}it(t){return y(this.st,t.st)||y(this.nt,t.nt)}}class mt{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new L(x.D,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new L(x.D,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new L(x.D,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new L(x.D,"Timestamp seconds out of range: "+t)}static now(){return mt.fromMillis(Date.now())}static fromDate(t){return mt.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3);return new mt(e,1e6*(t-1e3*e))}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}it(t){return this.seconds===t.seconds?y(this.nanoseconds,t.nanoseconds):y(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}}class Tt{constructor(t){this.timestamp=t}static rt(t){const e=Math.floor(t/1e6);return new Tt(new mt(e,t%1e6*1e3))}static ot(t){return new Tt(t)}static ht(){return Tt.MIN}u(t){return this.timestamp.it(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}at(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}ut(){return this.timestamp}}Tt.MIN=new Tt(new mt(0,0));const Et="__name__";class wt{constructor(t,e,s){void 0===e?e=0:e>t.length&&V("offset "+e+" out of range "+t.length),void 0===s?s=t.length-e:s>t.length-e&&V("length "+s+" out of range "+(t.length-e)),this.segments=t,this.offset=e,this.ct=s}get length(){return this.ct}isEqual(t){return 0===wt.lt(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof wt?t.forEach(t=>{e.push(t)}):e.push(t),this._t(e)}limit(){return this.offset+this.length}dt(t){return t=void 0===t?1:t,p(this.length>=t,"Can't call popFirst() with less segments"),this._t(this.segments,this.offset+t,this.length-t)}ft(){return p(!this.Tt(),"Can't call popLast() on empty path"),this._t(this.segments,this.offset,this.length-1)}Et(){return p(!this.Tt(),"Can't call firstSegment() on empty path"),this.segments[this.offset]}wt(){return this.get(this.length-1)}get(t){return p(t<this.length,"Index out of range"),this.segments[this.offset+t]}Tt(){return 0===this.length}It(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}Rt(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,s=this.limit();e<s;e++)t(this.segments[e])}At(){return this.segments.slice(this.offset,this.limit())}static lt(t,e){const s=Math.min(t.length,e.length);for(let n=0;n<s;n++){const s=t.get(n),i=e.get(n);if(s<i)return-1;if(s>i)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class It extends wt{_t(t,e,s){return new It(t,e,s)}Pt(){return this.At().join("/")}toString(){return this.Pt()}static Vt(t){if(t.indexOf("//")>=0)throw new L(x.D,`Invalid path (${t}). Paths must not contain // in them.`);const e=t.split("/").filter(t=>t.length>0);return new It(e)}}It.pt=new It([]);const Rt=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class At extends wt{_t(t,e,s){return new At(t,e,s)}static gt(t){return Rt.test(t)}Pt(){return this.At().map(t=>(t=t.replace("\\","\\\\").replace("`","\\`"),At.gt(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.Pt()}yt(){return 1===this.length&&this.get(0)===Et}static bt(){return new At([Et])}static vt(t){const e=[];let s="",n=0;const i=()=>{if(0===s.length)throw new L(x.D,`Invalid field path (${t}). Paths must not be empty, begin `+"with '.', end with '.', or contain '..'");e.push(s),s=""};let r=!1;for(;n<t.length;){const e=t[n];if("\\"===e){if(n+1===t.length)throw new L(x.D,"Path has trailing escape character: "+t);const e=t[n+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new L(x.D,"Path has invalid escape sequence: "+t);s+=e,n+=2}else"`"===e?(r=!r,n++):"."!==e||r?(s+=e,n++):(i(),n++)}if(i(),r)throw new L(x.D,"Unterminated ` in path: "+t);return new At(e)}}At.pt=new At([]);class Pt{constructor(t){this.path=t,p(Pt.St(t),"Invalid DocumentKey with an odd number of segments: "+t.At().join("/"))}Dt(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===It.lt(this.path,t.path)}toString(){return this.path.toString()}static lt(t,e){return It.lt(t.path,e.path)}static St(t){return t.length%2==0}static Ct(t){return new Pt(new It(t.slice()))}static kt(t){return new Pt(It.Vt(t))}}Pt.EMPTY=new Pt(new It([]));class Vt{constructor(t,e){this.lt=t,this.root=e||gt.EMPTY}Nt(t,e){return new Vt(this.lt,this.root.Nt(t,e,this.lt).Ft(null,null,gt.$t,null,null))}remove(t){return new Vt(this.lt,this.root.remove(t,this.lt).Ft(null,null,gt.$t,null,null))}get(t){let e=this.root;for(;!e.Tt();){const s=this.lt(t,e.key);if(0===s)return e.value;s<0?e=e.left:s>0&&(e=e.right)}return null}indexOf(t){let e=0,s=this.root;for(;!s.Tt();){const n=this.lt(t,s.key);if(0===n)return e+s.left.size;n<0?s=s.left:(e+=s.left.size+1,s=s.right)}return-1}Tt(){return this.root.Tt()}get size(){return this.root.size}Mt(){return this.root.Mt()}xt(){return this.root.xt()}Lt(t){return this.root.Lt(t)}forEach(t){this.Lt((e,s)=>(t(e,s),!1))}toString(){const t=[];return this.Lt((e,s)=>(t.push(`${e}:${s}`),!1)),`{${t.join(", ")}}`}qt(t){return this.root.qt(t)}Ot(){return new pt(this.root,null,this.lt,!1)}Bt(t){return new pt(this.root,t,this.lt,!1)}Ut(){return new pt(this.root,null,this.lt,!0)}Qt(t){return new pt(this.root,t,this.lt,!0)}}class pt{constructor(t,e,s,n){this.Wt=n,this.jt=[];let i=1;for(;!t.Tt();)if(i=e?s(t.key,e):1,n&&(i*=-1),i<0)t=this.Wt?t.left:t.right;else{if(0===i){this.jt.push(t);break}this.jt.push(t),t=this.Wt?t.right:t.left}}Kt(){p(this.jt.length>0,"getNext() called on iterator when hasNext() is false.");let t=this.jt.pop();const e={key:t.key,value:t.value};if(this.Wt)for(t=t.left;!t.Tt();)this.jt.push(t),t=t.right;else for(t=t.right;!t.Tt();)this.jt.push(t),t=t.left;return e}Gt(){return this.jt.length>0}zt(){if(0===this.jt.length)return null;const t=this.jt[this.jt.length-1];return{key:t.key,value:t.value}}}class gt{constructor(t,e,s,n,i){this.key=t,this.value=e,this.color=null!=s?s:gt.RED,this.left=null!=n?n:gt.EMPTY,this.right=null!=i?i:gt.EMPTY,this.size=this.left.size+1+this.right.size}Ft(t,e,s,n,i){return new gt(null!=t?t:this.key,null!=e?e:this.value,null!=s?s:this.color,null!=n?n:this.left,null!=i?i:this.right)}Tt(){return!1}Lt(t){return this.left.Lt(t)||t(this.key,this.value)||this.right.Lt(t)}qt(t){return this.right.qt(t)||t(this.key,this.value)||this.left.qt(t)}min(){return this.left.Tt()?this:this.left.min()}Mt(){return this.min().key}xt(){return this.right.Tt()?this.key:this.right.xt()}Nt(t,e,s){let n=this;const i=s(t,n.key);return(n=i<0?n.Ft(null,null,null,n.left.Nt(t,e,s),null):0===i?n.Ft(null,e,null,null,null):n.Ft(null,null,null,null,n.right.Nt(t,e,s))).Ht()}Jt(){if(this.left.Tt())return gt.EMPTY;let t=this;return t.left.Yt()||t.left.left.Yt()||(t=t.Xt()),(t=t.Ft(null,null,null,t.left.Jt(),null)).Ht()}remove(t,e){let s,n=this;if(e(t,n.key)<0)n.left.Tt()||n.left.Yt()||n.left.left.Yt()||(n=n.Xt()),n=n.Ft(null,null,null,n.left.remove(t,e),null);else{if(n.left.Yt()&&(n=n.Zt()),n.right.Tt()||n.right.Yt()||n.right.left.Yt()||(n=n.te()),0===e(t,n.key)){if(n.right.Tt())return gt.EMPTY;s=n.right.min(),n=n.Ft(s.key,s.value,null,null,n.right.Jt())}n=n.Ft(null,null,null,null,n.right.remove(t,e))}return n.Ht()}Yt(){return this.color}Ht(){let t=this;return t.right.Yt()&&!t.left.Yt()&&(t=t.ee()),t.left.Yt()&&t.left.left.Yt()&&(t=t.Zt()),t.left.Yt()&&t.right.Yt()&&(t=t.se()),t}Xt(){let t=this.se();return t.right.left.Yt()&&(t=(t=(t=t.Ft(null,null,null,null,t.right.Zt())).ee()).se()),t}te(){let t=this.se();return t.left.left.Yt()&&(t=(t=t.Zt()).se()),t}ee(){const t=this.Ft(null,null,gt.RED,null,this.right.left);return this.right.Ft(null,null,this.color,t,null)}Zt(){const t=this.Ft(null,null,gt.RED,this.left.right,null);return this.left.Ft(null,null,this.color,null,t)}se(){const t=this.left.Ft(null,null,!this.left.color,null,null),e=this.right.Ft(null,null,!this.right.color,null,null);return this.Ft(null,null,!this.color,t,e)}ne(){const t=this.ie();return Math.pow(2,t)<=this.size+1}ie(){if(this.Yt()&&this.left.Yt())throw V("Red node has red child("+this.key+","+this.value+")");if(this.right.Yt())throw V("Right child of ("+this.key+","+this.value+") is red");const t=this.left.ie();if(t!==this.right.ie())throw V("Black depths differ");return t+(this.Yt()?0:1)}}gt.EMPTY=null,gt.RED=!0,gt.$t=!1;gt.EMPTY=new class{constructor(){this.size=0}get key(){throw V("LLRBEmptyNode has no key.")}get value(){throw V("LLRBEmptyNode has no value.")}get color(){throw V("LLRBEmptyNode has no color.")}get left(){throw V("LLRBEmptyNode has no left child.")}get right(){throw V("LLRBEmptyNode has no right child.")}Ft(t,e,s,n,i){return this}Nt(t,e,s){return new gt(t,e)}remove(t,e){return this}Tt(){return!0}Lt(t){return!1}qt(t){return!1}Mt(){return null}xt(){return null}Yt(){return!1}ne(){return!0}ie(){return 0}};class yt{constructor(t){this.lt=t,this.data=new Vt(this.lt)}static re(t){let e=new yt(t.lt);return t.forEach(t=>{e=e.add(t)}),e}has(t){return null!==this.data.get(t)}first(){return this.data.Mt()}last(){return this.data.xt()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.Lt((e,s)=>(t(e),!1))}oe(t,e){const s=this.data.Bt(t[0]);for(;s.Gt();){const n=s.Kt();if(this.lt(n.key,t[1])>=0)return;e(n.key)}}he(t,e){let s;for(s=void 0!==e?this.data.Bt(e):this.data.Ot();s.Gt();){if(!t(s.Kt().key))return}}ae(t){const e=this.data.Bt(t);return e.Gt()?e.Kt().key:null}Ot(){return new bt(this.data.Ot())}Bt(t){return new bt(this.data.Bt(t))}add(t){return this.Ft(this.data.remove(t).Nt(t,!0))}delete(t){return this.has(t)?this.Ft(this.data.remove(t)):this}Tt(){return this.data.Tt()}ue(t){let e=this;return t.forEach(t=>{e=e.add(t)}),e}isEqual(t){if(!(t instanceof yt))return!1;if(this.size!==t.size)return!1;const e=this.data.Ot(),s=t.data.Ot();for(;e.Gt();){const t=e.Kt().key,n=s.Kt().key;if(0!==this.lt(t,n))return!1}return!0}At(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}Ft(t){const e=new yt(this.lt);return e.data=t,e}}class bt{constructor(t){this.ce=t}Kt(){return this.ce.Kt().key}Gt(){return this.ce.Gt()}}class vt{constructor(){}le(t,e){return new re(e,t)}_e(t,e){return e}de(t){return null}isEqual(t){return t instanceof vt}}vt.instance=new vt;class St{constructor(t){this.elements=t}le(t,e){return this.apply(t)}_e(t,e){return this.apply(t)}apply(t){const e=kt(t);for(const t of this.elements)e.find(e=>e.isEqual(t))||e.push(t);return new ce(e)}de(t){return null}isEqual(t){return t instanceof St&&b(t.elements,this.elements)}}class Dt{constructor(t){this.elements=t}le(t,e){return this.apply(t)}_e(t,e){return this.apply(t)}apply(t){let e=kt(t);for(const t of this.elements)e=e.filter(e=>!e.isEqual(t));return new ce(e)}de(t){return null}isEqual(t){return t instanceof Dt&&b(t.elements,this.elements)}}class Ct{constructor(t){this.fe=t}le(t,e){const s=this.de(t);if(s instanceof ee&&this.fe instanceof ee){const t=s.me+this.fe.me;return new ee(t)}{const t=s.me+this.fe.me;return new se(t)}}_e(t,e){return p(null!==e,"Didn't receive transformResult for NUMERIC_ADD transform"),e}de(t){return t instanceof Zt?t:new ee(0)}isEqual(t){return t instanceof Ct&&this.fe.isEqual(t.fe)}}function kt(t){return t instanceof ce?t.me.slice():[]}class Nt{constructor(t){this.fields=t}static Te(t){return new Nt(t)}static Ee(t){let e=new yt(At.lt);return t.forEach(t=>e=e.add(t)),new Nt(e)}we(t){let e=!1;return this.fields.forEach(s=>{s.It(t)&&(e=!0)}),e}isEqual(t){return this.fields.isEqual(t.fields)}}class Ft{constructor(t,e){this.field=t,this.transform=e}isEqual(t){return this.field.isEqual(t.field)&&this.transform.isEqual(t.transform)}}class $t{constructor(t,e){this.version=t,this.transformResults=e}}var Mt,xt,Lt,qt,Ot,Bt;(xt=Mt||(Mt={}))[xt.Set=0]="Set",xt[xt.Ie=1]="__PRIVATE_Patch",xt[xt.Re=2]="__PRIVATE_Transform",xt[xt.Ae=3]="__PRIVATE_Delete",xt[xt.Pe=4]="__PRIVATE_Verify";class Ut{constructor(t,e){this.updateTime=t,this.exists=e,p(void 0===t||void 0===e,'Precondition can specify "exists" or "updateTime" but not both')}static exists(t){return new Ut(void 0,t)}static updateTime(t){return new Ut(t)}get Ve(){return void 0===this.updateTime&&void 0===this.exists}pe(t){return void 0!==this.updateTime?t instanceof _e&&t.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===t instanceof _e:(p(this.Ve,"Precondition should be empty"),!0)}isEqual(t){return e=this.updateTime,s=t.updateTime,(null!=e?!(!s||!e.isEqual(s)):e===s)&&this.exists===t.exists;var e,s}}Ut.NONE=new Ut;class Qt{ge(t){null!=t&&p(t.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")}static ye(t){return t instanceof _e?t.version:Tt.MIN}}class Wt extends Qt{constructor(t,e,s){super(),this.key=t,this.value=e,this.be=s,this.type=Mt.Set}_e(t,e){this.ge(t),p(null==e.transformResults,"Transform results received by SetMutation.");const s=e.version;return new _e(this.key,s,{hasCommittedMutations:!0},this.value)}le(t,e,s){if(this.ge(t),!this.be.pe(t))return t;const n=Qt.ye(t);return new _e(this.key,n,{ve:!0},this.value)}Se(t){return null}isEqual(t){return t instanceof Wt&&this.key.isEqual(t.key)&&this.value.isEqual(t.value)&&this.be.isEqual(t.be)}}class jt extends Qt{constructor(t,e,s,n){super(),this.key=t,this.data=e,this.De=s,this.be=n,this.type=Mt.Ie}_e(t,e){if(this.ge(t),p(null==e.transformResults,"Transform results received by PatchMutation."),!this.be.pe(t))return new fe(this.key,e.version);const s=this.Ce(t);return new _e(this.key,e.version,{hasCommittedMutations:!0},s)}le(t,e,s){if(this.ge(t),!this.be.pe(t))return t;const n=Qt.ye(t),i=this.Ce(t);return new _e(this.key,n,{ve:!0},i)}Se(t){return null}isEqual(t){return t instanceof jt&&this.key.isEqual(t.key)&&this.De.isEqual(t.De)&&this.be.isEqual(t.be)}Ce(t){let e;return e=t instanceof _e?t.data():ue.EMPTY,this.ke(e)}ke(t){return this.De.fields.forEach(e=>{if(!e.Tt()){const s=this.data.field(e);t=null!==s?t.set(e,s):t.delete(e)}}),t}}class Kt extends Qt{constructor(t,e){super(),this.key=t,this.fieldTransforms=e,this.type=Mt.Re,this.be=Ut.exists(!0)}_e(t,e){if(this.ge(t),p(null!=e.transformResults,"Transform results missing for TransformMutation."),!this.be.pe(t))return new fe(this.key,e.version);const s=this.Ne(t),n=this.Fe(t,e.transformResults),i=e.version,r=this.$e(s.data(),n);return new _e(this.key,i,{hasCommittedMutations:!0},r)}le(t,e,s){if(this.ge(t),!this.be.pe(t))return t;const n=this.Ne(t),i=this.Me(s,t,e),r=this.$e(n.data(),i);return new _e(this.key,n.version,{ve:!0},r)}Se(t){let e=null;for(const s of this.fieldTransforms){const n=t instanceof _e?t.field(s.field):void 0,i=s.transform.de(n||null);null!=i&&(e=null==e?ue.EMPTY.set(s.field,i):e.set(s.field,i))}return e}isEqual(t){return t instanceof Kt&&this.key.isEqual(t.key)&&b(this.fieldTransforms,t.fieldTransforms)&&this.be.isEqual(t.be)}Ne(t){return p(t instanceof _e,"Unknown MaybeDocument type "+t),p(t.key.isEqual(this.key),"Can only transform a document with the same key"),t}Fe(t,e){const s=[];p(this.fieldTransforms.length===e.length,`server transform result count (${e.length}) `+`should match field transform count (${this.fieldTransforms.length})`);for(let n=0;n<e.length;n++){const i=this.fieldTransforms[n],r=i.transform;let o=null;t instanceof _e&&(o=t.field(i.field)),s.push(r._e(o,e[n]))}return s}Me(t,e,s){const n=[];for(const i of this.fieldTransforms){const r=i.transform;let o=null;e instanceof _e&&(o=e.field(i.field)),null===o&&s instanceof _e&&(o=s.field(i.field)),n.push(r.le(o,t))}return n}$e(t,e){p(e.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(let s=0;s<this.fieldTransforms.length;s++){const n=this.fieldTransforms[s].field;t=t.set(n,e[s])}return t}}class Gt extends Qt{constructor(t,e){super(),this.key=t,this.be=e,this.type=Mt.Ae}_e(t,e){return this.ge(t),p(null==e.transformResults,"Transform results received by DeleteMutation."),new de(this.key,e.version,{hasCommittedMutations:!0})}le(t,e,s){return this.ge(t),this.be.pe(t)?(t&&p(t.key.isEqual(this.key),"Can only apply mutation to document with same key"),new de(this.key,Tt.ht())):t}Se(t){return null}isEqual(t){return t instanceof Gt&&this.key.isEqual(t.key)&&this.be.isEqual(t.be)}}class zt extends Qt{constructor(t,e){super(),this.key=t,this.be=e,this.type=Mt.Pe}_e(t,e){V("VerifyMutation should only be used in Transactions.")}le(t,e,s){V("VerifyMutation should only be used in Transactions.")}Se(t){V("VerifyMutation should only be used in Transactions.")}isEqual(t){return t instanceof zt&&this.key.isEqual(t.key)&&this.be.isEqual(t.be)}}(qt=Lt||(Lt={}))[qt.xe=0]="__PRIVATE_NullValue",qt[qt.Le=1]="__PRIVATE_BooleanValue",qt[qt.qe=2]="__PRIVATE_NumberValue",qt[qt.Oe=3]="__PRIVATE_TimestampValue",qt[qt.Be=4]="__PRIVATE_StringValue",qt[qt.Ue=5]="__PRIVATE_BlobValue",qt[qt.Qe=6]="__PRIVATE_RefValue",qt[qt.We=7]="__PRIVATE_GeoPointValue",qt[qt.ArrayValue=8]="ArrayValue",qt[qt.je=9]="__PRIVATE_ObjectValue",(Bt=Ot||(Ot={}))[Bt.Ke=0]="__PRIVATE_Default",Bt[Bt.Ge=1]="__PRIVATE_Estimate",Bt[Bt.ze=2]="__PRIVATE_Previous";class Ht{constructor(t,e){this.He=t,this.timestampsInSnapshots=e}static Je(t,e){switch(t.serverTimestamps){case"estimate":return new Ht(Ot.Ge,e);case"previous":return new Ht(Ot.ze,e);case"none":case void 0:return new Ht(Ot.Ke,e);default:return V("fromSnapshotOptions() called with invalid options.")}}}class Jt{toString(){const t=this.value();return null===t?"null":t.toString()}Ye(t){return p(this.Xe!==t.Xe,"Default compareTo should not be used for values of same type."),y(this.Xe,t.Xe)}}class Yt extends Jt{constructor(){super(),this.Xe=Lt.xe,this.me=null}value(t){return null}isEqual(t){return t instanceof Yt}u(t){return t instanceof Yt?0:this.Ye(t)}}Yt.Ze=new Yt;class Xt extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.Le}value(t){return this.me}isEqual(t){return t instanceof Xt&&this.me===t.me}u(t){return t instanceof Xt?y(this,t):this.Ye(t)}static of(t){return t?Xt.ts:Xt.es}}Xt.ts=new Xt(!0),Xt.es=new Xt(!1);class Zt extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.qe}value(t){return this.me}u(t){return t instanceof Zt?(e=this.me,s=t.me,e<s?-1:e>s?1:e===s?0:isNaN(e)?isNaN(s)?0:-1:1):this.Ye(t);var e,s}}function te(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e}class ee extends Zt{isEqual(t){return t instanceof ee&&te(this.me,t.me)}}class se extends Zt{isEqual(t){return t instanceof se&&te(this.me,t.me)}}se.ss=new se(NaN),se.POSITIVE_INFINITY=new se(1/0),se.NEGATIVE_INFINITY=new se(-1/0);class ne extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.Be}value(t){return this.me}isEqual(t){return t instanceof ne&&this.me===t.me}u(t){return t instanceof ne?y(this.me,t.me):this.Ye(t)}}class ie extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.Oe}value(t){return!t||t.timestampsInSnapshots?this.me:this.me.toDate()}isEqual(t){return t instanceof ie&&this.me.isEqual(t.me)}u(t){return t instanceof ie?this.me.it(t.me):t instanceof re?-1:this.Ye(t)}}class re extends Jt{constructor(t,e){super(),this.ns=t,this.previousValue=e,this.Xe=Lt.Oe}value(t){return t&&t.He===Ot.Ge?new ie(this.ns).value(t):t&&t.He===Ot.ze&&this.previousValue?this.previousValue.value(t):null}isEqual(t){return t instanceof re&&this.ns.isEqual(t.ns)}u(t){return t instanceof re?this.ns.it(t.ns):t instanceof ie?1:this.Ye(t)}toString(){return"<ServerTimestamp localTime="+this.ns.toString()+">"}}class oe extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.Ue}value(t){return this.me}isEqual(t){return t instanceof oe&&this.me.isEqual(t.me)}u(t){return t instanceof oe?this.me.it(t.me):this.Ye(t)}}class he extends Jt{constructor(t,e){super(),this.o=t,this.key=e,this.Xe=Lt.Qe}value(t){return this.key}isEqual(t){return t instanceof he&&(this.key.isEqual(t.key)&&this.o.isEqual(t.o))}u(t){if(t instanceof he){const e=this.o.u(t.o);return 0!==e?e:Pt.lt(this.key,t.key)}return this.Ye(t)}}class ae extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.We}value(t){return this.me}isEqual(t){return t instanceof ae&&this.me.isEqual(t.me)}u(t){return t instanceof ae?this.me.it(t.me):this.Ye(t)}}class ue extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.je}value(t){const e={};return this.me.Lt((s,n)=>{e[s]=n.value(t)}),e}forEach(t){this.me.Lt(t)}isEqual(t){if(t instanceof ue){const e=this.me.Ot(),s=t.me.Ot();for(;e.Gt()&&s.Gt();){const t=e.Kt(),n=s.Kt();if(t.key!==n.key||!t.value.isEqual(n.value))return!1}return!e.Gt()&&!s.Gt()}return!1}u(t){if(t instanceof ue){const e=this.me.Ot(),s=t.me.Ot();for(;e.Gt()&&s.Gt();){const t=e.Kt(),n=s.Kt(),i=y(t.key,n.key)||t.value.u(n.value);if(i)return i}return y(e.Gt(),s.Gt())}return this.Ye(t)}set(t,e){if(p(!t.Tt(),"Cannot set field for empty path on ObjectValue"),1===t.length)return this.rs(t.Et(),e);{let s=this.child(t.Et());s instanceof ue||(s=ue.EMPTY);const n=s.set(t.dt(),e);return this.rs(t.Et(),n)}}delete(t){if(p(!t.Tt(),"Cannot delete field for empty path on ObjectValue"),1===t.length)return new ue(this.me.remove(t.Et()));{const e=this.child(t.Et());if(e instanceof ue){const s=e.delete(t.dt());return new ue(this.me.Nt(t.Et(),s))}return this}}contains(t){return null!==this.field(t)}field(t){p(!t.Tt(),"Can't get field of empty path");let e=this;return t.forEach(t=>{e=e instanceof ue?e.me.get(t):null}),e}De(){let t=new yt(At.lt);return this.me.forEach((e,s)=>{const n=new At([e]);if(s instanceof ue){const e=s.De().fields;e.Tt()?t=t.add(n):e.forEach(e=>{t=t.add(n.child(e))})}else t=t.add(n)}),Nt.Te(t)}toString(){return this.me.toString()}child(t){return this.me.get(t)||void 0}rs(t,e){return new ue(this.me.Nt(t,e))}}ue.EMPTY=new ue(new Vt(y));class ce extends Jt{constructor(t){super(),this.me=t,this.Xe=Lt.ArrayValue}value(t){return this.me.map(e=>e.value(t))}contains(t){for(const e of this.me)if(e.isEqual(t))return!0;return!1}forEach(t){this.me.forEach(t)}isEqual(t){if(t instanceof ce){if(this.me.length!==t.me.length)return!1;for(let e=0;e<this.me.length;e++)if(!this.me[e].isEqual(t.me[e]))return!1;return!0}return!1}u(t){if(t instanceof ce){const e=Math.min(this.me.length,t.me.length);for(let s=0;s<e;s++){const e=this.me[s].u(t.me[s]);if(e)return e}return y(this.me.length,t.me.length)}return this.Ye(t)}toString(){return`[${this.me.map(t=>t.toString()).join(",")}]`}}class le{constructor(t,e){this.key=t,this.version=e}static os(t,e){return Pt.lt(t.key,e.key)}}class _e extends le{constructor(t,e,s,n,i,r){super(t,e),this.hs=n,this.proto=i,this.converter=r,p(void 0!==this.hs||void 0!==this.proto&&void 0!==this.converter,"If objectValue is not defined, proto and converter need to be set."),this.ve=!!s.ve,this.hasCommittedMutations=!!s.hasCommittedMutations}field(t){if(this.hs)return this.hs.field(t);{this.as||(this.as=new Map);const e=t.Pt();let s=this.as.get(e);if(void 0===s){const n=this.us(t);s=void 0===n?null:this.converter(n),this.as.set(e,s)}return s}}data(){if(!this.hs){let t=ue.EMPTY;G(this.proto.fields||{},(e,s)=>{t=t.set(new At([e]),this.converter(s))}),this.hs=t,this.as=void 0}return this.hs}value(){return this.data().value()}isEqual(t){return t instanceof _e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.ve===t.ve&&this.hasCommittedMutations===t.hasCommittedMutations&&this.data().isEqual(t.data())}toString(){return`Document(${this.key}, ${this.version}, ${this.data().toString()}, `+`{hasLocalMutations: ${this.ve}}), `+`{hasCommittedMutations: ${this.hasCommittedMutations}})`}get hasPendingWrites(){return this.ve||this.hasCommittedMutations}us(t){p(void 0!==this.proto,"Can only call getProtoField() when proto is defined");let e=this.proto.fields?this.proto.fields[t.Et()]:void 0;for(let s=1;s<t.length;++s){if(!e||!e.mapValue||!e.mapValue.fields)return;e=e.mapValue.fields[t.get(s)]}return e}static cs(t,e,s){const n=e.field(t),i=s.field(t);return null!==n&&null!==i?n.u(i):V("Trying to compare documents on fields that don't exist")}}class de extends le{constructor(t,e,s){super(t,e),this.hasCommittedMutations=!(!s||!s.hasCommittedMutations)}toString(){return`NoDocument(${this.key}, ${this.version})`}get hasPendingWrites(){return this.hasCommittedMutations}isEqual(t){return t instanceof de&&t.hasCommittedMutations===this.hasCommittedMutations&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)}}class fe extends le{toString(){return`UnknownDocument(${this.key}, ${this.version})`}get hasPendingWrites(){return!0}isEqual(t){return t instanceof fe&&t.version.isEqual(this.version)&&t.key.isEqual(this.key)}}const me=Number,Te=me.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),Ee=me.MAX_SAFE_INTEGER||Math.pow(2,53)-1,we=me.isInteger||(t=>"number"==typeof t&&isFinite(t)&&Math.floor(t)===t);function Ie(t){return null==t}function Re(t){return we(t)&&t<=Ee&&t>=Te}class Ae{constructor(t,e=null,s=[],n=[],i=null,r=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=s,this.filters=n,this.limit=i,this.startAt=r,this.endAt=o,this.ls=null}canonicalId(){if(null===this.ls){let t=this.path.Pt();null!==this.collectionGroup&&(t+="|cg:"+this.collectionGroup),t+="|f:";for(const e of this.filters)t+=e.canonicalId(),t+=",";t+="|ob:";for(const e of this.orderBy)t+=e.canonicalId(),t+=",";Ie(this.limit)||(t+="|l:",t+=this.limit),this.startAt&&(t+="|lb:",t+=this.startAt.canonicalId()),this.endAt&&(t+="|ub:",t+=this.endAt.canonicalId()),this.ls=t}return this.ls}toString(){let t=this.path.Pt();return null!==this.collectionGroup&&(t+=" collectionGroup="+this.collectionGroup),this.filters.length>0&&(t+=`, filters: [${this.filters.join(", ")}]`),Ie(this.limit)||(t+=", limit: "+this.limit),this.orderBy.length>0&&(t+=`, orderBy: [${this.orderBy.join(", ")}]`),this.startAt&&(t+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(t+=", endAt: "+this.endAt.canonicalId()),`Target(${t})`}isEqual(t){if(this.limit!==t.limit)return!1;if(this.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<this.orderBy.length;e++)if(!this.orderBy[e].isEqual(t.orderBy[e]))return!1;if(this.filters.length!==t.filters.length)return!1;for(let e=0;e<this.filters.length;e++)if(!this.filters[e].isEqual(t.filters[e]))return!1;return this.collectionGroup===t.collectionGroup&&(!!this.path.isEqual(t.path)&&(!(null!==this.startAt?!this.startAt.isEqual(t.startAt):null!==t.startAt)&&(null!==this.endAt?this.endAt.isEqual(t.endAt):null===t.endAt)))}_s(){return Pt.St(this.path)&&null===this.collectionGroup&&0===this.filters.length}}var Pe,Ve;(Ve=Pe||(Pe={})).ds="F",Ve.fs="L";class pe{constructor(t,e=null,s=[],n=[],i=null,r=Pe.ds,o=null,h=null){this.path=t,this.collectionGroup=e,this.ms=s,this.filters=n,this.limit=i,this.Ts=r,this.startAt=o,this.endAt=h,this.Es=null,this.ws=null,this.startAt&&this.Is(this.startAt),this.endAt&&this.Is(this.endAt)}static Rs(t){return new pe(t)}get orderBy(){if(null===this.Es){const t=this.As(),e=this.Ps();if(null!==t&&null===e)t.yt()?this.Es=[Me]:this.Es=[new $e(t),Me];else{p(null===t||null!==e&&t.isEqual(e),"First orderBy should match inequality field."),this.Es=[];let s=!1;for(const t of this.ms)this.Es.push(t),t.field.yt()&&(s=!0);if(!s){const t=this.ms.length>0?this.ms[this.ms.length-1].dir:Ne.ASCENDING;this.Es.push(t===Ne.ASCENDING?Me:xe)}}}return this.Es}Vs(t){p(null==this.As()||!(t instanceof be)||!t.ps()||t.field.isEqual(this.As()),"Query must only have one inequality field."),p(!this._s(),"No filtering allowed for document query");const e=this.filters.concat([t]);return new pe(this.path,this.collectionGroup,this.ms.slice(),e,this.limit,this.Ts,this.startAt,this.endAt)}gs(t){p(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");const e=this.ms.concat([t]);return new pe(this.path,this.collectionGroup,e,this.filters.slice(),this.limit,this.Ts,this.startAt,this.endAt)}ys(t){return new pe(this.path,this.collectionGroup,this.ms.slice(),this.filters.slice(),t,Pe.ds,this.startAt,this.endAt)}bs(t){return new pe(this.path,this.collectionGroup,this.ms.slice(),this.filters.slice(),t,Pe.fs,this.startAt,this.endAt)}vs(t){return new pe(this.path,this.collectionGroup,this.ms.slice(),this.filters.slice(),this.limit,this.Ts,t,this.endAt)}Ss(t){return new pe(this.path,this.collectionGroup,this.ms.slice(),this.filters.slice(),this.limit,this.Ts,this.startAt,t)}Ds(t){return new pe(t,null,this.ms.slice(),this.filters.slice(),this.limit,this.Ts,this.startAt,this.endAt)}Cs(){return 0===this.filters.length&&null===this.limit&&null==this.startAt&&null==this.endAt&&(0===this.ms.length||1===this.ms.length&&this.ms[0].field.yt())}canonicalId(){return`${this.ks().canonicalId()}|lt:${this.Ts}`}toString(){return`Query(target=${this.ks().toString()}; limitType=${this.Ts})`}isEqual(t){return this.ks().isEqual(t.ks())&&this.Ts===t.Ts}Ns(t,e){let s=!1;for(const n of this.orderBy){const i=n.compare(t,e);if(0!==i)return i;s=s||n.field.yt()}return p(s,"orderBy used that doesn't compare on key field"),0}matches(t){return this.Fs(t)&&this.$s(t)&&this.Ms(t)&&this.xs(t)}Ls(){return!Ie(this.limit)&&this.Ts===Pe.ds}qs(){return!Ie(this.limit)&&this.Ts===Pe.fs}Ps(){return this.ms.length>0?this.ms[0].field:null}As(){for(const t of this.filters)if(t instanceof be&&t.ps())return t.field;return null}Os(t){for(const e of this.filters)if(e instanceof be&&t.indexOf(e.op)>=0)return e.op;return null}_s(){return this.ks()._s()}Bs(){return null!==this.collectionGroup}ks(){if(!this.ws)if(this.Ts===Pe.ds)this.ws=new Ae(this.path,this.collectionGroup,this.orderBy,this.filters,this.limit,this.startAt,this.endAt);else{const t=[];for(const e of this.orderBy){const s=e.dir===Ne.DESCENDING?Ne.ASCENDING:Ne.DESCENDING;t.push(new $e(e.field,s))}const e=this.endAt?new Fe(this.endAt.position,!this.endAt.before):null,s=this.startAt?new Fe(this.startAt.position,!this.startAt.before):null;this.ws=new Ae(this.path,this.collectionGroup,t,this.filters,this.limit,e,s)}return this.ws}Fs(t){const e=t.key.path;return null!==this.collectionGroup?t.key.Dt(this.collectionGroup)&&this.path.It(e):Pt.St(this.path)?this.path.isEqual(e):this.path.Rt(e)}$s(t){for(const e of this.ms)if(!e.field.yt()&&null===t.field(e.field))return!1;return!0}Ms(t){for(const e of this.filters)if(!e.matches(t))return!1;return!0}xs(t){return!(this.startAt&&!this.startAt.Us(this.orderBy,t))&&(!this.endAt||!this.endAt.Us(this.orderBy,t))}Is(t){p(t.position.length<=this.orderBy.length,"Bound is longer than orderBy")}}class ge{}class ye{constructor(t){this.name=t}static Vt(t){switch(t){case"<":return ye.LESS_THAN;case"<=":return ye.LESS_THAN_OR_EQUAL;case"==":return ye.EQUAL;case">=":return ye.GREATER_THAN_OR_EQUAL;case">":return ye.GREATER_THAN;case"array-contains":return ye.ARRAY_CONTAINS;case"in":return ye.IN;case"array-contains-any":return ye.ARRAY_CONTAINS_ANY;default:return V("Unknown FieldFilter operator: "+t)}}toString(){return this.name}isEqual(t){return this.name===t.name}}ye.LESS_THAN=new ye("<"),ye.LESS_THAN_OR_EQUAL=new ye("<="),ye.EQUAL=new ye("=="),ye.GREATER_THAN=new ye(">"),ye.GREATER_THAN_OR_EQUAL=new ye(">="),ye.ARRAY_CONTAINS=new ye("array-contains"),ye.IN=new ye("in"),ye.ARRAY_CONTAINS_ANY=new ye("array-contains-any");class be extends ge{constructor(t,e,s){super(),this.field=t,this.op=e,this.value=s}static create(t,e,s){if(t.yt())return e===ye.IN?(p(s instanceof ce,"Comparing on key with IN, but filter value not an ArrayValue"),p(s.me.every(t=>t instanceof he),"Comparing on key with IN, but an array value was not a RefValue"),new Se(t,s)):(p(s instanceof he,"Comparing on key, but filter value not a RefValue"),p(e!==ye.ARRAY_CONTAINS&&e!==ye.ARRAY_CONTAINS_ANY,`'${e.toString()}' queries don't make sense on document keys.`),new ve(t,e,s));if(s.isEqual(Yt.Ze)){if(e!==ye.EQUAL)throw new L(x.D,"Invalid query. Null supports only equality comparisons.");return new be(t,e,s)}if(s.isEqual(se.ss)){if(e!==ye.EQUAL)throw new L(x.D,"Invalid query. NaN supports only equality comparisons.");return new be(t,e,s)}return e===ye.ARRAY_CONTAINS?new De(t,s):e===ye.IN?(p(s instanceof ce,"IN filter has invalid value: "+s.toString()),new Ce(t,s)):e===ye.ARRAY_CONTAINS_ANY?(p(s instanceof ce,"ARRAY_CONTAINS_ANY filter has invalid value: "+s.toString()),new ke(t,s)):new be(t,e,s)}matches(t){const e=t.field(this.field);return null!==e&&this.value.Xe===e.Xe&&this.Qs(e.u(this.value))}Qs(t){switch(this.op){case ye.LESS_THAN:return t<0;case ye.LESS_THAN_OR_EQUAL:return t<=0;case ye.EQUAL:return 0===t;case ye.GREATER_THAN:return t>0;case ye.GREATER_THAN_OR_EQUAL:return t>=0;default:return V("Unknown FieldFilter operator: "+this.op)}}ps(){return[ye.LESS_THAN,ye.LESS_THAN_OR_EQUAL,ye.GREATER_THAN,ye.GREATER_THAN_OR_EQUAL].indexOf(this.op)>=0}canonicalId(){return this.field.Pt()+this.op.toString()+this.value.toString()}isEqual(t){return t instanceof be&&(this.op.isEqual(t.op)&&this.field.isEqual(t.field)&&this.value.isEqual(t.value))}toString(){return`${this.field.Pt()} ${this.op} ${this.value.value()}`}}class ve extends be{matches(t){const e=this.value,s=Pt.lt(t.key,e.key);return this.Qs(s)}}class Se extends be{constructor(t,e){super(t,ye.IN,e),this.value=e}matches(t){return this.value.me.some(e=>t.key.isEqual(e.key))}}class De extends be{constructor(t,e){super(t,ye.ARRAY_CONTAINS,e)}matches(t){const e=t.field(this.field);return e instanceof ce&&e.contains(this.value)}}class Ce extends be{constructor(t,e){super(t,ye.IN,e),this.value=e}matches(t){const e=this.value,s=t.field(this.field);return null!==s&&e.contains(s)}}class ke extends be{constructor(t,e){super(t,ye.ARRAY_CONTAINS_ANY,e),this.value=e}matches(t){const e=t.field(this.field);return e instanceof ce&&e.me.some(t=>this.value.contains(t))}}class Ne{constructor(t){this.name=t}toString(){return this.name}}Ne.ASCENDING=new Ne("asc"),Ne.DESCENDING=new Ne("desc");class Fe{constructor(t,e){this.position=t,this.before=e}canonicalId(){let t=this.before?"b:":"a:";for(const e of this.position)t+=e.toString();return t}Us(t,e){p(this.position.length<=t.length,"Bound has more components than query's orderBy");let s=0;for(let n=0;n<this.position.length;n++){const i=t[n],r=this.position[n];if(i.field.yt())p(r instanceof he,"Bound has a non-key value where the key path is being used."),s=Pt.lt(r.key,e.key);else{const t=e.field(i.field);p(null!==t,"Field should exist since document matched the orderBy already."),s=r.u(t)}if(i.dir===Ne.DESCENDING&&(s*=-1),0!==s)break}return this.before?s<=0:s<0}isEqual(t){if(null===t)return!1;if(this.before!==t.before||this.position.length!==t.position.length)return!1;for(let e=0;e<this.position.length;e++){const s=this.position[e],n=t.position[e];if(!s.isEqual(n))return!1}return!0}}class $e{constructor(t,e){this.field=t,void 0===e&&(e=Ne.ASCENDING),this.dir=e,this.Ws=t.yt()}compare(t,e){const s=this.Ws?_e.os(t,e):_e.cs(this.field,t,e);switch(this.dir){case Ne.ASCENDING:return s;case Ne.DESCENDING:return-1*s;default:return V("Unknown direction: "+this.dir)}}canonicalId(){return this.field.Pt()+this.dir.toString()}toString(){return`${this.field.Pt()} (${this.dir})`}isEqual(t){return this.dir===t.dir&&this.field.isEqual(t.field)}}const Me=new $e(At.bt(),Ne.ASCENDING),xe=new $e(At.bt(),Ne.DESCENDING);var Le,qe,Oe,Be;(qe=Le||(Le={}))[qe.js=0]="__PRIVATE_Listen",qe[qe.Ks=1]="__PRIVATE_ExistenceFilterMismatch",qe[qe.Gs=2]="__PRIVATE_LimboResolution";class Ue{constructor(t,e,s,n,i=Tt.MIN,r=Tt.MIN,o=Ds()){this.target=t,this.targetId=e,this.zs=s,this.sequenceNumber=n,this.Hs=i,this.lastLimboFreeSnapshotVersion=r,this.resumeToken=o}Js(t){return new Ue(this.target,this.targetId,this.zs,t,this.Hs,this.lastLimboFreeSnapshotVersion,this.resumeToken)}Ys(t,e){return new Ue(this.target,this.targetId,this.zs,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}Xs(t){return new Ue(this.target,this.targetId,this.zs,this.sequenceNumber,this.Hs,t,this.resumeToken)}isEqual(t){return this.targetId===t.targetId&&this.zs===t.zs&&this.sequenceNumber===t.sequenceNumber&&this.Hs.isEqual(t.Hs)&&this.lastLimboFreeSnapshotVersion.isEqual(t.lastLimboFreeSnapshotVersion)&&this.resumeToken===t.resumeToken&&this.target.isEqual(t.target)}}class Qe{constructor(t){this.count=t}isEqual(t){return t&&t.count===this.count}}function We(t){switch(t){case x.g:return V("Treated status OK as error");case x.v:case x.S:case x.C:case x.F:case x.INTERNAL:case x.O:case x.P:return!1;case x.D:case x.k:case x.N:case x.PERMISSION_DENIED:case x.$:case x.M:case x.L:case x.q:case x.B:return!0;default:return V("Unknown status code: "+t)}}function je(t){if(void 0===t)return A("GRPC error has no .code"),x.S;switch(t){case Oe.g:return x.g;case Oe.v:return x.v;case Oe.S:return x.S;case Oe.C:return x.C;case Oe.F:return x.F;case Oe.INTERNAL:return x.INTERNAL;case Oe.O:return x.O;case Oe.P:return x.P;case Oe.D:return x.D;case Oe.k:return x.k;case Oe.N:return x.N;case Oe.PERMISSION_DENIED:return x.PERMISSION_DENIED;case Oe.$:return x.$;case Oe.M:return x.M;case Oe.L:return x.L;case Oe.q:return x.q;case Oe.B:return x.B;default:return V("Unknown status code: "+t)}}function Ke(t){if(void 0===t)return Oe.g;switch(t){case x.g:return Oe.g;case x.v:return Oe.v;case x.S:return Oe.S;case x.C:return Oe.C;case x.F:return Oe.F;case x.INTERNAL:return Oe.INTERNAL;case x.O:return Oe.O;case x.P:return Oe.P;case x.D:return Oe.D;case x.k:return Oe.k;case x.N:return Oe.N;case x.PERMISSION_DENIED:return Oe.PERMISSION_DENIED;case x.$:return Oe.$;case x.M:return Oe.M;case x.L:return Oe.L;case x.q:return Oe.q;case x.B:return Oe.B;default:return V("Unknown status code: "+t)}}(Be=Oe||(Oe={}))[Be.g=0]="__PRIVATE_OK",Be[Be.v=1]="__PRIVATE_CANCELLED",Be[Be.S=2]="__PRIVATE_UNKNOWN",Be[Be.D=3]="__PRIVATE_INVALID_ARGUMENT",Be[Be.C=4]="__PRIVATE_DEADLINE_EXCEEDED",Be[Be.k=5]="__PRIVATE_NOT_FOUND",Be[Be.N=6]="__PRIVATE_ALREADY_EXISTS",Be[Be.PERMISSION_DENIED=7]="PERMISSION_DENIED",Be[Be.P=16]="__PRIVATE_UNAUTHENTICATED",Be[Be.F=8]="__PRIVATE_RESOURCE_EXHAUSTED",Be[Be.$=9]="__PRIVATE_FAILED_PRECONDITION",Be[Be.M=10]="__PRIVATE_ABORTED",Be[Be.L=11]="__PRIVATE_OUT_OF_RANGE",Be[Be.q=12]="__PRIVATE_UNIMPLEMENTED",Be[Be.INTERNAL=13]="INTERNAL",Be[Be.O=14]="__PRIVATE_UNAVAILABLE",Be[Be.B=15]="__PRIVATE_DATA_LOSS";const Ge=new Vt(Pt.lt);function ze(){return Ge}function He(){return ze()}const Je=new Vt(Pt.lt);function Ye(){return Je}const Xe=new Vt(Pt.lt);function Ze(){return Xe}const ts=new yt(Pt.lt);function es(...t){let e=ts;for(const s of t)e=e.add(s);return e}const ss=new yt(y);function ns(){return ss}class is{constructor(t){this.lt=t?(e,s)=>t(e,s)||Pt.lt(e.key,s.key):(t,e)=>Pt.lt(t.key,e.key),this.Zs=Ye(),this.tn=new Vt(this.lt)}static en(t){return new is(t.lt)}has(t){return null!=this.Zs.get(t)}get(t){return this.Zs.get(t)}first(){return this.tn.Mt()}last(){return this.tn.xt()}Tt(){return this.tn.Tt()}indexOf(t){const e=this.Zs.get(t);return e?this.tn.indexOf(e):-1}get size(){return this.tn.size}forEach(t){this.tn.Lt((e,s)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.Ft(e.Zs.Nt(t.key,t),e.tn.Nt(t,null))}delete(t){const e=this.get(t);return e?this.Ft(this.Zs.remove(t),this.tn.remove(e)):this}isEqual(t){if(!(t instanceof is))return!1;if(this.size!==t.size)return!1;const e=this.tn.Ot(),s=t.tn.Ot();for(;e.Gt();){const t=e.Kt().key,n=s.Kt().key;if(!t.isEqual(n))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}Ft(t,e){const s=new is;return s.lt=this.lt,s.Zs=t,s.tn=e,s}}var rs,os,hs,as,us,cs;(os=rs||(rs={}))[os.sn=0]="__PRIVATE_Added",os[os.nn=1]="__PRIVATE_Removed",os[os.in=2]="__PRIVATE_Modified",os[os.rn=3]="__PRIVATE_Metadata",(as=hs||(hs={}))[as.on=0]="__PRIVATE_Local",as[as.hn=1]="__PRIVATE_Synced";class ls{constructor(){this.an=new Vt(Pt.lt)}track(t){const e=t.doc.key,s=this.an.get(e);s?t.type!==rs.sn&&s.type===rs.rn?this.an=this.an.Nt(e,t):t.type===rs.rn&&s.type!==rs.nn?this.an=this.an.Nt(e,{type:s.type,doc:t.doc}):t.type===rs.in&&s.type===rs.in?this.an=this.an.Nt(e,{type:rs.in,doc:t.doc}):t.type===rs.in&&s.type===rs.sn?this.an=this.an.Nt(e,{type:rs.sn,doc:t.doc}):t.type===rs.nn&&s.type===rs.sn?this.an=this.an.remove(e):t.type===rs.nn&&s.type===rs.in?this.an=this.an.Nt(e,{type:rs.nn,doc:s.doc}):t.type===rs.sn&&s.type===rs.nn?this.an=this.an.Nt(e,{type:rs.in,doc:t.doc}):V("unsupported combination of changes: "+JSON.stringify(t)+" after "+JSON.stringify(s)):this.an=this.an.Nt(e,t)}un(){const t=[];return this.an.Lt((e,s)=>{t.push(s)}),t}}class _s{constructor(t,e,s,n,i,r,o,h){this.query=t,this.docs=e,this.cn=s,this.docChanges=n,this.ln=i,this.fromCache=r,this._n=o,this.dn=h}static fn(t,e,s,n){const i=[];return e.forEach(t=>{i.push({type:rs.sn,doc:t})}),new _s(t,e,is.en(e),i,s,n,!0,!1)}get hasPendingWrites(){return!this.ln.Tt()}isEqual(t){if(!(this.fromCache===t.fromCache&&this._n===t._n&&this.ln.isEqual(t.ln)&&this.query.isEqual(t.query)&&this.docs.isEqual(t.docs)&&this.cn.isEqual(t.cn)))return!1;const e=this.docChanges,s=t.docChanges;if(e.length!==s.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==s[t].type||!e[t].doc.isEqual(s[t].doc))return!1;return!0}}class ds{constructor(t,e,s,n,i){this.Hs=t,this.mn=e,this.Tn=s,this.En=n,this.wn=i}static In(t,e){const s={[t]:fs.Rn(t,e)};return new ds(Tt.MIN,s,ns(),ze(),es())}}class fs{constructor(t,e,s,n,i){this.resumeToken=t,this.An=e,this.Pn=s,this.Vn=n,this.pn=i}static Rn(t,e){return new fs(Ds(),e,es(),es(),es())}}class ms{constructor(t,e,s,n){this.gn=t,this.removedTargetIds=e,this.key=s,this.yn=n}}class Ts{constructor(t,e){this.targetId=t,this.bn=e}}(cs=us||(us={}))[cs.vn=0]="__PRIVATE_NoChange",cs[cs.sn=1]="__PRIVATE_Added",cs[cs.nn=2]="__PRIVATE_Removed",cs[cs.Sn=3]="__PRIVATE_Current",cs[cs.Dn=4]="__PRIVATE_Reset";class Es{constructor(t,e,s=Ds(),n=null){this.state=t,this.targetIds=e,this.resumeToken=s,this.cause=n}}class ws{constructor(){this.Cn=0,this.kn=Ps(),this.Nn=Ds(),this.Fn=!1,this.$n=!0}get An(){return this.Fn}get resumeToken(){return this.Nn}get Mn(){return 0!==this.Cn}get xn(){return this.$n}Ln(t){t.length>0&&(this.$n=!0,this.Nn=t)}qn(){let t=es(),e=es(),s=es();return this.kn.forEach((n,i)=>{switch(i){case rs.sn:t=t.add(n);break;case rs.in:e=e.add(n);break;case rs.nn:s=s.add(n);break;default:V("Encountered invalid change type: "+i)}}),new fs(this.Nn,this.Fn,t,e,s)}On(){this.$n=!1,this.kn=Ps()}Bn(t,e){this.$n=!0,this.kn=this.kn.Nt(t,e)}Un(t){this.$n=!0,this.kn=this.kn.remove(t)}Qn(){this.Cn+=1}Wn(){this.Cn-=1}jn(){this.$n=!0,this.Fn=!0}}const Is="WatchChangeAggregator";class Rs{constructor(t){this.Kn=t,this.Gn={},this.zn=ze(),this.Hn=As(),this.Jn=new yt(y)}Yn(t){for(const e of t.gn)t.yn instanceof _e?this.Xn(e,t.yn):t.yn instanceof de&&this.Zn(e,t.key,t.yn);for(const e of t.removedTargetIds)this.Zn(e,t.key,t.yn)}ti(t){this.ei(t,e=>{const s=this.si(e);switch(t.state){case us.vn:this.ni(e)&&s.Ln(t.resumeToken);break;case us.sn:s.Wn(),s.Mn||s.On(),s.Ln(t.resumeToken);break;case us.nn:s.Wn(),s.Mn||this.removeTarget(e),p(!t.cause,"WatchChangeAggregator does not handle errored targets");break;case us.Sn:this.ni(e)&&(s.jn(),s.Ln(t.resumeToken));break;case us.Dn:this.ni(e)&&(this.ii(e),s.Ln(t.resumeToken));break;default:V("Unknown target watch change state: "+t.state)}})}ei(t,e){t.targetIds.length>0?t.targetIds.forEach(e):K(this.Gn,e)}ri(t){const e=t.targetId,s=t.bn.count,n=this.oi(e);if(n){const t=n.target;if(t._s())if(0===s){const s=new Pt(t.path);this.Zn(e,s,new de(s,Tt.ht()))}else p(1===s,"Single document existence filter with count: "+s);else{this.hi(e)!==s&&(this.ii(e),this.Jn=this.Jn.add(e))}}}ai(t){const e={};K(this.Gn,(s,n)=>{const i=this.oi(s);if(i){if(n.An&&i.target._s()){const e=new Pt(i.target.path);null!==this.zn.get(e)||this.ui(s,e)||this.Zn(s,e,new de(e,t))}n.xn&&(e[s]=n.qn(),n.On())}});let s=es();this.Hn.forEach((t,e)=>{let n=!0;e.he(t=>{const e=this.oi(t);return!e||e.zs===Le.Gs||(n=!1,!1)}),n&&(s=s.add(t))});const n=new ds(t,e,this.Jn,this.zn,s);return this.zn=ze(),this.Hn=As(),this.Jn=new yt(y),n}Xn(t,e){if(!this.ni(t))return;const s=this.ui(t,e.key)?rs.in:rs.sn;this.si(t).Bn(e.key,s),this.zn=this.zn.Nt(e.key,e),this.Hn=this.Hn.Nt(e.key,this.ci(e.key).add(t))}Zn(t,e,s){if(!this.ni(t))return;const n=this.si(t);this.ui(t,e)?n.Bn(e,rs.nn):n.Un(e),this.Hn=this.Hn.Nt(e,this.ci(e).delete(t)),s&&(this.zn=this.zn.Nt(e,s))}removeTarget(t){delete this.Gn[t]}hi(t){const e=this.si(t).qn();return this.Kn.li(t).size+e.Pn.size-e.pn.size}Qn(t){this.si(t).Qn()}si(t){return this.Gn[t]||(this.Gn[t]=new ws),this.Gn[t]}ci(t){let e=this.Hn.get(t);return e||(e=new yt(y),this.Hn=this.Hn.Nt(t,e)),e}ni(t){const e=null!==this.oi(t);return e||R(Is,"Detected inactive target",t),e}oi(t){const e=this.Gn[t];return e&&e.Mn?null:this.Kn._i(t)}ii(t){p(!this.Gn[t].Mn,"Should only reset active targets"),this.Gn[t]=new ws,this.Kn.li(t).forEach(e=>{this.Zn(t,e,null)})}ui(t,e){return this.Kn.li(t).has(e)}}function As(){return new Vt(Pt.lt)}function Ps(){return new Vt(Pt.lt)}const Vs=(()=>{const t={};return t[Ne.ASCENDING.name]="ASCENDING",t[Ne.DESCENDING.name]="DESCENDING",t})(),ps=(()=>{const t={};return t[ye.LESS_THAN.name]="LESS_THAN",t[ye.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",t[ye.GREATER_THAN.name]="GREATER_THAN",t[ye.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",t[ye.EQUAL.name]="EQUAL",t[ye.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",t[ye.IN.name]="IN",t[ye.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",t})(),gs=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ys(t,e){p(!Ie(t),e+" is missing")}function bs(t){return"number"==typeof t?t:"string"==typeof t?Number(t):V("can't parse "+t)}class vs{constructor(t,e){this.o=t,this.options=e}di(){return this.options.fi?"":new Uint8Array(0)}mi(t){return t}Ti(t){const e=void 0===t.code?x.S:je(t.code);return new L(e,t.message||"")}Ei(t){return this.options.fi||Ie(t)?t:{value:t}}wi(t){let e;return Ie(e="object"==typeof t?t.value:t)?null:e}ut(t){if(this.options.fi){return`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`}return{seconds:""+t.seconds,nanos:t.nanoseconds}}ot(t){if("string"==typeof t)return this.Ii(t);{p(!!t,"Cannot deserialize null or undefined timestamp.");const e=bs(t.seconds||"0"),s=t.nanos||0;return new mt(e,s)}}Ii(t){let e=0;const s=gs.exec(t);if(p(!!s,"invalid timestamp: "+t),s[1]){let t=s[1];t=(t+"000000000").substr(0,9),e=Number(t)}const n=new Date(t),i=Math.floor(n.getTime()/1e3);return new mt(i,e)}Ri(t){return this.options.fi?t.toBase64():this.mi(t.toUint8Array())}Ai(t){return"string"==typeof t?(p(this.options.fi,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Fs.fromBase64String(t)):(p(!this.options.fi,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Fs.fromUint8Array(t))}toVersion(t){return this.ut(t.ut())}fromVersion(t){return p(!!t,"Trying to deserialize version that isn't set"),Tt.ot(this.ot(t))}Pi(t,e){return this.Vi(t).child("documents").child(e).Pt()}pi(t){const e=It.Vt(t);return p(this.gi(e),"Tried to deserialize invalid key "+e.toString()),e}yi(t){return this.Pi(this.o,t.path)}bi(t){const e=this.pi(t);return p(e.get(1)===this.o.projectId,"Tried to deserialize key from different project: "+e.get(1)+" vs "+this.o.projectId),p(!e.get(3)&&!this.o.database||e.get(3)===this.o.database,"Tried to deserialize key from different database: "+e.get(3)+" vs "+this.o.database),new Pt(this.vi(e))}Si(t){return this.Pi(this.o,t)}Di(t){const e=this.pi(t);return 4===e.length?It.pt:this.vi(e)}get Ci(){return new It(["projects",this.o.projectId,"databases",this.o.database]).Pt()}Vi(t){return new It(["projects",t.projectId,"databases",t.database])}vi(t){return p(t.length>4&&"documents"===t.get(4),"tried to deserialize invalid key "+t.toString()),t.dt(5)}gi(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}ki(t){if(t instanceof Yt)return{nullValue:"NULL_VALUE"};if(t instanceof Xt)return{booleanValue:t.value()};if(t instanceof ee)return{integerValue:""+t.value()};if(t instanceof se){const e=t.value();if(this.options.fi){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:t.value()}}return t instanceof ne?{stringValue:t.value()}:t instanceof ue?{mapValue:this.Ni(t)}:t instanceof ce?{arrayValue:this.Fi(t)}:t instanceof ie?{timestampValue:this.ut(t.me)}:t instanceof ae?{geoPointValue:{latitude:t.value().latitude,longitude:t.value().longitude}}:t instanceof oe?{bytesValue:this.Ri(t.value())}:t instanceof he?{referenceValue:this.Pi(t.o,t.key.path)}:V("Unknown FieldValue "+JSON.stringify(t))}$i(t){if("nullValue"in t)return Yt.Ze;if("booleanValue"in t)return Xt.of(t.booleanValue);if("integerValue"in t)return new ee(bs(t.integerValue));if("doubleValue"in t){if(this.options.fi){if("NaN"===t.doubleValue)return se.ss;if("Infinity"===t.doubleValue)return se.POSITIVE_INFINITY;if("-Infinity"===t.doubleValue)return se.NEGATIVE_INFINITY}return new se(t.doubleValue)}if("stringValue"in t)return new ne(t.stringValue);if("mapValue"in t)return this.Mi(t.mapValue.fields||{});if("arrayValue"in t){ys(t.arrayValue,"arrayValue");const e=t.arrayValue.values||[];return new ce(e.map(t=>this.$i(t)))}if("timestampValue"in t)return ys(t.timestampValue,"timestampValue"),new ie(this.ot(t.timestampValue));if("geoPointValue"in t){ys(t.geoPointValue,"geoPointValue");const e=t.geoPointValue.latitude||0,s=t.geoPointValue.longitude||0;return new ae(new ft(e,s))}if("bytesValue"in t){ys(t.bytesValue,"bytesValue");const e=this.Ai(t.bytesValue);return new oe(e)}if("referenceValue"in t){ys(t.referenceValue,"referenceValue");const e=this.pi(t.referenceValue),s=new C(e.get(1),e.get(3)),n=new Pt(this.vi(e));return new he(s,n)}return V("Unknown Value proto "+JSON.stringify(t))}xi(t,e){return{name:this.yi(t),fields:this.Li(e)}}qi(t){return p(!t.ve,"Can't serialize documents with mutations."),{name:this.yi(t.key),fields:this.Li(t.data()),updateTime:this.ut(t.version.ut())}}Oi(t,e){const s=this.bi(t.name),n=this.fromVersion(t.updateTime);return new _e(s,n,{hasCommittedMutations:!!e},void 0,t,t=>this.$i(t))}Li(t){const e={};return t.forEach((t,s)=>{e[t]=this.ki(s)}),e}Mi(t){const e=t;let s=ue.EMPTY;return G(e,(t,e)=>{s=s.set(new At([t]),this.$i(e))}),s}Ni(t){return{fields:this.Li(t)}}Fi(t){const e=[];return t.forEach(t=>{e.push(this.ki(t))}),{values:e}}Bi(t){p(!!t.found,"Tried to deserialize a found document from a missing document."),ys(t.found.name,"doc.found.name"),ys(t.found.updateTime,"doc.found.updateTime");const e=this.bi(t.found.name),s=this.fromVersion(t.found.updateTime);return new _e(e,s,{},void 0,t.found,t=>this.$i(t))}Ui(t){p(!!t.missing,"Tried to deserialize a missing document from a found document."),p(!!t.readTime,"Tried to deserialize a missing document without a read time.");const e=this.bi(t.missing),s=this.fromVersion(t.readTime);return new de(e,s)}Qi(t){return"found"in t?this.Bi(t):"missing"in t?this.Ui(t):V("invalid batch get response: "+JSON.stringify(t))}Wi(t){switch(t){case us.sn:return"ADD";case us.Sn:return"CURRENT";case us.vn:return"NO_CHANGE";case us.nn:return"REMOVE";case us.Dn:return"RESET";default:return V("Unknown WatchTargetChangeState: "+t)}}ji(t){if(t instanceof Ts)return{filter:{count:t.bn.count,targetId:t.targetId}};if(t instanceof ms){if(t.yn instanceof _e){const e=t.yn;return{documentChange:{document:{name:this.yi(e.key),fields:this.Li(e.data()),updateTime:this.toVersion(e.version)},targetIds:t.gn,removedTargetIds:t.removedTargetIds}}}if(t.yn instanceof de){const e=t.yn;return{documentDelete:{document:this.yi(e.key),readTime:this.toVersion(e.version),removedTargetIds:t.removedTargetIds}}}if(null===t.yn)return{documentRemove:{document:this.yi(t.key),removedTargetIds:t.removedTargetIds}}}if(t instanceof Es){let e=void 0;return t.cause&&(e={code:Ke(t.cause.code),message:t.cause.message}),{targetChange:{targetChangeType:this.Wi(t.state),targetIds:t.targetIds,resumeToken:this.mi(t.resumeToken),cause:e}}}return V("Unrecognized watch change: "+JSON.stringify(t))}Ki(t){let e;if("targetChange"in t){ys(t.targetChange,"targetChange");const s=this.Gi(t.targetChange.targetChangeType||"NO_CHANGE"),n=t.targetChange.targetIds||[],i=t.targetChange.resumeToken||this.di(),r=t.targetChange.cause,o=r&&this.Ti(r);e=new Es(s,n,i,o||null)}else if("documentChange"in t){ys(t.documentChange,"documentChange");const s=t.documentChange;ys(s.document,"documentChange.name"),ys(s.document.name,"documentChange.document.name"),ys(s.document.updateTime,"documentChange.document.updateTime");const n=this.bi(s.document.name),i=this.fromVersion(s.document.updateTime),r=new _e(n,i,{},void 0,s.document,t=>this.$i(t)),o=s.targetIds||[],h=s.removedTargetIds||[];e=new ms(o,h,r.key,r)}else if("documentDelete"in t){ys(t.documentDelete,"documentDelete");const s=t.documentDelete;ys(s.document,"documentDelete.document");const n=this.bi(s.document),i=s.readTime?this.fromVersion(s.readTime):Tt.ht(),r=new de(n,i),o=s.removedTargetIds||[];e=new ms([],o,r.key,r)}else if("documentRemove"in t){ys(t.documentRemove,"documentRemove");const s=t.documentRemove;ys(s.document,"documentRemove");const n=this.bi(s.document),i=s.removedTargetIds||[];e=new ms([],i,n,null)}else{if(!("filter"in t))return V("Unknown change type "+JSON.stringify(t));{ys(t.filter,"filter");const s=t.filter;ys(s.targetId,"filter.targetId");const n=s.count||0,i=new Qe(n),r=s.targetId;e=new Ts(r,i)}}return e}Gi(t){return"NO_CHANGE"===t?us.vn:"ADD"===t?us.sn:"REMOVE"===t?us.nn:"CURRENT"===t?us.Sn:"RESET"===t?us.Dn:V("Got unexpected TargetChange.state: "+t)}zi(t){if(!("targetChange"in t))return Tt.MIN;const e=t.targetChange;return e.targetIds&&e.targetIds.length?Tt.MIN:e.readTime?this.fromVersion(e.readTime):Tt.MIN}Hi(t){let e;if(t instanceof Wt)e={update:this.xi(t.key,t.value)};else if(t instanceof Gt)e={delete:this.yi(t.key)};else if(t instanceof jt)e={update:this.xi(t.key,t.data),updateMask:this.Ji(t.De)};else if(t instanceof Kt)e={transform:{document:this.yi(t.key),fieldTransforms:t.fieldTransforms.map(t=>this.Yi(t))}};else{if(!(t instanceof zt))return V("Unknown mutation type "+t.type);e={verify:this.yi(t.key)}}return t.be.Ve||(e.currentDocument=this.Xi(t.be)),e}Zi(t){const e=t.currentDocument?this.tr(t.currentDocument):Ut.NONE;if(t.update){ys(t.update.name,"name");const s=this.bi(t.update.name),n=this.Mi(t.update.fields||{});if(t.updateMask){const i=this.er(t.updateMask);return new jt(s,n,i,e)}return new Wt(s,n,e)}if(t.delete){const s=this.bi(t.delete);return new Gt(s,e)}if(t.transform){const s=this.bi(t.transform.document),n=t.transform.fieldTransforms.map(t=>this.sr(t));return p(!0===e.exists,'Transforms only support precondition "exists == true"'),new Kt(s,n)}if(t.verify){const s=this.bi(t.verify);return new zt(s,e)}return V("unknown mutation proto: "+JSON.stringify(t))}Xi(t){return p(!t.Ve,"Can't serialize an empty precondition"),void 0!==t.updateTime?{updateTime:this.toVersion(t.updateTime)}:void 0!==t.exists?{exists:t.exists}:V("Unknown precondition")}tr(t){return void 0!==t.updateTime?Ut.updateTime(this.fromVersion(t.updateTime)):void 0!==t.exists?Ut.exists(t.exists):Ut.NONE}nr(t,e){let s=t.updateTime?this.fromVersion(t.updateTime):this.fromVersion(e);s.isEqual(Tt.MIN)&&(s=this.fromVersion(e));let n=null;return t.transformResults&&t.transformResults.length>0&&(n=t.transformResults.map(t=>this.$i(t))),new $t(s,n)}ir(t,e){return t&&t.length>0?(p(void 0!==e,"Received a write result without a commit time"),t.map(t=>this.nr(t,e))):[]}Yi(t){const e=t.transform;if(e instanceof vt)return{fieldPath:t.field.Pt(),setToServerValue:"REQUEST_TIME"};if(e instanceof St)return{fieldPath:t.field.Pt(),appendMissingElements:{values:e.elements.map(t=>this.ki(t))}};if(e instanceof Dt)return{fieldPath:t.field.Pt(),removeAllFromArray:{values:e.elements.map(t=>this.ki(t))}};if(e instanceof Ct)return{fieldPath:t.field.Pt(),increment:this.ki(e.fe)};throw V("Unknown transform: "+t.transform)}sr(t){let e=null;if("setToServerValue"in t)p("REQUEST_TIME"===t.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(t)),e=vt.instance;else if("appendMissingElements"in t){const s=t.appendMissingElements.values||[];e=new St(s.map(t=>this.$i(t)))}else if("removeAllFromArray"in t){const s=t.removeAllFromArray.values||[];e=new Dt(s.map(t=>this.$i(t)))}else if("increment"in t){const s=this.$i(t.increment);p(s instanceof Zt,"NUMERIC_ADD transform requires a NumberValue"),e=new Ct(s)}else V("Unknown transform proto: "+JSON.stringify(t));const s=At.vt(t.fieldPath);return new Ft(s,e)}rr(t){return{documents:[this.Si(t.path)]}}or(t){const e=t.documents.length;p(1===e,"DocumentsTarget contained other than 1 document: "+e);const s=t.documents[0];return pe.Rs(this.Di(s)).ks()}hr(t){const e={structuredQuery:{}},s=t.path;null!==t.collectionGroup?(p(s.length%2==0,"Collection Group queries should be within a document path or root."),e.parent=this.Si(s),e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(p(s.length%2!=0,"Document queries with filters are not supported."),e.parent=this.Si(s.ft()),e.structuredQuery.from=[{collectionId:s.wt()}]);const n=this.ar(t.filters);n&&(e.structuredQuery.where=n);const i=this.ur(t.orderBy);i&&(e.structuredQuery.orderBy=i);const r=this.Ei(t.limit);return null!==r&&(e.structuredQuery.limit=r),t.startAt&&(e.structuredQuery.startAt=this.cr(t.startAt)),t.endAt&&(e.structuredQuery.endAt=this.cr(t.endAt)),e}lr(t){let e=this.Di(t.parent);const s=t.structuredQuery,n=s.from?s.from.length:0;let i=null;if(n>0){p(1===n,"StructuredQuery.from with more than one collection is not supported.");const t=s.from[0];t.allDescendants?i=t.collectionId:e=e.child(t.collectionId)}let r=[];s.where&&(r=this._r(s.where));let o=[];s.orderBy&&(o=this.dr(s.orderBy));let h=null;s.limit&&(h=this.wi(s.limit));let a=null;s.startAt&&(a=this.mr(s.startAt));let u=null;return s.endAt&&(u=this.mr(s.endAt)),new pe(e,i,o,r,h,Pe.ds,a,u).ks()}Tr(t){const e=this.Er(t.zs);return null==e?null:{"goog-listen-tags":e}}Er(t){switch(t){case Le.js:return null;case Le.Ks:return"existence-filter-mismatch";case Le.Gs:return"limbo-document";default:return V("Unrecognized query purpose: "+t)}}ks(t){let e;const s=t.target;return(e=s._s()?{documents:this.rr(s)}:{query:this.hr(s)}).targetId=t.targetId,t.resumeToken.length>0&&(e.resumeToken=this.mi(t.resumeToken)),e}ar(t){if(0===t.length)return;const e=t.map(t=>t instanceof be?this.wr(t):V("Unrecognized filter: "+JSON.stringify(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}_r(t){return t?void 0!==t.unaryFilter?[this.Ir(t)]:void 0!==t.fieldFilter?[this.Rr(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(t=>this._r(t)).reduce((t,e)=>t.concat(e)):V("Unknown filter: "+JSON.stringify(t)):[]}ur(t){if(0!==t.length)return t.map(t=>this.Ar(t))}dr(t){return t.map(t=>this.Pr(t))}cr(t){return{before:t.before,values:t.position.map(t=>this.ki(t))}}mr(t){const e=!!t.before,s=t.values.map(t=>this.$i(t));return new Fe(s,e)}Vr(t){return Vs[t.name]}pr(t){switch(t){case"ASCENDING":return Ne.ASCENDING;case"DESCENDING":return Ne.DESCENDING;default:return}}gr(t){return ps[t.name]}yr(t){switch(t){case"EQUAL":return ye.EQUAL;case"GREATER_THAN":return ye.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return ye.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return ye.LESS_THAN;case"LESS_THAN_OR_EQUAL":return ye.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return ye.ARRAY_CONTAINS;case"IN":return ye.IN;case"ARRAY_CONTAINS_ANY":return ye.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return V("Unspecified operator");default:return V("Unknown operator")}}br(t){return{fieldPath:t.Pt()}}vr(t){return At.vt(t.fieldPath)}Ar(t){return{field:this.br(t.field),direction:this.Vr(t.dir)}}Pr(t){return new $e(this.vr(t.field),this.pr(t.direction))}Rr(t){return be.create(this.vr(t.fieldFilter.field),this.yr(t.fieldFilter.op),this.$i(t.fieldFilter.value))}wr(t){if(t.op===ye.EQUAL){if(t.value.isEqual(se.ss))return{unaryFilter:{field:this.br(t.field),op:"IS_NAN"}};if(t.value.isEqual(Yt.Ze))return{unaryFilter:{field:this.br(t.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.br(t.field),op:this.gr(t.op),value:this.ki(t.value)}}}Ir(t){switch(t.unaryFilter.op){case"IS_NAN":const e=this.vr(t.unaryFilter.field);return be.create(e,ye.EQUAL,se.ss);case"IS_NULL":const s=this.vr(t.unaryFilter.field);return be.create(s,ye.EQUAL,Yt.Ze);case"OPERATOR_UNSPECIFIED":return V("Unspecified filter");default:return V("Unknown filter")}}Ji(t){const e=[];return t.fields.forEach(t=>e.push(t.Pt())),{fieldPaths:e}}er(t){const e=(t.fieldPaths||[]).map(t=>At.vt(t));return Nt.Ee(e)}}class Ss{static Sr(t){Ss.platform&&V("Platform already defined"),Ss.platform=t}static t(){return Ss.platform||V("Platform not set"),Ss.platform}}function Ds(){return Ss.t().di}function Cs(t,e){function s(){let t="This constructor is private.";throw e&&(t+=" ",t+=e),new L(x.D,t)}s.prototype=t.prototype;for(const e in t)t.hasOwnProperty(e)&&(s[e]=t[e]);return s}function ks(){if("undefined"==typeof Uint8Array)throw new L(x.q,"Uint8Arrays are not available in this environment.")}function Ns(){if(!Ss.t().Dr)throw new L(x.q,"Blobs are unavailable in Firestore in this environment.")}class Fs{constructor(t){Ns(),this.Cr=t}static fromBase64String(t){J("Blob.fromBase64String",arguments,1),Z("Blob.fromBase64String","string",1,t),Ns();try{const e=Ss.t().atob(t);return new Fs(e)}catch(t){throw new L(x.D,"Failed to construct Blob from Base64 string: "+t)}}static fromUint8Array(t){if(J("Blob.fromUint8Array",arguments,1),ks(),!(t instanceof Uint8Array))throw ct("Blob.fromUint8Array","Uint8Array",1,t);const e=Array.prototype.map.call(t,t=>String.fromCharCode(t)).join("");return new Fs(e)}toBase64(){return J("Blob.toBase64",arguments,0),Ns(),Ss.t().btoa(this.Cr)}toUint8Array(){J("Blob.toUint8Array",arguments,0),ks();const t=new Uint8Array(this.Cr.length);for(let e=0;e<this.Cr.length;e++)t[e]=this.Cr.charCodeAt(e);return t}toString(){return"Blob(base64: "+this.toBase64()+")"}isEqual(t){return this.Cr===t.Cr}it(t){return y(this.Cr,t.Cr)}}const $s=Cs(Fs,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead.");class Ms{constructor(t){this.kr=t,this.Nr={}}get(t){const e=this.kr(t),s=this.Nr[e];if(void 0!==s)for(const[e,n]of s)if(e.isEqual(t))return n}has(t){return void 0!==this.get(t)}set(t,e){const s=this.kr(t),n=this.Nr[s];if(void 0!==n){for(let s=0;s<n.length;s++)if(n[s][0].isEqual(t))return void(n[s]=[t,e]);n.push([t,e])}else this.Nr[s]=[[t,e]]}delete(t){const e=this.kr(t),s=this.Nr[e];if(void 0===s)return!1;for(let n=0;n<s.length;n++)if(s[n][0].isEqual(t))return 1===s.length?delete this.Nr[e]:s.splice(n,1),!0;return!1}forEach(t){G(this.Nr,(e,s)=>{for(const[e,n]of s)t(e,n)})}Tt(){return z(this.Nr)}}const xs=-1;class Ls{constructor(t,e,s,n){this.batchId=t,this.ns=e,this.baseMutations=s,this.mutations=n,p(n.length>0,"Cannot create an empty mutation batch")}_e(t,e,s){e&&p(e.key.isEqual(t),`applyToRemoteDocument: key ${t} should match maybeDoc key\n        ${e.key}`);const n=s.Fr;p(n.length===this.mutations.length,`Mismatch between mutations length\n      (${this.mutations.length}) and mutation results length\n      (${n.length}).`);for(let s=0;s<this.mutations.length;s++){const i=this.mutations[s];if(i.key.isEqual(t)){const t=n[s];e=i._e(e,t)}}return e}le(t,e){e&&p(e.key.isEqual(t),`applyToLocalDocument: key ${t} should match maybeDoc key\n        ${e.key}`);for(const s of this.baseMutations)s.key.isEqual(t)&&(e=s.le(e,e,this.ns));const s=e;for(const n of this.mutations)n.key.isEqual(t)&&(e=n.le(e,s,this.ns));return e}$r(t){let e=t;return this.mutations.forEach(s=>{const n=this.le(s.key,t.get(s.key));n&&(e=e.Nt(s.key,n))}),e}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),es())}isEqual(t){return this.batchId===t.batchId&&b(this.mutations,t.mutations)&&b(this.baseMutations,t.baseMutations)}}class qs{constructor(t,e,s,n,i){this.batch=t,this.Mr=e,this.Fr=s,this.streamToken=n,this.xr=i}static from(t,e,s,n){p(t.mutations.length===s.length,"Mutations sent "+t.mutations.length+" must equal results received "+s.length);let i=Ze();const r=t.mutations;for(let t=0;t<r.length;t++)i=i.Nt(r[t].key,s[t].version);return new qs(t,e,s,n,i)}}class Os{constructor(){this.Lr=new yt(Bs.os),this.qr=new yt(Bs.Or)}Tt(){return this.Lr.Tt()}Br(t,e){const s=new Bs(t,e);this.Lr=this.Lr.add(s),this.qr=this.qr.add(s)}Ur(t,e){t.forEach(t=>this.Br(t,e))}Qr(t,e){this.Wr(new Bs(t,e))}jr(t,e){t.forEach(t=>this.Qr(t,e))}Kr(t){const e=Pt.EMPTY,s=new Bs(e,t),n=new Bs(e,t+1),i=[];return this.qr.oe([s,n],t=>{this.Wr(t),i.push(t.key)}),i}Gr(){this.Lr.forEach(t=>this.Wr(t))}Wr(t){this.Lr=this.Lr.delete(t),this.qr=this.qr.delete(t)}zr(t){const e=Pt.EMPTY,s=new Bs(e,t),n=new Bs(e,t+1);let i=es();return this.qr.oe([s,n],t=>{i=i.add(t.key)}),i}Hr(t){const e=new Bs(t,0),s=this.Lr.ae(e);return null!==s&&t.isEqual(s.key)}}class Bs{constructor(t,e){this.key=t,this.Jr=e}static os(t,e){return Pt.lt(t.key,e.key)||y(t.Jr,e.Jr)}static Or(t,e){return y(t.Jr,e.Jr)||Pt.lt(t.key,e.key)}}class Us{constructor(t){this.Yr=null,this.Xr=null,this.result=void 0,this.error=void 0,this.Zr=!1,this.to=!1,t(t=>{this.Zr=!0,this.result=t,this.Yr&&this.Yr(t)},t=>{this.Zr=!0,this.error=t,this.Xr&&this.Xr(t)})}catch(t){return this.next(void 0,t)}next(t,e){return this.to&&V("Called next() or catch() twice for PersistencePromise"),this.to=!0,this.Zr?this.error?this.eo(e,this.error):this.so(t,this.result):new Us((s,n)=>{this.Yr=e=>{this.so(t,e).next(s,n)},this.Xr=t=>{this.eo(e,t).next(s,n)}})}no(){return new Promise((t,e)=>{this.next(t,e)})}io(t){try{const e=t();return e instanceof Us?e:Us.resolve(e)}catch(t){return Us.reject(t)}}so(t,e){return t?this.io(()=>t(e)):Us.resolve(e)}eo(t,e){return t?this.io(()=>t(e)):Us.reject(e)}static resolve(t){return new Us((e,s)=>{e(t)})}static reject(t){return new Us((e,s)=>{s(t)})}static ro(t){return new Us((e,s)=>{let n=0,i=0,r=!1;t.forEach(t=>{++n,t.next(()=>{++i,r&&i===n&&e()},t=>s(t))}),r=!0,i===n&&e()})}static oo(t){let e=Us.resolve(!1);for(const s of t)e=e.next(t=>t?Us.resolve(t):s());return e}static forEach(t,e){const s=[];return t.forEach((t,n)=>{s.push(e.call(this,t,n))}),this.ro(s)}}class Qs{constructor(){this.ho=new Ms(t=>t.toString()),this.ao=!1}set readTime(t){p(void 0===this.uo||this.uo.isEqual(t),"All changes in a RemoteDocumentChangeBuffer must have the same read time"),this.uo=t}get readTime(){return p(void 0!==this.uo,"Read time is not set. All removeEntry() calls must include a readTime if `trackRemovals` is used."),this.uo}co(t,e){this.lo(),this.readTime=e,this.ho.set(t.key,t)}_o(t,e){this.lo(),e&&(this.readTime=e),this.ho.set(t,null)}do(t,e){this.lo();const s=this.ho.get(e);return void 0!==s?Us.resolve(s):this.fo(t,e)}getEntries(t,e){return this.mo(t,e)}apply(t){return this.lo(),this.ao=!0,this.To(t)}lo(){p(!this.ao,"Changes have already been applied.")}}class Ws{constructor(){this.Eo=[]}wo(t){this.Eo.push(t)}Io(){this.Eo.forEach(t=>t())}}class js{constructor(t,e,s){this.Ro=t,this.Ao=e,this.Po=s}Vo(t,e){return this.Ao.po(t,e).next(s=>this.yo(t,e,s))}yo(t,e,s){return this.Ro.do(t,e).next(t=>{for(const n of s)t=n.le(e,t);return t})}bo(t,e,s){let n=He();return e.forEach((t,e)=>{for(const n of s)e=n.le(t,e);n=n.Nt(t,e)}),n}vo(t,e){return this.Ro.getEntries(t,e).next(e=>this.So(t,e))}So(t,e){return this.Ao.Do(t,e).next(s=>{const n=this.bo(t,e,s);let i=ze();return n.forEach((t,e)=>{e||(e=new de(t,Tt.ht())),i=i.Nt(t,e)}),i})}Co(t,e,s){return e._s()?this.ko(t,e.path):e.Bs()?this.No(t,e,s):this.Fo(t,e,s)}ko(t,e){return this.Vo(t,new Pt(e)).next(t=>{let e=Ye();return t instanceof _e&&(e=e.Nt(t.key,t)),e})}No(t,e,s){p(e.path.Tt(),"Currently we only support collection group queries at the root.");const n=e.collectionGroup;let i=Ye();return this.Po.$o(t,n).next(r=>Us.forEach(r,r=>{const o=e.Ds(r.child(n));return this.Fo(t,o,s).next(t=>{t.forEach((t,e)=>{i=i.Nt(t,e)})})}).next(()=>i))}Fo(t,e,s){let n,i;return this.Ro.Co(t,e,s).next(s=>(n=s,this.Ao.Mo(t,e))).next(e=>(i=e,this.xo(t,i,n).next(t=>{n=t;for(const t of i)for(const e of t.mutations){const s=e.key,i=n.get(s),r=e.le(i,i,t.ns);n=r instanceof _e?n.Nt(s,r):n.remove(s)}}))).next(()=>(n.forEach((t,s)=>{e.matches(s)||(n=n.remove(t))}),n))}xo(t,e,s){let n=es();for(const t of e)for(const e of t.mutations)e instanceof jt&&null===s.get(e.key)&&(n=n.add(e.key));let i=s;return this.Ro.getEntries(t,n).next(t=>(t.forEach((t,e)=>{null!==e&&e instanceof _e&&(i=i.Nt(t,e))}),i))}}class Ks{constructor(t,e,s,n){this.targetId=t,this.fromCache=e,this.Lo=s,this.qo=n}static Oo(t,e){let s=es(),n=es();for(const t of e.docChanges)switch(t.type){case rs.sn:s=s.add(t.doc.key);break;case rs.nn:n=n.add(t.doc.key)}return new Ks(t,e.fromCache,s,n)}}class Gs{constructor(t,e){this.previousValue=t,e&&(e.Bo=t=>this.Uo(t),this.Qo=t=>e.Wo(t))}Uo(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.Qo&&this.Qo(t),t}}Gs.jo=-1;class zs{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}var Hs,Js;(Js=Hs||(Hs={})).Ko="all",Js.Go="listen_stream_idle",Js.zo="listen_stream_connection_backoff",Js.Ho="write_stream_idle",Js.Jo="write_stream_connection_backoff",Js.Yo="online_state_timeout",Js.Xo="client_metadata_refresh",Js.Zo="lru_garbage_collection",Js.th="retry_transaction";class Ys{constructor(t,e,s,n,i){this.eh=t,this.sh=e,this.nh=s,this.op=n,this.ih=i,this.rh=new zs,this.then=this.rh.promise.then.bind(this.rh.promise),this.catch=this.rh.promise.catch.bind(this.rh.promise),this.rh.promise.catch(t=>{})}static oh(t,e,s,n,i){const r=Date.now()+s,o=new Ys(t,e,r,n,i);return o.start(s),o}start(t){this.hh=setTimeout(()=>this.ah(),t)}uh(){return this.ah()}cancel(t){null!==this.hh&&(this.clearTimeout(),this.rh.reject(new L(x.v,"Operation cancelled"+(t?": "+t:""))))}ah(){this.eh.lh(()=>null!==this.hh?(this.clearTimeout(),this.op().then(t=>this.rh.resolve(t))):Promise.resolve())}clearTimeout(){null!==this.hh&&(this.ih(this),clearTimeout(this.hh),this.hh=null)}}class Xs{constructor(){this._h=Promise.resolve(),this.dh=!1,this.fh=[],this.mh=null,this.Th=!1,this.Eh=[]}get wh(){return this.dh}lh(t){this.enqueue(t)}Ih(t){this.Rh(),this.Ah(t)}Ph(t){return this.Rh(),this.Ah(t)}async Vh(t){this.Rh(),this.dh||(this.dh=!0,await this.Ph(t))}enqueue(t){return this.Rh(),this.dh?new Promise(t=>{}):this.Ah(t)}Ah(t){const e=this._h.then(()=>(this.Th=!0,t().catch(t=>{this.mh=t,this.Th=!1;const e=t.stack||t.message||"";throw A("INTERNAL UNHANDLED ERROR: ",e),e.indexOf("Firestore Test Simulated Error")<0&&setTimeout(()=>{throw t},0),t}).then(t=>(this.Th=!1,t))));return this._h=e,e}ph(t,e,s){this.Rh(),p(e>=0,`Attempted to schedule an operation with a negative delay of ${e}`),this.Eh.indexOf(t)>-1&&(e=0);const n=Ys.oh(this,t,e,s,t=>this.gh(t));return this.fh.push(n),n}Rh(){this.mh&&V("AsyncQueue is already failed: "+(this.mh.stack||this.mh.message))}yh(){p(this.Th,"verifyOpInProgress() called when no op in progress on this queue.")}bh(){return this.Ph(()=>Promise.resolve())}vh(t){for(const e of this.fh)if(e.sh===t)return!0;return!1}Sh(t){return this.bh().then(()=>{p(t===Hs.Ko||this.vh(t),`Attempted to drain to missing operation ${t}`),this.fh.sort((t,e)=>t.nh-e.nh);for(const e of this.fh)if(e.uh(),t!==Hs.Ko&&e.sh===t)break;return this.bh()})}Dh(t){this.Eh.push(t)}gh(t){const e=this.fh.indexOf(t);p(e>=0,"Delayed operation not found."),this.fh.splice(e,1)}}const Zs="",tn="",en="",sn="";function nn(t){let e="";for(let s=0;s<t.length;s++)e.length>0&&(e=on(e)),e=rn(t.get(s),e);return on(e)}function rn(t,e){let s=e;const n=t.length;for(let e=0;e<n;e++){const n=t.charAt(e);switch(n){case"\0":s+=Zs+en;break;case Zs:s+=Zs+sn;break;default:s+=n}}return s}function on(t){return t+Zs+tn}function hn(t){const e=t.length;if(p(e>=2,"Invalid path "+t),2===e)return p(t.charAt(0)===Zs&&t.charAt(1)===tn,"Non-empty path "+t+" had length 2"),It.pt;const s=e-2,n=[];let i="";for(let r=0;r<e;){const e=t.indexOf(Zs,r);switch((e<0||e>s)&&V('Invalid encoded resource path: "'+t+'"'),t.charAt(e+1)){case tn:const s=t.substring(r,e);let o;0===i.length?o=s:(o=i+=s,i=""),n.push(o);break;case en:i+=t.substring(r,e),i+="\0";break;case sn:i+=t.substring(r,e+1);break;default:V('Invalid encoded resource path: "'+t+'"')}r=e+2}return new It(n)}const an="SimpleDb",un=3;class cn{constructor(t){this.db=t,12.2===cn.Ch(n())&&A("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static kh(t,e,s){return p(cn.Nh(),"IndexedDB not supported in current environment."),R(an,"Opening database:",t),new Us((n,i)=>{const r=window.indexedDB.open(t,e);r.onsuccess=t=>{const e=t.target.result;n(new cn(e))},r.onblocked=()=>{i(new L(x.$,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const e=t.target.error;"VersionError"===e.name?i(new L(x.$,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):i(e)},r.onupgradeneeded=e=>{R(an,'Database "'+t+'" requires upgrade from version:',e.oldVersion);const n=e.target.result;s.createOrUpgrade(n,r.transaction,e.oldVersion,On).next(()=>{R(an,"Database upgrade to version "+On+" complete")})}}).no()}static delete(t){return R(an,"Removing database:",t),fn(window.indexedDB.deleteDatabase(t)).no()}static Nh(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(cn.Fh())return!0;if(void 0===window.navigator)return!1;const t=n(),e=cn.Ch(t),s=0<e&&e<10,i=cn.$h(t),r=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||s||r)}static Fh(){var t;return"undefined"!=typeof __PRIVATE_process&&"YES"===(null===(t=__PRIVATE_process.__PRIVATE_env)||void 0===t?void 0:t.Mh)}static xh(t,e){return t.store(e)}static Ch(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),s=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(s)}static $h(t){const e=t.match(/Android ([\d.]+)/i),s=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(s)}Lh(t){this.db.onversionchange=e=>t(e)}async runTransaction(t,e,s){const n=t.startsWith("readonly"),i=t.endsWith("idempotent");let r=0;for(;;){++r;const t=_n.open(this.db,n?"readonly":"readwrite",e);try{const e=s(t).catch(e=>(t.abort(e),Us.reject(e))).no();return e.catch(()=>{}),await t.qh,e}catch(t){const e=i&&"FirebaseError"!==t.name&&r<un;if(R(an,"Transaction failed with error: %s. Retrying: %s.",t.message,e),!e)return Promise.reject(t)}}}close(){this.db.close()}}class ln{constructor(t){this.Oh=t,this.Bh=!1,this.Uh=null}get Zr(){return this.Bh}get Qh(){return this.Uh}set cursor(t){this.Oh=t}done(){this.Bh=!0}Wh(t){this.Uh=t}delete(){return fn(this.Oh.delete())}}class _n{constructor(t){this.transaction=t,this.aborted=!1,this.jh=new zs,this.transaction.oncomplete=()=>{this.jh.resolve()},this.transaction.onabort=()=>{t.error?this.jh.reject(t.error):this.jh.resolve()},this.transaction.onerror=t=>{const e=Tn(t.target.error);this.jh.reject(e)}}static open(t,e,s){return new _n(t.transaction(s,e))}get qh(){return this.jh.promise}abort(t){t&&this.jh.reject(t),this.aborted||(R(an,"Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){const e=this.transaction.objectStore(t);return p(!!e,"Object store not part of transaction: "+t),new dn(e)}}class dn{constructor(t){this.store=t}put(t,e){let s;return void 0!==e?(R(an,"PUT",this.store.name,t,e),s=this.store.put(e,t)):(R(an,"PUT",this.store.name,"<auto-key>",t),s=this.store.put(t)),fn(s)}add(t){return R(an,"ADD",this.store.name,t,t),fn(this.store.add(t))}get(t){return fn(this.store.get(t)).next(e=>(void 0===e&&(e=null),R(an,"GET",this.store.name,t,e),e))}delete(t){return R(an,"DELETE",this.store.name,t),fn(this.store.delete(t))}count(){return R(an,"COUNT",this.store.name),fn(this.store.count())}Kh(t,e){const s=this.cursor(this.options(t,e)),n=[];return this.Gh(s,(t,e)=>{n.push(e)}).next(()=>n)}zh(t,e){R(an,"DELETE ALL",this.store.name);const s=this.options(t,e);s.Hh=!1;const n=this.cursor(s);return this.Gh(n,(t,e,s)=>s.delete())}Jh(t,e){let s;e?s=t:(s={},e=t);const n=this.cursor(s);return this.Gh(n,e)}Yh(t){const e=this.cursor({});return new Us((s,n)=>{e.onerror=t=>{const e=Tn(t.target.error);n(e)},e.onsuccess=e=>{const n=e.target.result;n?t(n.primaryKey,n.value).next(t=>{t?n.continue():s()}):s()}})}Gh(t,e){const s=[];return new Us((n,i)=>{t.onerror=t=>{i(t.target.error)},t.onsuccess=t=>{const i=t.target.result;if(!i)return void n();const r=new ln(i),o=e(i.primaryKey,i.value,r);if(o instanceof Us){const t=o.catch(t=>(r.done(),Us.reject(t)));s.push(t)}r.Zr?n():null===r.Qh?i.continue():i.continue(r.Qh)}}).next(()=>Us.ro(s))}options(t,e){let s=void 0;return void 0!==t&&("string"==typeof t?s=t:(p(void 0===e,"3rd argument must not be defined if 2nd is a range."),e=t)),{index:s,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const s=this.store.index(t.index);return t.Hh?s.openKeyCursor(t.range,e):s.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function fn(t){return new Us((e,s)=>{t.onsuccess=t=>{const s=t.target.result;e(s)},t.onerror=t=>{const e=Tn(t.target.error);s(e)}})}let mn=!1;function Tn(t){const e=cn.Ch(n());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new L("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely `+"due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.");return mn||(mn=!0,setTimeout(()=>{throw t},0)),t}}return t}class En{constructor(t,e,s,n){this.userId=t,this.serializer=e,this.Po=s,this.Xh=n,this.Zh={}}static ta(t,e,s,n){p(""!==t.uid,"UserID must not be an empty string.");const i=t.R()?t.uid:"";return new En(i,e,s,n)}ea(t){let e=!0;const s=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return An(t).Jh({index:jn.userMutationsIndex,range:s},(t,s,n)=>{e=!1,n.done()}).next(()=>e)}sa(t,e,s){return this.na(t).next(e=>(e.lastStreamToken=Rn(s),Vn(t).put(e)))}ia(t){return this.na(t).next(t=>t.lastStreamToken)}ra(t,e){return this.na(t).next(s=>(s.lastStreamToken=Rn(e),Vn(t).put(s)))}oa(t,e,s,n){const i=Pn(t),r=An(t);return r.add({}).next(o=>{p("number"==typeof o,"Auto-generated key is not a number");const h=new Ls(o,e,s,n),a=this.serializer.ha(this.userId,h),u=[];let c=new yt((t,e)=>y(t.Pt(),e.Pt()));for(const t of n){const e=Kn.key(this.userId,t.key.path,o);c=c.add(t.key.path.ft()),u.push(r.put(a)),u.push(i.put(e,Kn.PLACEHOLDER))}return c.forEach(e=>{u.push(this.Po.aa(t,e))}),t.wo(()=>{this.Zh[o]=h.keys()}),Us.ro(u).next(()=>h)})}ua(t,e){return An(t).get(e).next(t=>t?(p(t.userId===this.userId,`Unexpected user '${t.userId}' for mutation batch ${e}`),this.serializer.ca(t)):null)}la(t,e){return this.Zh[e]?Us.resolve(this.Zh[e]):this.ua(t,e).next(t=>{if(t){const s=t.keys();return this.Zh[e]=s,s}return null})}_a(t,e){const s=e+1,n=IDBKeyRange.lowerBound([this.userId,s]);let i=null;return An(t).Jh({index:jn.userMutationsIndex,range:n},(t,e,n)=>{e.userId===this.userId&&(p(e.batchId>=s,"Should have found mutation after "+s),i=this.serializer.ca(e)),n.done()}).next(()=>i)}da(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let s=xs;return An(t).Jh({index:jn.userMutationsIndex,range:e,reverse:!0},(t,e,n)=>{s=e.batchId,n.done()}).next(()=>s)}fa(t){const e=IDBKeyRange.bound([this.userId,xs],[this.userId,Number.POSITIVE_INFINITY]);return An(t).Kh(jn.userMutationsIndex,e).next(t=>t.map(t=>this.serializer.ca(t)))}po(t,e){const s=Kn.prefixForPath(this.userId,e.path),n=IDBKeyRange.lowerBound(s),i=[];return Pn(t).Jh({range:n},(s,n,r)=>{const[o,h,a]=s,u=hn(h);if(o===this.userId&&e.path.isEqual(u))return An(t).get(a).next(t=>{if(!t)throw V("Dangling document-mutation reference found: "+s+" which points to "+a);p(t.userId===this.userId,`Unexpected user '${t.userId}' for mutation batch ${a}`),i.push(this.serializer.ca(t))});r.done()}).next(()=>i)}Do(t,e){let s=new yt(y);const n=[];return e.forEach(e=>{const i=Kn.prefixForPath(this.userId,e.path),r=IDBKeyRange.lowerBound(i),o=Pn(t).Jh({range:r},(t,n,i)=>{const[r,o,h]=t,a=hn(o);r===this.userId&&e.path.isEqual(a)?s=s.add(h):i.done()});n.push(o)}),Us.ro(n).next(()=>this.ma(t,s))}Mo(t,e){p(!e._s(),"Document queries shouldn't go down this path"),p(!e.Bs(),"CollectionGroup queries should be handled in LocalDocumentsView");const s=e.path,n=s.length+1,i=Kn.prefixForPath(this.userId,s),r=IDBKeyRange.lowerBound(i);let o=new yt(y);return Pn(t).Jh({range:r},(t,e,i)=>{const[r,h,a]=t,u=hn(h);r===this.userId&&s.It(u)?u.length===n&&(o=o.add(a)):i.done()}).next(()=>this.ma(t,o))}ma(t,e){const s=[],n=[];return e.forEach(e=>{n.push(An(t).get(e).next(t=>{if(null===t)throw V("Dangling document-mutation reference found, which points to "+e);p(t.userId===this.userId,`Unexpected user '${t.userId}' for mutation batch ${e}`),s.push(this.serializer.ca(t))}))}),Us.ro(n).next(()=>s)}Ta(t,e){return In(t.Ea,this.userId,e).next(s=>(t.wo(()=>{this.wa(e.batchId)}),Us.forEach(s,e=>this.Xh.Ia(t,e))))}wa(t){delete this.Zh[t]}Ra(t){return this.ea(t).next(e=>{if(!e)return Us.resolve();const s=IDBKeyRange.lowerBound(Kn.prefixForUser(this.userId)),n=[];return Pn(t).Jh({range:s},(t,e,s)=>{if(t[0]===this.userId){const e=hn(t[1]);n.push(e)}else s.done()}).next(()=>{p(0===n.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+n.map(t=>t.Pt()))})})}Hr(t,e){return wn(t,this.userId,e)}na(t){return Vn(t).get(this.userId).next(t=>t||new Wn(this.userId,xs,""))}}function wn(t,e,s){const n=Kn.prefixForPath(e,s.path),i=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Pn(t).Jh({range:r,Hh:!0},(t,s,n)=>{const[r,h,a]=t;r===e&&h===i&&(o=!0),n.done()}).next(()=>o)}function In(t,e,s){const n=t.store(jn.store),i=t.store(Kn.store),r=[],o=IDBKeyRange.only(s.batchId);let h=0;const a=n.Jh({range:o},(t,e,s)=>(h++,s.delete()));r.push(a.next(()=>{p(1===h,"Dangling document-mutation reference found: Missing batch "+s.batchId)}));const u=[];for(const t of s.mutations){const n=Kn.key(e,t.key.path,s.batchId);r.push(i.delete(n)),u.push(t.key)}return Us.ro(r).next(()=>u)}function Rn(t){return t instanceof Uint8Array?(p(cn.Fh(),"Persisting non-string stream tokens is only supported with mock persistence."),t.toString()):t}function An(t){return Ti.xh(t,jn.store)}function Pn(t){return Ti.xh(t,Kn.store)}function Vn(t){return Ti.xh(t,Wn.store)}const pn=1;var gn,yn;(yn=gn||(gn={}))[yn.Aa=0]="__PRIVATE_QueryCache",yn[yn.Pa=1]="__PRIVATE_SyncEngine";class bn{constructor(t,e){this.Va=t,p((t&pn)===t,`Generator ID ${t} contains more than ${pn} reserved bits`),this.pa(void 0!==e?e:this.Va)}next(){const t=this.ga;return this.ga+=1<<pn,t}after(t){return this.pa(t+(1<<pn)),this.next()}pa(t){p((t&pn)===this.Va,"Cannot supply target ID from different generator ID"),this.ga=t}static ya(){return new bn(gn.Aa,2)}static ba(){return new bn(gn.Pa)}}class vn{constructor(t,e){this.Xh=t,this.serializer=e,this.va=bn.ya()}Sa(t){return this.Da(t).next(e=>(e.highestTargetId=this.va.after(e.highestTargetId),this.Ca(t,e).next(()=>e.highestTargetId)))}ka(t){return this.Da(t).next(t=>Tt.ot(new mt(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}Na(t){return Cn(t.Ea)}Fa(t,e,s){return this.Da(t).next(n=>(n.highestListenSequenceNumber=e,s&&(n.lastRemoteSnapshotVersion=s.ut()),e>n.highestListenSequenceNumber&&(n.highestListenSequenceNumber=e),this.Ca(t,n)))}$a(t,e){return this.Ma(t,e).next(()=>this.Da(t).next(s=>(s.targetCount+=1,this.xa(e,s),this.Ca(t,s))))}La(t,e){return this.Ma(t,e)}qa(t,e){return this.Oa(t,e.targetId).next(()=>Sn(t).delete(e.targetId)).next(()=>this.Da(t)).next(e=>(p(e.targetCount>0,"Removing from an empty target cache"),e.targetCount-=1,this.Ca(t,e)))}Ba(t,e,s){let n=0;const i=[];return Sn(t).Jh((r,o)=>{const h=this.serializer.Ua(o);h.sequenceNumber<=e&&null===s.get(h.targetId)&&(n++,i.push(this.qa(t,h)))}).next(()=>Us.ro(i)).next(()=>n)}ei(t,e){return Sn(t).Jh((t,s)=>{const n=this.serializer.Ua(s);e(n)})}Da(t){return Dn(t.Ea)}Ca(t,e){return(s=t,Ti.xh(s,Zn.store)).put(Zn.key,e);var s}Ma(t,e){return Sn(t).put(this.serializer.Qa(e))}xa(t,e){let s=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,s=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,s=!0),s}Wa(t){return this.Da(t).next(t=>t.targetCount)}ja(t,e){const s=e.canonicalId(),n=IDBKeyRange.bound([s,Number.NEGATIVE_INFINITY],[s,Number.POSITIVE_INFINITY]);let i=null;return Sn(t).Jh({range:n,index:Yn.queryTargetsIndexName},(t,s,n)=>{const r=this.serializer.Ua(s);e.isEqual(r.target)&&(i=r,n.done())}).next(()=>i)}Ka(t,e,s){const n=[],i=kn(t);return e.forEach(e=>{const r=nn(e.path);n.push(i.put(new Xn(s,r))),n.push(this.Xh.Br(t,e))}),Us.ro(n)}Ga(t,e,s){const n=kn(t);return Us.forEach(e,e=>{const i=nn(e.path);return Us.ro([n.delete([s,i]),this.Xh.Qr(t,e)])})}Oa(t,e){const s=kn(t),n=IDBKeyRange.bound([e],[e+1],!1,!0);return s.delete(n)}za(t,e){const s=IDBKeyRange.bound([e],[e+1],!1,!0),n=kn(t);let i=es();return n.Jh({range:s,Hh:!0},(t,e,s)=>{const n=hn(t[1]),r=new Pt(n);i=i.add(r)}).next(()=>i)}Hr(t,e){const s=nn(e.path),n=IDBKeyRange.bound([s],[v(s)],!1,!0);let i=0;return kn(t).Jh({index:Xn.documentTargetsIndex,Hh:!0,range:n},([t,e],s,n)=>{0!==t&&(i++,n.done())}).next(()=>i>0)}_i(t,e){return Sn(t).get(e).next(t=>t?this.serializer.Ua(t):null)}}function Sn(t){return Ti.xh(t,Yn.store)}function Dn(t){return cn.xh(t,Zn.store).get(Zn.key).next(t=>(p(null!==t,"Missing metadata row."),t))}function Cn(t){return Dn(t).next(t=>t.highestListenSequenceNumber)}function kn(t){return Ti.xh(t,Xn.store)}class Nn{constructor(t,e){this.serializer=t,this.Po=e}co(t,e,s){return $n(t).put(Mn(e),s)}_o(t,e){const s=$n(t),n=Mn(e);return s.delete(n)}updateMetadata(t,e){return this.getMetadata(t).next(s=>(s.byteSize+=e,this.Ha(t,s)))}do(t,e){return $n(t).get(Mn(e)).next(t=>this.Ja(t))}Ya(t,e){return $n(t).get(Mn(e)).next(t=>{const e=this.Ja(t);return e?{Xa:e,size:xn(t)}:null})}getEntries(t,e){let s=He();return this.Za(t,e,(t,e)=>{const n=this.Ja(e);s=s.Nt(t,n)}).next(()=>s)}tu(t,e){let s=He(),n=new Vt(Pt.lt);return this.Za(t,e,(t,e)=>{const i=this.Ja(e);i?(s=s.Nt(t,i),n=n.Nt(t,xn(e))):(s=s.Nt(t,null),n=n.Nt(t,0))}).next(()=>({eu:s,su:n}))}Za(t,e,s){if(e.Tt())return Us.resolve();const n=IDBKeyRange.bound(e.first().path.At(),e.last().path.At()),i=e.Ot();let r=i.Kt();return $n(t).Jh({range:n},(t,e,n)=>{const o=Pt.Ct(t);for(;r&&Pt.lt(r,o)<0;)s(r,null),r=i.Kt();r&&r.isEqual(o)&&(s(r,e),r=i.Gt()?i.Kt():null),r?n.Wh(r.path.At()):n.done()}).next(()=>{for(;r;)s(r,null),r=i.Gt()?i.Kt():null})}Co(t,e,s){p(!e.Bs(),"CollectionGroup queries should be handled in LocalDocumentsView");let n=Ye();const i=e.path.length+1,r={};if(s.isEqual(Tt.MIN)){const t=e.path.At();r.range=IDBKeyRange.lowerBound(t)}else{const t=e.path.At(),n=this.serializer.nu(s);r.range=IDBKeyRange.lowerBound([t,n],!0),r.index=Hn.collectionReadTimeIndex}return $n(t).Jh(r,(t,s,r)=>{if(t.length!==i)return;const o=this.serializer.iu(s);e.path.It(o.key.path)?o instanceof _e&&e.matches(o)&&(n=n.Nt(o.key,o)):r.done()}).next(()=>n)}ru(t,e){let s=ze(),n=this.serializer.nu(e);const i=$n(t),r=IDBKeyRange.lowerBound(n,!0);return i.Jh({index:Hn.readTimeIndex,range:r},(t,e)=>{const i=this.serializer.iu(e);s=s.Nt(i.key,i),n=e.readTime}).next(()=>({ou:s,readTime:this.serializer.hu(n)}))}au(t){const e=$n(t);let s,n=Tt.MIN;return e.Jh({index:Hn.readTimeIndex,reverse:!0},(t,e,i)=>{s=this.serializer.iu(e),e.readTime&&(n=this.serializer.hu(e.readTime)),i.done()}).next(()=>({uu:s,readTime:n}))}cu(t){return new Nn.lu(this,!!t&&t._u)}du(t){return this.getMetadata(t).next(t=>t.byteSize)}getMetadata(t){return Fn(t).get(Jn.key).next(t=>(p(!!t,"Missing document cache metadata"),t))}Ha(t,e){return Fn(t).put(Jn.key,e)}Ja(t){if(t){const e=this.serializer.iu(t);return e instanceof de&&e.version.isEqual(Tt.ht())?null:e}return null}}function Fn(t){return Ti.xh(t,Jn.store)}function $n(t){return Ti.xh(t,Hn.store)}function Mn(t){return t.path.At()}function xn(t){let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw V("Unknown remote document type");e=t.noDocument}return JSON.stringify(e).length}Nn.lu=class extends Qs{constructor(t,e){super(),this.fu=t,this._u=e,this.mu=new Ms(t=>t.toString())}To(t){const e=[];let s=0,n=new yt((t,e)=>y(t.Pt(),e.Pt()));return this.ho.forEach((i,r)=>{const o=this.mu.get(i);if(p(void 0!==o,`Cannot modify a document that wasn't read (for ${i})`),r){p(!this.readTime.isEqual(Tt.MIN),"Cannot add a document with a read time of zero");const h=this.fu.serializer.Tu(r,this.readTime);n=n.add(i.path.ft());const a=xn(h);s+=a-o,e.push(this.fu.co(t,i,h))}else if(s-=o,this._u){const s=this.fu.serializer.Tu(new de(i,Tt.ht()),this.readTime);e.push(this.fu.co(t,i,s))}else e.push(this.fu._o(t,i))}),n.forEach(s=>{e.push(this.fu.Po.aa(t,s))}),e.push(this.fu.updateMetadata(t,s)),Us.ro(e)}fo(t,e){return this.fu.Ya(t,e).next(t=>null===t?(this.mu.set(e,0),null):(this.mu.set(e,t.size),t.Xa))}mo(t,e){return this.fu.tu(t,e).next(({eu:t,su:e})=>(e.forEach((t,e)=>{this.mu.set(t,e)}),t))}};class Ln{constructor(){this.Eu=new qn}aa(t,e){return this.Eu.add(e),Us.resolve()}$o(t,e){return Us.resolve(this.Eu.getEntries(e))}}class qn{constructor(){this.index={}}add(t){p(t.length%2==1,"Expected a collection path.");const e=t.wt(),s=t.ft(),n=this.index[e]||new yt(It.lt),i=!n.has(s);return this.index[e]=n.add(s),i}has(t){const e=t.wt(),s=t.ft(),n=this.index[e];return n&&n.has(s)}getEntries(t){return(this.index[t]||new yt(It.lt)).At()}}const On=9;class Bn{constructor(t){this.serializer=t}createOrUpgrade(t,e,s,n){p(s<n&&s>=0&&n<=On,`Unexpected schema upgrade from v${s} to v{toVersion}.`);const i=new _n(e);s<1&&n>=1&&(function(t){t.createObjectStore(Qn.store)}(t),function(t){t.createObjectStore(Wn.store,{keyPath:Wn.keyPath}),t.createObjectStore(jn.store,{keyPath:jn.keyPath,autoIncrement:!0}).createIndex(jn.userMutationsIndex,jn.userMutationsKeyPath,{unique:!0}),t.createObjectStore(Kn.store)}(t),ei(t),function(t){t.createObjectStore(Hn.store)}(t));let r=Us.resolve();return s<3&&n>=3&&(0!==s&&(!function(t){t.deleteObjectStore(Xn.store),t.deleteObjectStore(Yn.store),t.deleteObjectStore(Zn.store)}(t),ei(t)),r=r.next(()=>(function(t){const e=t.store(Zn.store),s=new Zn(0,0,Tt.MIN.ut(),0);return e.put(Zn.key,s)})(i))),s<4&&n>=4&&(0!==s&&(r=r.next(()=>(function(t,e){return e.store(jn.store).Kh().next(s=>{t.deleteObjectStore(jn.store),t.createObjectStore(jn.store,{keyPath:jn.keyPath,autoIncrement:!0}).createIndex(jn.userMutationsIndex,jn.userMutationsKeyPath,{unique:!0});const n=e.store(jn.store),i=s.map(t=>n.put(t));return Us.ro(i)})})(t,i))),r=r.next(()=>{!function(t){t.createObjectStore(si.store,{keyPath:si.keyPath})}(t)})),s<5&&n>=5&&(r=r.next(()=>this.removeAcknowledgedMutations(i))),s<6&&n>=6&&(r=r.next(()=>(function(t){t.createObjectStore(Jn.store)}(t),this.addDocumentGlobal(i)))),s<7&&n>=7&&(r=r.next(()=>this.ensureSequenceNumbers(i))),s<8&&n>=8&&(r=r.next(()=>this.createCollectionParentIndex(t,i))),s<9&&n>=9&&(r=r.next(()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){const e=t.objectStore(Hn.store);e.createIndex(Hn.readTimeIndex,Hn.readTimeIndexPath,{unique:!1}),e.createIndex(Hn.collectionReadTimeIndex,Hn.collectionReadTimeIndexPath,{unique:!1})}(e)})),r}addDocumentGlobal(t){let e=0;return t.store(Hn.store).Jh((t,s)=>{e+=xn(s)}).next(()=>{const s=new Jn(e);return t.store(Jn.store).put(Jn.key,s)})}removeAcknowledgedMutations(t){const e=t.store(Wn.store),s=t.store(jn.store);return e.Kh().next(e=>Us.forEach(e,e=>{const n=IDBKeyRange.bound([e.userId,xs],[e.userId,e.lastAcknowledgedBatchId]);return s.Kh(jn.userMutationsIndex,n).next(s=>Us.forEach(s,s=>{p(s.userId===e.userId,`Cannot process batch ${s.batchId} from unexpected user`);const n=this.serializer.ca(s);return In(t,e.userId,n).next(()=>{})}))}))}ensureSequenceNumbers(t){const e=t.store(Xn.store),s=t.store(Hn.store);return Cn(t).next(t=>{const n=[];return s.Jh((s,i)=>{const r=new It(s),o=function(t){return[0,nn(t)]}(r);n.push(e.get(o).next(s=>s?Us.resolve():(s=>e.put(new Xn(0,nn(s),t)))(r)))}).next(()=>Us.ro(n))})}createCollectionParentIndex(t,e){t.createObjectStore(ti.store,{keyPath:ti.keyPath});const s=e.store(ti.store),n=new qn,i=t=>{if(n.add(t)){const e=t.wt(),n=t.ft();return s.put({collectionId:e,parent:nn(n)})}};return e.store(Hn.store).Jh({Hh:!0},(t,e)=>{const s=new It(t);return i(s.ft())}).next(()=>e.store(Kn.store).Jh({Hh:!0},([t,e,s],n)=>{const r=hn(e);return i(r.ft())}))}}class Un{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class Qn{constructor(t,e,s){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=s}}Qn.store="owner",Qn.key="owner";class Wn{constructor(t,e,s){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=s}}Wn.store="mutationQueues",Wn.keyPath="userId";class jn{constructor(t,e,s,n,i){this.userId=t,this.batchId=e,this.localWriteTimeMs=s,this.baseMutations=n,this.mutations=i}}jn.store="mutations",jn.keyPath="batchId",jn.userMutationsIndex="userMutationsIndex",jn.userMutationsKeyPath=["userId","batchId"];class Kn{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,nn(e)]}static key(t,e,s){return[t,nn(e),s]}}Kn.store="documentMutations",Kn.PLACEHOLDER=new Kn;class Gn{constructor(t,e){this.path=t,this.readTime=e}}class zn{constructor(t,e){this.path=t,this.version=e}}class Hn{constructor(t,e,s,n,i,r){this.unknownDocument=t,this.noDocument=e,this.document=s,this.hasCommittedMutations=n,this.readTime=i,this.parentPath=r}}Hn.store="remoteDocuments",Hn.readTimeIndex="readTimeIndex",Hn.readTimeIndexPath="readTime",Hn.collectionReadTimeIndex="collectionReadTimeIndex",Hn.collectionReadTimeIndexPath=["parentPath","readTime"];class Jn{constructor(t){this.byteSize=t}}Jn.store="remoteDocumentGlobal",Jn.key="remoteDocumentGlobalKey";class Yn{constructor(t,e,s,n,i,r,o){this.targetId=t,this.canonicalId=e,this.readTime=s,this.resumeToken=n,this.lastListenSequenceNumber=i,this.lastLimboFreeSnapshotVersion=r,this.query=o}}Yn.store="targets",Yn.keyPath="targetId",Yn.queryTargetsIndexName="queryTargetsIndex",Yn.queryTargetsKeyPath=["canonicalId","targetId"];class Xn{constructor(t,e,s){this.targetId=t,this.path=e,this.sequenceNumber=s,p(0===t==(void 0!==s),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}}Xn.store="targetDocuments",Xn.keyPath=["targetId","path"],Xn.documentTargetsIndex="documentTargetsIndex",Xn.documentTargetsKeyPath=["path","targetId"];class Zn{constructor(t,e,s,n){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=s,this.targetCount=n}}Zn.key="targetGlobalKey",Zn.store="targetGlobal";class ti{constructor(t,e){this.collectionId=t,this.parent=e}}function ei(t){t.createObjectStore(Xn.store,{keyPath:Xn.keyPath}).createIndex(Xn.documentTargetsIndex,Xn.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Yn.store,{keyPath:Yn.keyPath}).createIndex(Yn.queryTargetsIndexName,Yn.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Zn.store)}ti.store="collectionParents",ti.keyPath=["collectionId","parent"];class si{constructor(t,e,s,n){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=s,this.inForeground=n}}si.store="clientMetadata",si.keyPath="clientId";const ni=[...[...[...[Wn.store,jn.store,Kn.store,Hn.store,Yn.store,Qn.store,Zn.store,Xn.store],si.store],Jn.store],ti.store];class ii{constructor(){this.wu=new qn}aa(t,e){if(p(e.length%2==1,"Expected a collection path."),!this.wu.has(e)){const s=e.wt(),n=e.ft();t.wo(()=>{this.wu.add(e)});const i={collectionId:s,parent:nn(n)};return ri(t).put(i)}return Us.resolve()}$o(t,e){const s=[],n=IDBKeyRange.bound([e,""],[v(e),""],!1,!0);return ri(t).Kh(n).next(t=>{for(const n of t){if(n.collectionId!==e)break;s.push(hn(n.parent))}return s})}}function ri(t){return Ti.xh(t,ti.store)}class oi{constructor(t){this.Iu=t}iu(t){if(t.document)return this.Iu.Oi(t.document,!!t.hasCommittedMutations);if(t.noDocument){const e=Pt.Ct(t.noDocument.path),s=this.Ru(t.noDocument.readTime);return new de(e,s,{hasCommittedMutations:!!t.hasCommittedMutations})}if(t.unknownDocument){const e=Pt.Ct(t.unknownDocument.path),s=this.Ru(t.unknownDocument.version);return new fe(e,s)}return V("Unexpected DbRemoteDocument")}Tu(t,e){const s=this.nu(e),n=t.key.path.ft().At();if(t instanceof _e){const e=t.proto?t.proto:this.Iu.qi(t),i=t.hasCommittedMutations;return new Hn(null,null,e,i,s,n)}if(t instanceof de){const e=t.key.path.At(),i=this.Au(t.version),r=t.hasCommittedMutations;return new Hn(null,new Gn(e,i),null,r,s,n)}if(t instanceof fe){const e=t.key.path.At(),i=this.Au(t.version);return new Hn(new zn(e,i),null,null,!0,s,n)}return V("Unexpected MaybeDocument")}nu(t){const e=t.ut();return[e.seconds,e.nanoseconds]}hu(t){const e=new mt(t[0],t[1]);return Tt.ot(e)}Au(t){const e=t.ut();return new Un(e.seconds,e.nanoseconds)}Ru(t){const e=new mt(t.seconds,t.nanoseconds);return Tt.ot(e)}ha(t,e){const s=e.baseMutations.map(t=>this.Iu.Hi(t)),n=e.mutations.map(t=>this.Iu.Hi(t));return new jn(t,e.batchId,e.ns.toMillis(),s,n)}ca(t){const e=(t.baseMutations||[]).map(t=>this.Iu.Zi(t)),s=t.mutations.map(t=>this.Iu.Zi(t)),n=mt.fromMillis(t.localWriteTimeMs);return new Ls(t.batchId,n,e,s)}Pu(t){const e=[];return t.forEach(t=>{e.push(nn(t.path))}),e}Vu(t){let e=es();for(const s of t)e=e.add(new Pt(hn(s)));return e}Ua(t){const e=this.Ru(t.readTime),s=void 0!==t.lastLimboFreeSnapshotVersion?this.Ru(t.lastLimboFreeSnapshotVersion):Tt.MIN,n=t.resumeToken;let i;return i=void 0!==t.query.documents?this.Iu.or(t.query):this.Iu.lr(t.query),new Ue(i,t.targetId,Le.js,t.lastListenSequenceNumber,e,s,n)}Qa(t){p(Le.js===t.zs,"Only queries with purpose "+Le.js+" may be stored, got "+t.zs);const e=this.Au(t.Hs),s=this.Au(t.lastLimboFreeSnapshotVersion);let n,i;return n=t.target._s()?this.Iu.rr(t.target):this.Iu.hr(t.target),t.resumeToken instanceof Uint8Array?(p(cn.Fh(),"Persisting non-string stream tokens is only supported with mock persistence ."),i=t.resumeToken.toString()):i=t.resumeToken,new Yn(t.targetId,t.target.canonicalId(),e,i,t.sequenceNumber,s,n)}}const hi="IndexedDbPersistence",ai=18e5,ui=5e3,ci=4e3,li="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",_i="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",di="This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.",fi="firestore_zombie";class mi extends Ws{constructor(t,e){super(),this.Ea=t,this.pu=e}}class Ti{constructor(t,e,s,n,i,r,o,h){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=s,this.gu=r,this.yu=h,this.bu=!1,this.isPrimary=!1,this.networkEnabled=!0,this.vu=null,this.inForeground=!1,this.Su=null,this.Du=null,this.Cu=Number.NEGATIVE_INFINITY,this.ku=t=>Promise.resolve(),this.Xh=new Ri(this,i),this.Nu=e+Ti.Fu,this.serializer=new oi(o),this.document=n.document,this.$u=new vn(this.Xh,this.serializer),this.Po=new ii,this.Ro=new Nn(this.serializer,this.Po),!n.window||!n.window.localStorage)throw new L(x.q,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=n.window,this.Mu=this.window.localStorage}static xh(t,e){if(t instanceof mi)return cn.xh(t.Ea,e);throw V("IndexedDbPersistence must use instances of IndexedDbTransaction")}static async xu(t){if(!Ti.Nh())throw new L(x.q,di);const e=new Ti(t.allowTabSynchronization,t.persistenceKey,t.clientId,t.platform,t.Lu,t.gu,t.serializer,t.yu);return await e.start(),e}start(){return p(!this.qu,"IndexedDbPersistence double-started!"),p(null!==this.window,"Expected 'window' to be defined"),cn.kh(this.Nu,On,new Bn(this.serializer)).then(t=>(this.Ou=t,this.Bu())).then(()=>(this.Uu(),this.Qu(),this.Wu(),this.Ou.runTransaction("readonly-idempotent",[Zn.store],t=>Cn(t)))).then(t=>{this.ju=new Gs(t,this.yu)}).then(()=>{this.bu=!0}).catch(t=>(this.Ou&&this.Ou.close(),Promise.reject(t)))}Ku(t){return this.ku=async e=>{if(this.qu)return t(e)},t(this.isPrimary)}Gu(t){this.Ou.Lh(async e=>{null===e.newVersion&&await t()})}zu(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.gu.lh(async()=>{this.qu&&await this.Bu()}))}Bu(){return this.Ou.runTransaction("readwrite-idempotent",ni,t=>{return Ii(t).put(new si(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.Hu(t).next(t=>{t||(this.isPrimary=!1,this.gu.lh(()=>this.ku(!1)))})}).next(()=>this.Ju(t)).next(e=>this.isPrimary&&!e?this.Yu(t).next(()=>!1):!!e&&this.Xu(t).next(()=>!0))}).catch(t=>{if(!this.allowTabSynchronization)throw t;return R(hi,"Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.gu.lh(()=>this.ku(t)),this.isPrimary=t})}Hu(t){return wi(t).get(Qn.key).next(t=>Us.resolve(this.Zu(t)))}tc(t){return Ii(t).delete(this.clientId)}async ec(){if(this.isPrimary&&!this.sc(this.Cu,ai)){this.Cu=Date.now(),(await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary-idempotent",t=>{const e=Ti.xh(t,si.store);return e.Kh().next(t=>{const s=this.nc(t,ai),n=t.filter(t=>-1===s.indexOf(t));return Us.forEach(n,t=>e.delete(t.clientId)).next(()=>n)})})).forEach(t=>{this.window.localStorage.removeItem(this.ic(t.clientId))})}}Wu(){this.Du=this.gu.ph(Hs.Xo,ci,()=>this.Bu().then(()=>this.ec()).then(()=>this.Wu()))}Zu(t){return!!t&&t.ownerId===this.clientId}Ju(t){return wi(t).get(Qn.key).next(e=>{if(null!==e&&this.sc(e.leaseTimestampMs,ui)&&!this.rc(e.ownerId)){if(this.Zu(e)&&this.networkEnabled)return!0;if(!this.Zu(e)){if(!e.allowTabSynchronization)throw new L(x.$,_i);return!1}}return!(!this.networkEnabled||!this.inForeground)||Ii(t).Kh().next(t=>{return void 0===this.nc(t,ui).find(t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,s=!this.inForeground&&t.inForeground,n=this.networkEnabled===t.networkEnabled;if(e||s&&n)return!0}return!1})})}).next(t=>(this.isPrimary!==t&&R(hi,`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}async oc(){this.bu=!1,this.hc(),this.Du&&(this.Du.cancel(),this.Du=null),this.ac(),this.uc(),await this.Ou.runTransaction("readwrite-idempotent",[Qn.store,si.store],t=>this.Yu(t).next(()=>this.tc(t))),this.Ou.close(),this.cc()}nc(t,e){return t.filter(t=>this.sc(t.updateTimeMs,e)&&!this.rc(t.clientId))}lc(){return this.Ou.runTransaction("readonly-idempotent",[si.store],t=>Ii(t).Kh().next(t=>this.nc(t,ai).map(t=>t.clientId)))}static async clearPersistence(t){if(!Ti.Nh())return Promise.resolve();const e=t+Ti.Fu;await cn.delete(e)}get qu(){return this.bu}_c(t){return p(this.qu,"Cannot initialize MutationQueue before persistence is started."),En.ta(t,this.serializer,this.Po,this.Xh)}dc(){return p(this.qu,"Cannot initialize TargetCache before persistence is started."),this.$u}fc(){return p(this.qu,"Cannot initialize RemoteDocumentCache before persistence is started."),this.Ro}mc(){return p(this.qu,"Cannot initialize IndexManager before persistence is started."),this.Po}runTransaction(t,e,s){R(hi,"Starting transaction:",t);const n=e.endsWith("idempotent"),i=e.startsWith("readonly")?n?"readonly-idempotent":"readonly":n?"readwrite-idempotent":"readwrite";let r;return this.Ou.runTransaction(i,ni,n=>(r=new mi(n,this.ju.next()),"readwrite-primary"===e||"readwrite-primary-idempotent"===e?this.Hu(n).next(t=>!!t||this.Ju(n)).next(e=>{if(!e)throw A(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.gu.lh(()=>this.ku(!1)),new L(x.$,li);return s(r)}).next(t=>this.Xu(n).next(()=>t)):this.Tc(n).next(()=>s(r)))).then(t=>(r.Io(),t))}Tc(t){return wi(t).get(Qn.key).next(t=>{if(null!==t&&this.sc(t.leaseTimestampMs,ui)&&!this.rc(t.ownerId)&&!this.Zu(t)&&!t.allowTabSynchronization)throw new L(x.$,_i)})}Xu(t){const e=new Qn(this.clientId,this.allowTabSynchronization,Date.now());return wi(t).put(Qn.key,e)}static Nh(){return cn.Nh()}static Ec(t){let e=t.o.projectId;return t.o.h||(e+="."+t.o.database),"firestore/"+t.persistenceKey+"/"+e+"/"}Yu(t){const e=wi(t);return e.get(Qn.key).next(t=>this.Zu(t)?(R(hi,"Releasing primary lease."),e.delete(Qn.key)):Us.resolve())}sc(t,e){const s=Date.now();return!(t<s-e)&&(!(t>s)||(A(`Detected an update time that is in the future: ${t} > ${s}`),!1))}Uu(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Su=()=>{this.gu.lh(()=>(this.inForeground="visible"===this.document.visibilityState,this.Bu()))},this.document.addEventListener("visibilitychange",this.Su),this.inForeground="visible"===this.document.visibilityState)}ac(){this.Su&&(p(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.Su),this.Su=null)}Qu(){"function"==typeof this.window.addEventListener&&(this.vu=()=>{this.hc(),this.gu.lh(()=>this.oc())},this.window.addEventListener("unload",this.vu))}uc(){this.vu&&(p("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.vu),this.vu=null)}rc(t){try{const e=null!==this.Mu.getItem(this.ic(t));return R(hi,`Client '${t}' ${e?"is":"is not"} zombied in LocalStorage`),e}catch(t){return A(hi,"Failed to get zombied client id.",t),!1}}hc(){try{this.Mu.setItem(this.ic(this.clientId),String(Date.now()))}catch(t){A("Failed to set zombie client id.",t)}}cc(){try{this.Mu.removeItem(this.ic(this.clientId))}catch(t){}}ic(t){return`${fi}_${this.persistenceKey}_${t}`}}async function Ei(t){if(!function(t){return t.code===x.$&&t.message===li}(t))throw t;R(hi,"Unexpectedly lost primary lease")}function wi(t){return t.store(Qn.store)}function Ii(t){return t.store(si.store)}Ti.Fu="main";class Ri{constructor(t,e){this.db=t,this.wc=null,this.Ic=new Si(this,e)}Rc(t){const e=this.Ac(t);return this.db.dc().Wa(t).next(t=>e.next(e=>t+e))}Ac(t){let e=0;return this.Pc(t,t=>{e++}).next(()=>e)}ei(t,e){return this.db.dc().ei(t,e)}Pc(t,e){return this.Vc(t,(t,s)=>e(s))}pc(t){this.wc=t}Br(t,e){return Ai(t,e)}Qr(t,e){return Ai(t,e)}Ba(t,e,s){return this.db.dc().Ba(t,e,s)}Ia(t,e){return Ai(t,e)}gc(t,e){return this.wc.Hr(e)?Us.resolve(!0):function(t,e){let s=!1;return Vn(t).Yh(n=>wn(t,n,e).next(t=>(t&&(s=!0),Us.resolve(!t)))).next(()=>s)}(t,e)}yc(t,e){const s=this.db.fc().cu(),n=[];let i=0;return this.Vc(t,(r,o)=>{if(o<=e){const e=this.gc(t,r).next(e=>{if(!e)return i++,s.do(t,r).next(()=>(s._o(r),kn(t).delete(function(t){return[0,nn(t.path)]}(r))))});n.push(e)}}).next(()=>Us.ro(n)).next(()=>s.apply(t)).next(()=>i)}removeTarget(t,e){const s=e.Js(t.pu);return this.db.dc().La(t,s)}bc(t,e){return Ai(t,e)}Vc(t,e){const s=kn(t);let n,i=Gs.jo;return s.Jh({index:Xn.documentTargetsIndex},([t,s],{path:r,sequenceNumber:o})=>{0===t?(i!==Gs.jo&&e(new Pt(hn(n)),i),i=o,n=r):i=Gs.jo}).next(()=>{i!==Gs.jo&&e(new Pt(hn(n)),i)})}vc(t){return this.db.fc().du(t)}}function Ai(t,e){return kn(t).put(function(t,e){return new Xn(0,nn(t.path),e)}(e,t.pu))}function Pi([t,e],[s,n]){const i=y(t,s);return 0===i?y(e,n):i}class Vi{constructor(t){this.Sc=t,this.buffer=new yt(Pi),this.Dc=0}Cc(){return++this.Dc}kc(t){const e=[t,this.Cc()];if(this.buffer.size<this.Sc)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Pi(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}const pi={Nc:!1,Fc:0,$c:0,Mc:0};class gi{constructor(t,e,s){this.xc=t,this.Lc=e,this.qc=s}static Oc(t){return new gi(t,gi.Bc,gi.Uc)}}gi.Qc=-1,gi.Wc=1048576,gi.jc=41943040,gi.Bc=10,gi.Uc=1e3,gi.Kc=new gi(gi.jc,gi.Bc,gi.Uc),gi.DISABLED=new gi(gi.Qc,0,0);const yi=6e4,bi=3e5;class vi{constructor(t,e,s){this.Ic=t,this.eh=e,this.Gc=s,this.zc=!1,this.Hc=null}start(){p(null===this.Hc,"Cannot start an already started LruScheduler"),this.Ic.Jc.xc!==gi.Qc&&this.Yc()}stop(){this.Hc&&(this.Hc.cancel(),this.Hc=null)}get qu(){return null!==this.Hc}Yc(){p(null===this.Hc,"Cannot schedule GC while a task is pending");const t=this.zc?bi:yi;R("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Hc=this.eh.ph(Hs.Zo,t,()=>(this.Hc=null,this.zc=!0,this.Gc.Xc(this.Ic).then(()=>this.Yc()).catch(Ei)))}}class Si{constructor(t,e){this.Zc=t,this.Jc=e}tl(t,e){return this.Zc.Rc(t).next(t=>Math.floor(e/100*t))}el(t,e){if(0===e)return Us.resolve(Gs.jo);const s=new Vi(e);return this.Zc.ei(t,t=>s.kc(t.sequenceNumber)).next(()=>this.Zc.Pc(t,t=>s.kc(t))).next(()=>s.maxValue)}Ba(t,e,s){return this.Zc.Ba(t,e,s)}yc(t,e){return this.Zc.yc(t,e)}sl(t,e){return this.Jc.xc===gi.Qc?(R("LruGarbageCollector","Garbage collection skipped; disabled"),Us.resolve(pi)):this.vc(t).next(s=>s<this.Jc.xc?(R("LruGarbageCollector",`Garbage collection skipped; Cache size ${s} `+`is lower than threshold ${this.Jc.xc}`),pi):this.nl(t,e))}vc(t){return this.Zc.vc(t)}nl(t,e){let s,n,i,r,o,h,a;const u=Date.now();return this.tl(t,this.Jc.Lc).next(e=>(e>this.Jc.qc?(R("LruGarbageCollector","Capping sequence numbers to collect down "+`to the maximum of ${this.Jc.qc} `+`from ${e}`),n=this.Jc.qc):n=e,r=Date.now(),this.el(t,n))).next(n=>(s=n,o=Date.now(),this.Ba(t,s,e))).next(e=>(i=e,h=Date.now(),this.yc(t,s))).next(t=>{if(a=Date.now(),w()<=E.DEBUG){R("LruGarbageCollector","LRU Garbage Collection\n"+`\tCounted targets in ${r-u}ms\n`+`\tDetermined least recently used ${n} in `+`${o-r}ms\n`+`\tRemoved ${i} targets in `+`${h-o}ms\n`+`\tRemoved ${t} documents in `+`${a-h}ms\n`+`Total Duration: ${a-u}ms`)}return Us.resolve({Nc:!0,Fc:n,$c:i,Mc:t})})}}const Di="LocalStore";class Ci{constructor(t,e,s){this.persistence=t,this.il=e,this.rl=new Os,this.ol=new Vt(y),this.hl=new Ms(t=>t.canonicalId()),this.al=Tt.MIN,p(t.qu,"LocalStore was passed an unstarted persistence implementation"),this.persistence.Xh.pc(this.rl),this.Ao=t._c(s),this.ul=t.fc(),this.$u=t.dc(),this.cl=new js(this.ul,this.Ao,this.persistence.mc()),this.il.ll(this.cl)}start(){return this._l()}async dl(t){let e=this.Ao,s=this.cl;const n=await this.persistence.runTransaction("Handle user change","readonly-idempotent",n=>{let i;return this.Ao.fa(n).next(r=>(i=r,e=this.persistence._c(t),s=new js(this.ul,e,this.persistence.mc()),e.fa(n))).next(t=>{const e=[],r=[];let o=es();for(const t of i){e.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const e of t){r.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return s.vo(n,o).next(t=>({fl:t,ml:e,Tl:r}))})});return this.Ao=e,this.cl=s,this.il.ll(this.cl),n}El(t){const e=mt.now(),s=t.reduce((t,e)=>t.add(e.key),es());let n;return this.persistence.runTransaction("Locally write mutations","readwrite-idempotent",i=>this.cl.vo(i,s).next(s=>{n=s;const r=[];for(const e of t){const t=e.Se(n.get(e.key));null!=t&&r.push(new jt(e.key,t,t.De(),Ut.exists(!0)))}return this.Ao.oa(i,e,r,t)})).then(t=>{const e=t.$r(n);return{batchId:t.batchId,ho:e}})}wl(t){return this.persistence.runTransaction("Lookup mutation documents","readonly-idempotent",e=>this.Ao.la(e,t).next(t=>t?this.cl.vo(e,t):Us.resolve(null)))}sa(t){return this.persistence.runTransaction("Acknowledge batch","readwrite-primary-idempotent",e=>{const s=t.batch.keys(),n=this.ul.cu({_u:!0});return this.Ao.sa(e,t.batch,t.streamToken).next(()=>this.Il(e,t,n)).next(()=>n.apply(e)).next(()=>this.Ao.Ra(e)).next(()=>this.cl.vo(e,s))})}Rl(t){return this.persistence.runTransaction("Reject batch","readwrite-primary-idempotent",e=>{let s;return this.Ao.ua(e,t).next(t=>(p(null!==t,"Attempt to reject nonexistent batch!"),s=t.keys(),this.Ao.Ta(e,t))).next(()=>this.Ao.Ra(e)).next(()=>this.cl.vo(e,s))})}da(){return this.persistence.runTransaction("Get highest unacknowledged batch id","readonly-idempotent",t=>this.Ao.da(t))}ia(){return this.persistence.runTransaction("Get last stream token","readonly-idempotent",t=>this.Ao.ia(t))}ra(t){return this.persistence.runTransaction("Set last stream token","readwrite-primary-idempotent",e=>this.Ao.ra(e,t))}ka(){return this.persistence.runTransaction("Get last remote snapshot version","readonly-idempotent",t=>this.$u.ka(t))}Al(t){const e=t.Hs;let s=this.ol;return this.persistence.runTransaction("Apply remote event","readwrite-primary-idempotent",n=>{const i=this.ul.cu({_u:!0});s=this.ol;const r=[];K(t.mn,(t,i)=>{const o=s.get(t);if(!o)return;r.push(this.$u.Ga(n,i.pn,t).next(()=>this.$u.Ka(n,i.Pn,t)));const h=i.resumeToken;if(h.length>0){const a=o.Ys(h,e).Js(n.pu);s=s.Nt(t,a),Ci.Pl(o,a,i)&&r.push(this.$u.La(n,a))}});let o=ze(),h=es();if(t.En.forEach((t,e)=>{h=h.add(t)}),r.push(i.getEntries(n,h).next(s=>{t.En.forEach((h,a)=>{const u=s.get(h);a instanceof de&&a.version.isEqual(Tt.MIN)?(i._o(h,e),o=o.Nt(h,a)):null==u||a.version.u(u.version)>0||0===a.version.u(u.version)&&u.hasPendingWrites?(p(!Tt.MIN.isEqual(e),"Cannot add a document when the remote version is zero"),i.co(a,e),o=o.Nt(h,a)):R(Di,"Ignoring outdated watch update for ",h,". Current version:",u.version," Watch version:",a.version),t.wn.has(h)&&r.push(this.persistence.Xh.bc(n,h))})})),!e.isEqual(Tt.MIN)){const t=this.$u.ka(n).next(t=>(p(e.u(t)>=0,"Watch stream reverted to previous snapshot?? "+e+" < "+t),this.$u.Fa(n,n.pu,e)));r.push(t)}return Us.ro(r).next(()=>i.apply(n)).next(()=>this.cl.So(n,o))}).then(t=>(this.ol=s,t))}static Pl(t,e,s){if(p(e.resumeToken.length>0,"Attempted to persist target data with no resume token"),0===t.resumeToken.length)return!0;return e.Hs.at()-t.Hs.at()>=this.Vl||s.Pn.size+s.Vn.size+s.pn.size>0}pl(t){for(const e of t){const t=e.targetId;if(this.rl.Ur(e.Lo,t),this.rl.jr(e.qo,t),!e.fromCache){const e=this.ol.get(t);p(null!==e,`Can't set limbo-free snapshot version for unknown target: ${t}`);const s=e.Hs,n=e.Xs(s);this.ol=this.ol.Nt(t,n)}}return this.persistence.runTransaction("notifyLocalViewChanges","readwrite-idempotent",e=>Us.forEach(t,t=>Us.forEach(t.qo,t=>this.persistence.Xh.Qr(e,t))))}gl(t){return this.persistence.runTransaction("Get next mutation batch","readonly-idempotent",e=>(void 0===t&&(t=xs),this.Ao._a(e,t)))}yl(t){return this.persistence.runTransaction("read document","readonly-idempotent",e=>this.cl.Vo(e,t))}bl(t){return this.persistence.runTransaction("Allocate target","readwrite-idempotent",e=>{let s;return this.$u.ja(e,t).next(n=>n?(s=n,Us.resolve(s)):this.$u.Sa(e).next(n=>(s=new Ue(t,n,Le.js,e.pu),this.$u.$a(e,s).next(()=>s))))}).then(e=>(null===this.ol.get(e.targetId)&&(this.ol=this.ol.Nt(e.targetId,e),this.hl.set(t,e.targetId)),e))}ja(t,e){const s=this.hl.get(e);return void 0!==s?Us.resolve(this.ol.get(s)):this.$u.ja(t,e)}vl(t,e){const s=this.ol.get(t);p(null!==s,`Tried to release nonexistent target: ${t}`);const n=e?"readwrite-idempotent":"readwrite-primary-idempotent";return this.persistence.runTransaction("Release target",n,n=>{const i=this.rl.Kr(t);return e?Us.resolve():Us.forEach(i,t=>this.persistence.Xh.Qr(n,t)).next(()=>{this.persistence.Xh.removeTarget(n,s)})}).then(()=>{this.ol=this.ol.remove(t),this.hl.delete(s.target)})}Sl(t,e){let s=Tt.MIN,n=es();return this.persistence.runTransaction("Execute query","readonly-idempotent",i=>this.ja(i,t.ks()).next(t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,this.$u.za(i,t.targetId).next(t=>{n=t})}).next(()=>this.il.Co(i,t,e?s:Tt.MIN,e?n:es())).next(t=>({documents:t,Dl:n})))}Cl(t){return this.persistence.runTransaction("Remote document keys","readonly-idempotent",e=>this.$u.za(e,t))}lc(){return this.persistence.lc()}kl(t){this.Ao.wa(t)}zu(t){this.persistence.zu(t)}Il(t,e,s){const n=e.batch,i=n.keys();let r=Us.resolve();return i.forEach(i=>{r=r.next(()=>s.do(t,i)).next(t=>{let r=t;const o=e.xr.get(i);p(null!==o,"ackVersions should contain every doc in the write."),(!r||r.version.u(o)<0)&&((r=n._e(i,r,e))?s.co(r,e.Mr):p(!t,"Mutation batch "+n+" applied to document "+t+" resulted in null"))})}),r.next(()=>this.Ao.Ta(t,n))}Xc(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary-idempotent",e=>t.sl(e,this.ol))}Nl(t){const e=this.ol.get(t);return e?Promise.resolve(e.target):this.persistence.runTransaction("Get target data","readonly-idempotent",e=>this.$u._i(e,t).next(t=>t?t.target:null))}ru(){return this.persistence.runTransaction("Get new document changes","readonly-idempotent",t=>this.ul.ru(t,this.al)).then(({ou:t,readTime:e})=>(this.al=e,t))}async _l(){if(this.ul instanceof Nn){const t=this.ul;return this.persistence.runTransaction("Synchronize last document change read time","readonly-idempotent",e=>t.au(e)).then(({readTime:t})=>{this.al=t})}}}Ci.Vl=3e8;class ki{constructor(...t){!function(t,e,s,n){if(!(e instanceof Array)||e.length<n)throw new L(x.D,`Function ${t}() requires its ${s} argument to be an `+"array with at least "+`${dt(n,"element")}.`)}("FieldPath",t,"fieldNames",1);for(let e=0;e<t.length;++e)if(Z("FieldPath","string",e,t[e]),0===t[e].length)throw new L(x.D,"Invalid field name at argument $(i + 1). Field names must not be empty.");this.Fl=new At(t)}static documentId(){return ki.$l}isEqual(t){if(!(t instanceof ki))throw ct("isEqual","FieldPath",1,t);return this.Fl.isEqual(t.Fl)}}ki.$l=new ki(At.bt().Pt());const Ni=new RegExp("[~\\*/\\[\\]]");class Fi{constructor(t){this.Ml=t}static delete(){return H("FieldValue.delete",arguments),$i.instance}static serverTimestamp(){return H("FieldValue.serverTimestamp",arguments),Mi.instance}static arrayUnion(...t){return Y("FieldValue.arrayUnion",arguments,1),new xi(t)}static arrayRemove(...t){return Y("FieldValue.arrayRemove",arguments,1),new Li(t)}static increment(t){return Z("FieldValue.increment","number",1,t),J("FieldValue.increment",arguments,1),new qi(t)}isEqual(t){return this===t}}class $i extends Fi{constructor(){super("FieldValue.delete")}}$i.instance=new $i;class Mi extends Fi{constructor(){super("FieldValue.serverTimestamp")}}Mi.instance=new Mi;class xi extends Fi{constructor(t){super("FieldValue.arrayUnion"),this.xl=t}}class Li extends Fi{constructor(t){super("FieldValue.arrayRemove"),this.xl=t}}class qi extends Fi{constructor(t){super("FieldValue.increment"),this.Ll=t}}const Oi=Cs(Fi,"Use FieldValue.<field>() instead."),Bi=/^__.*__$/;class Ui{constructor(t,e,s){this.data=t,this.De=e,this.fieldTransforms=s}ql(t,e){const s=[];return null!==this.De?s.push(new jt(t,this.data,this.De,e)):s.push(new Wt(t,this.data,e)),this.fieldTransforms.length>0&&s.push(new Kt(t,this.fieldTransforms)),s}}class Qi{constructor(t,e,s){this.data=t,this.De=e,this.fieldTransforms=s}ql(t,e){const s=[new jt(t,this.data,this.De,e)];return this.fieldTransforms.length>0&&s.push(new Kt(t,this.fieldTransforms)),s}}var Wi,ji;function Ki(t){switch(t){case Wi.Set:case Wi.Ol:case Wi.Bl:return!0;case Wi.Ul:case Wi.Ql:return!1;default:throw V(`Unexpected case for UserDataSource: ${t}`)}}(ji=Wi||(Wi={}))[ji.Set=0]="Set",ji[ji.Bl=1]="__PRIVATE_Update",ji[ji.Ol=2]="__PRIVATE_MergeSet",ji[ji.Ul=3]="__PRIVATE_Argument",ji[ji.Ql=4]="__PRIVATE_ArrayArgument";class Gi{constructor(t,e,s,n,i,r){this.Wl=t,this.methodName=e,this.path=s,this.jl=n,void 0===i&&this.Kl(),this.jl=void 0!==n&&n,this.fieldTransforms=i||[],this.De=r||[]}Gl(t){const e=null==this.path?null:this.path.child(t),s=new Gi(this.Wl,this.methodName,e,!1,this.fieldTransforms,this.De);return s.zl(t),s}Hl(t){const e=null==this.path?null:this.path.child(t),s=new Gi(this.Wl,this.methodName,e,!1,this.fieldTransforms,this.De);return s.Kl(),s}Jl(t){return new Gi(this.Wl,this.methodName,null,!0,this.fieldTransforms,this.De)}Yl(t){const e=null===this.path||this.path.Tt()?"":` (found in field ${this.path.toString()})`;return new L(x.D,`Function ${this.methodName}() called with invalid data. `+t+e)}contains(t){return void 0!==this.De.find(e=>t.It(e))||void 0!==this.fieldTransforms.find(e=>t.It(e.field))}Kl(){if(null!==this.path)for(let t=0;t<this.path.length;t++)this.zl(this.path.get(t))}zl(t){if(0===t.length)throw this.Yl("Document fields must not be empty");if(Ki(this.Wl)&&Bi.test(t))throw this.Yl('Document fields cannot begin and end with "__"')}}class zi{constructor(t,e){this.o=t,this.key=e}}class Hi{constructor(t){this.Xl=t}Zl(t,e){const s=new Gi(Wi.Set,t,At.pt);Yi("Data must be an object, but it was:",s,e);const n=this.t_(e,s);return new Ui(n,null,s.fieldTransforms)}e_(t,e,s){const n=new Gi(Wi.Ol,t,At.pt);Yi("Data must be an object, but it was:",n,e);const i=this.t_(e,n);let r,o;if(s){let e=new yt(At.lt);for(const i of s){let s;if(i instanceof ki)s=i.Fl;else{if("string"!=typeof i)throw V("Expected stringOrFieldPath to be a string or a FieldPath");s=Zi(t,i)}if(!n.contains(s))throw new L(x.D,`Field '${s}' is specified in your field mask but missing from your input data.`);e=e.add(s)}r=Nt.Te(e),o=n.fieldTransforms.filter(t=>r.we(t.field))}else r=Nt.Ee(n.De),o=n.fieldTransforms;return new Ui(i,r,o)}s_(t,e){const s=new Gi(Wi.Bl,t,At.pt);Yi("Data must be an object, but it was:",s,e);let n=new yt(At.lt),i=ue.EMPTY;G(e,(e,r)=>{const o=Zi(t,e),h=s.Hl(o);if((r=this.n_(r,h))instanceof $i)n=n.add(o);else{const t=this.t_(r,h);null!=t&&(n=n.add(o),i=i.set(o,t))}});const r=Nt.Te(n);return new Qi(i,r,s.fieldTransforms)}i_(t,e,s,n){const i=new Gi(Wi.Bl,t,At.pt),r=[Xi(t,e)],o=[s];if(n.length%2!=0)throw new L(x.D,`Function ${t}() needs to be called with an even number `+"of arguments that alternate between field names and values.");for(let e=0;e<n.length;e+=2)r.push(Xi(t,n[e])),o.push(n[e+1]);let h=new yt(At.lt),a=ue.EMPTY;for(let t=0;t<r.length;++t){const e=r[t],s=i.Hl(e),n=this.n_(o[t],s);if(n instanceof $i)h=h.add(e);else{const t=this.t_(n,s);null!=t&&(h=h.add(e),a=a.set(e,t))}}const u=Nt.Te(h);return new Qi(a,u,i.fieldTransforms)}r_(t,e,s=!1){const n=new Gi(s?Wi.Ql:Wi.Ul,t,At.pt),i=this.t_(e,n);return p(null!=i,"Parsed data should not be null."),p(0===n.fieldTransforms.length,"Field transforms should have been disallowed."),i}n_(t,e){try{return this.Xl(t)}catch(t){const s=tr(t);throw e.Yl(s)}}t_(t,e){if(Ji(t=this.n_(t,e)))return Yi("Unsupported field value:",e,t),this.o_(t,e);if(t instanceof Fi)return this.h_(t,e),null;if(e.path&&e.De.push(e.path),t instanceof Array){if(e.jl&&e.Wl!==Wi.Ql)throw e.Yl("Nested arrays are not supported");return this.a_(t,e)}return this.u_(t,e)}o_(t,e){let s=new Vt(y);return z(t)?e.path&&e.path.length>0&&e.De.push(e.path):G(t,(t,n)=>{const i=this.t_(n,e.Gl(t));null!=i&&(s=s.Nt(t,i))}),new ue(s)}a_(t,e){const s=[];let n=0;for(const i of t){let t=this.t_(i,e.Jl(n));null==t&&(t=Yt.Ze),s.push(t),n++}return new ce(s)}h_(t,e){if(!Ki(e.Wl))throw e.Yl(`${t.Ml}() can only be used with update() and set()`);if(null===e.path)throw e.Yl(`${t.Ml}() is not currently supported inside arrays`);if(t instanceof $i){if(e.Wl!==Wi.Ol)throw e.Wl===Wi.Bl?(p(e.path.length>0,"FieldValue.delete() at the top level should have already been handled."),e.Yl("FieldValue.delete() can only appear at the top level of your update data")):e.Yl("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");e.De.push(e.path)}else if(t instanceof Mi)e.fieldTransforms.push(new Ft(e.path,vt.instance));else if(t instanceof xi){const s=this.c_(t.Ml,t.xl),n=new St(s);e.fieldTransforms.push(new Ft(e.path,n))}else if(t instanceof Li){const s=this.c_(t.Ml,t.xl),n=new Dt(s);e.fieldTransforms.push(new Ft(e.path,n))}else if(t instanceof qi){const s=this.r_("FieldValue.increment",t.Ll),n=new Ct(s);e.fieldTransforms.push(new Ft(e.path,n))}else V("Unknown FieldValue type: "+t)}u_(t,e){if(null===t)return Yt.Ze;if("number"==typeof t)return Re(t)?new ee(t):new se(t);if("boolean"==typeof t)return Xt.of(t);if("string"==typeof t)return new ne(t);if(t instanceof Date)return new ie(mt.fromDate(t));if(t instanceof mt)return new ie(new mt(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)));if(t instanceof ft)return new ae(t);if(t instanceof Fs)return new oe(t);if(t instanceof zi)return new he(t.o,t.key);throw e.Yl(`Unsupported field value: ${ht(t)}`)}c_(t,e){return e.map((e,s)=>{const n=new Gi(Wi.Ul,t,At.pt);return this.t_(e,n.Jl(s))})}}function Ji(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof mt||t instanceof ft||t instanceof Fs||t instanceof zi||t instanceof Fi)}function Yi(t,e,s){if(!Ji(s)||!ot(s)){const n=ht(s);throw"an object"===n?e.Yl(t+" a custom object"):e.Yl(t+" "+n)}}function Xi(t,e){if(e instanceof ki)return e.Fl;if("string"==typeof e)return Zi(t,e);{const e="Field path arguments must be of type string or FieldPath.";throw new L(x.D,`Function ${t}() called with invalid data. ${e}`)}}function Zi(t,e){try{return function(t){if(t.search(Ni)>=0)throw new L(x.D,`Invalid field path (${t}). Paths must not contain `+"'~', '*', '/', '[', or ']'");try{return new ki(...t.split("."))}catch(e){throw new L(x.D,`Invalid field path (${t}). Paths must not be empty, `+"begin with '.', end with '.', or contain '..'")}}(e).Fl}catch(e){const s=tr(e);throw new L(x.D,`Function ${t}() called with invalid data. ${s}`)}}function tr(t){return t instanceof Error?t.message:t.toString()}const er="ExponentialBackoff",sr=1e3,nr=1.5,ir=6e4;class rr{constructor(t,e,s=sr,n=nr,i=ir){this.gu=t,this.sh=e,this.l_=s,this.__=n,this.d_=i,this.f_=0,this.m_=null,this.T_=Date.now(),this.reset()}reset(){this.f_=0}E_(){this.f_=this.d_}w_(t){this.cancel();const e=Math.floor(this.f_+this.I_()),s=Math.max(0,Date.now()-this.T_),n=Math.max(0,e-s);this.f_>0&&R(er,`Backing off for ${n} ms `+`(base delay: ${this.f_} ms, `+`delay with jitter: ${e} ms, `+`last attempt: ${s} ms ago)`),this.m_=this.gu.ph(this.sh,n,()=>(this.T_=Date.now(),t())),this.f_*=this.__,this.f_<this.l_&&(this.f_=this.l_),this.f_>this.d_&&(this.f_=this.d_)}cancel(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}I_(){return(Math.random()-.5)*this.f_}}const or="PersistentStream";var hr,ar;(ar=hr||(hr={}))[ar.R_=0]="__PRIVATE_Initial",ar[ar.A_=1]="__PRIVATE_Starting",ar[ar.P_=2]="__PRIVATE_Open",ar[ar.Error=3]="Error",ar[ar.V_=4]="__PRIVATE_Backoff";const ur=6e4;class cr{constructor(t,e,s,n,i,r){this.gu=t,this.p_=s,this.g_=n,this.y_=i,this.listener=r,this.state=hr.R_,this.b_=0,this.v_=null,this.stream=null,this.S_=new rr(t,e)}D_(){return this.state===hr.A_||this.state===hr.P_||this.state===hr.V_}C_(){return this.state===hr.P_}start(){this.state!==hr.Error?(p(this.state===hr.R_,"Already started"),this.auth()):this.k_()}async stop(){this.D_()&&await this.close(hr.R_)}N_(){p(!this.D_(),"Can only inhibit backoff in a stopped state"),this.state=hr.R_,this.S_.reset()}F_(){this.C_()&&null===this.v_&&(this.v_=this.gu.ph(this.p_,ur,()=>this.M_()))}x_(t){this.L_(),this.stream.send(t)}async M_(){if(this.C_())return this.close(hr.R_)}L_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(t,e){p(this.D_(),"Only started streams should be closed."),p(t===hr.Error||Ie(e),"Can't provide an error when not in an error state."),this.L_(),this.S_.cancel(),this.b_++,t!==hr.Error?this.S_.reset():e&&e.code===x.F?(A(e.toString()),A("Using maximum backoff delay to prevent overloading the backend."),this.S_.E_()):e&&e.code===x.P&&this.y_.j(),null!==this.stream&&(this.q_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.O_(e)}q_(){}auth(){p(this.state===hr.R_,"Must be in initial state to auth"),this.state=hr.A_;const t=this.B_(this.b_),e=this.b_;this.y_.getToken().then(t=>{this.b_===e&&this.U_(t)},e=>{t(()=>{const t=new L(x.S,"Fetching auth token failed: "+e.message);return this.Q_(t)})})}U_(t){p(this.state===hr.A_,"Trying to start stream in a non-starting state");const e=this.B_(this.b_);this.stream=this.W_(t),this.stream.j_(()=>{e(()=>(p(this.state===hr.A_,"Expected stream to be in state Starting, but was "+this.state),this.state=hr.P_,this.listener.j_()))}),this.stream.O_(t=>{e(()=>this.Q_(t))}),this.stream.onMessage(t=>{e(()=>this.onMessage(t))})}k_(){p(this.state===hr.Error,"Should only perform backoff when in Error state"),this.state=hr.V_,this.S_.w_(async()=>{p(this.state===hr.V_,"Backoff elapsed but state is now: "+this.state),this.state=hr.R_,this.start(),p(this.D_(),"PersistentStream should have started")})}Q_(t){return p(this.D_(),"Can't handle server close on non-started stream"),R(or,`close with error: ${t}`),this.stream=null,this.close(hr.Error,t)}B_(t){return e=>{this.gu.lh(()=>this.b_===t?e():(R(or,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class lr extends cr{constructor(t,e,s,n,i){super(t,Hs.zo,Hs.Go,e,s,i),this.serializer=n}W_(t){return this.g_.K_("Listen",t)}onMessage(t){this.S_.reset();const e=this.serializer.Ki(t),s=this.serializer.zi(t);return this.listener.G_(e,s)}z_(t){const e={};e.database=this.serializer.Ci,e.addTarget=this.serializer.ks(t);const s=this.serializer.Tr(t);s&&(e.labels=s),this.x_(e)}H_(t){const e={};e.database=this.serializer.Ci,e.removeTarget=t,this.x_(e)}}class _r extends cr{constructor(t,e,s,n,i){super(t,Hs.Jo,Hs.Ho,e,s,i),this.serializer=n,this.J_=!1,this.lastStreamToken=Ds()}get Y_(){return this.J_}start(){this.J_=!1,super.start()}q_(){this.J_&&this.X_([])}W_(t){return this.g_.K_("Write",t)}onMessage(t){if(p(!!t.streamToken,"Got a write response without a stream token"),this.lastStreamToken=t.streamToken,this.J_){this.S_.reset();const e=this.serializer.ir(t.writeResults,t.commitTime),s=this.serializer.fromVersion(t.commitTime);return this.listener.Z_(s,e)}return p(!t.writeResults||0===t.writeResults.length,"Got mutation results for handshake"),this.J_=!0,this.listener.td()}ed(){p(this.C_(),"Writing handshake requires an opened stream"),p(!this.J_,"Handshake already completed");const t={};t.database=this.serializer.Ci,this.x_(t)}X_(t){p(this.C_(),"Writing mutations requires an opened stream"),p(this.J_,"Handshake must be complete before writing mutations"),p(this.lastStreamToken.length>0,"Trying to write mutation without a token");const e={streamToken:this.lastStreamToken,writes:t.map(t=>this.serializer.Hi(t))};this.x_(e)}}class dr{constructor(t,e,s,n){this.gu=t,this.g_=e,this.credentials=s,this.serializer=n}sd(t){return new _r(this.gu,this.g_,this.credentials,this.serializer,t)}nd(t){return new lr(this.gu,this.g_,this.credentials,this.serializer,t)}commit(t){const e={database:this.serializer.Ci,writes:t.map(t=>this.serializer.Hi(t))};return this.rd("Commit",e).then(t=>this.serializer.ir(t.writeResults,t.commitTime))}od(t){const e={database:this.serializer.Ci,documents:t.map(t=>this.serializer.yi(t))};return this.hd("BatchGetDocuments",e).then(e=>{let s=ze();e.forEach(t=>{const e=this.serializer.Qi(t);s=s.Nt(e.key,e)});const n=[];return t.forEach(t=>{const e=s.get(t);p(!!e,"Missing entity in write response for "+t),n.push(e)}),n})}rd(t,e){return this.credentials.getToken().then(s=>this.g_.rd(t,e,s)).catch(t=>{throw t.code===x.P&&this.credentials.j(),t})}hd(t,e){return this.credentials.getToken().then(s=>this.g_.hd(t,e,s)).catch(t=>{throw t.code===x.P&&this.credentials.j(),t})}}class fr{constructor(t){this.ad=t,this.ud=Ze(),this.mutations=[],this.ld=!1,this._d=null,this.dd=new Set}async od(t){if(this.fd(),this.mutations.length>0)throw new L(x.D,"Firestore transactions require all reads to be executed before all writes.");const e=await this.ad.od(t);return e.forEach(t=>{t instanceof de||t instanceof _e?this.md(t):V("Document in a transaction was a "+t.constructor.name)}),e}set(t,e){this.write(e.ql(t,this.be(t))),this.dd.add(t)}update(t,e){try{this.write(e.ql(t,this.Td(t)))}catch(t){this._d=t}this.dd.add(t)}delete(t){this.write([new Gt(t,this.be(t))]),this.dd.add(t)}async commit(){if(this.fd(),this._d)throw this._d;let t=this.ud;this.mutations.forEach(e=>{t=t.remove(e.key)}),t.forEach((t,e)=>{this.mutations.push(new zt(t,this.be(t)))}),await this.ad.commit(this.mutations),this.ld=!0}md(t){let e;if(t instanceof _e)e=t.version;else{if(!(t instanceof de))throw V("Document in a transaction was a "+t.constructor.name);e=Tt.ht()}const s=this.ud.get(t.key);if(null!==s){if(!e.isEqual(s))throw new L(x.M,"Document version changed between two reads.")}else this.ud=this.ud.Nt(t.key,e)}be(t){const e=this.ud.get(t);return!this.dd.has(t)&&e?Ut.updateTime(e):Ut.NONE}Td(t){const e=this.ud.get(t);if(!this.dd.has(t)&&e){if(e.isEqual(Tt.ht()))throw new L(x.D,"Can't update a document that doesn't exist.");return Ut.updateTime(e)}return Ut.exists(!0)}write(t){this.fd(),this.mutations=this.mutations.concat(t)}fd(){p(!this.ld,"A transaction object cannot be used after its update callback has been invoked.")}}const mr="OnlineStateTracker",Tr=1,Er=1e4;class wr{constructor(t,e){this.eh=t,this.Ed=e,this.state=k.l,this.wd=0,this.Id=null,this.Rd=!0}Ad(){0===this.wd&&(this.Pd(k.l),p(null===this.Id,"onlineStateTimer shouldn't be started yet"),this.Id=this.eh.ph(Hs.Yo,Er,()=>(this.Id=null,p(this.state===k.l,"Timer should be canceled if we transitioned to a different state."),this.Vd(`Backend didn't respond within ${Er/1e3} `+"seconds."),this.Pd(k.m),Promise.resolve())))}pd(t){this.state===k._?(this.Pd(k.l),p(0===this.wd,"watchStreamFailures must be 0"),p(null===this.Id,"onlineStateTimer must be null")):(this.wd++,this.wd>=Tr&&(this.gd(),this.Vd(`Connection failed ${Tr} `+`times. Most recent error: ${t.toString()}`),this.Pd(k.m)))}set(t){this.gd(),this.wd=0,t===k._&&(this.Rd=!1),this.Pd(t)}Pd(t){t!==this.state&&(this.state=t,this.Ed(t))}Vd(t){const e=`Could not reach Cloud Firestore backend. ${t}\n`+"This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.Rd?(A(e),this.Rd=!1):R(mr,e)}gd(){null!==this.Id&&(this.Id.cancel(),this.Id=null)}}const Ir="RemoteStore",Rr=10;class Ar{constructor(t,e,s,n,i){this.Gc=t,this.ad=e,this.yd=[],this.bd={},this.vd=null,this.networkEnabled=!1,this.isPrimary=!1,this.Sd=i,this.Sd.Dd(t=>{s.lh(async()=>{this.Cd()&&(R(Ir,"Restarting streams for network reachability change."),await this.kd())})}),this.Nd=new wr(s,n),this.Fd=this.ad.nd({j_:this.$d.bind(this),O_:this.Md.bind(this),G_:this.xd.bind(this)}),this.Ld=this.ad.sd({j_:this.qd.bind(this),O_:this.Od.bind(this),td:this.Bd.bind(this),Z_:this.Z_.bind(this)})}start(){return this.enableNetwork()}async enableNetwork(){this.networkEnabled=!0,this.Cd()&&(this.Ld.lastStreamToken=await this.Gc.ia(),this.Ud()?this.Qd():this.Nd.set(k.l),await this.Wd())}async disableNetwork(){this.networkEnabled=!1,await this.jd(),this.Nd.set(k.m)}async jd(){await this.Ld.stop(),await this.Fd.stop(),this.yd.length>0&&(R(Ir,`Stopping write stream with ${this.yd.length} pending writes`),this.yd=[]),this.Kd()}async oc(){R(Ir,"RemoteStore shutting down."),this.networkEnabled=!1,await this.jd(),this.Sd.oc(),this.Nd.set(k.l)}listen(t){W(this.bd,t.targetId)||(this.bd[t.targetId]=t,this.Ud()?this.Qd():this.Fd.C_()&&this.Gd(t))}zd(t){p(W(this.bd,t),`unlisten called on target no currently watched: ${t}`),delete this.bd[t],this.Fd.C_()&&this.Hd(t),z(this.bd)&&(this.Fd.C_()?this.Fd.F_():this.Cd()&&this.Nd.set(k.l))}_i(t){return this.bd[t]||null}li(t){return this.Jd.li(t)}Gd(t){this.vd.Qn(t.targetId),this.Fd.z_(t)}Hd(t){this.vd.Qn(t),this.Fd.H_(t)}Qd(){p(this.Ud(),"startWatchStream() called when shouldStartWatchStream() is false."),this.vd=new Rs(this),this.Fd.start(),this.Nd.Ad()}Ud(){return this.Cd()&&!this.Fd.D_()&&!z(this.bd)}Cd(){return this.isPrimary&&this.networkEnabled}Kd(){this.vd=null}async $d(){K(this.bd,(t,e)=>{this.Gd(e)})}async Md(t){void 0===t&&p(!this.Ud(),"Watch stream was stopped gracefully while still needed."),this.Kd(),this.Ud()?(this.Nd.pd(t),this.Qd()):this.Nd.set(k.l)}async xd(t,e){if(this.Nd.set(k._),t instanceof Es&&t.state===us.nn&&t.cause)return this.Yd(t);if(t instanceof ms?this.vd.Yn(t):t instanceof Ts?this.vd.ri(t):(p(t instanceof Es,"Expected watchChange to be an instance of WatchTargetChange"),this.vd.ti(t)),!e.isEqual(Tt.MIN)){const t=await this.Gc.ka();e.u(t)>=0&&await this.Xd(e)}}Xd(t){p(!t.isEqual(Tt.MIN),"Can't raise event for unknown SnapshotVersion");const e=this.vd.ai(t);return K(e.mn,(e,s)=>{if(s.resumeToken.length>0){const n=this.bd[e];n&&(this.bd[e]=n.Ys(s.resumeToken,t))}}),e.Tn.forEach(t=>{const e=this.bd[t];if(!e)return;this.bd[t]=e.Ys(Ds(),e.Hs),this.Hd(t);const s=new Ue(e.target,t,Le.Ks,e.sequenceNumber);this.Gd(s)}),this.Jd.Al(e)}Yd(t){p(!!t.cause,"Handling target error without a cause");const e=t.cause;let s=Promise.resolve();return t.targetIds.forEach(t=>{s=s.then(async()=>{if(W(this.bd,t))return delete this.bd[t],this.vd.removeTarget(t),this.Jd.Zd(t,e)})}),s}async Wd(){if(this.tf()){const t=this.yd.length>0?this.yd[this.yd.length-1].batchId:xs,e=await this.Gc.gl(t);null===e?0===this.yd.length&&this.Ld.F_():(this.ef(e),await this.Wd())}this.sf()&&this.nf()}tf(){return this.Cd()&&this.yd.length<Rr}if(){return this.yd.length}ef(t){p(this.tf(),"addToWritePipeline called when pipeline is full"),this.yd.push(t),this.Ld.C_()&&this.Ld.Y_&&this.Ld.X_(t.mutations)}sf(){return this.Cd()&&!this.Ld.D_()&&this.yd.length>0}nf(){p(this.sf(),"startWriteStream() called when shouldStartWriteStream() is false."),this.Ld.start()}async qd(){this.Ld.ed()}Bd(){return this.Gc.ra(this.Ld.lastStreamToken).then(()=>{for(const t of this.yd)this.Ld.X_(t.mutations)}).catch(Ei)}Z_(t,e){p(this.yd.length>0,"Got result for empty write pipeline");const s=this.yd.shift(),n=qs.from(s,t,e,this.Ld.lastStreamToken);return this.Jd.rf(n).then(()=>this.Wd())}async Od(t){if(void 0===t&&p(!this.sf(),"Write stream was stopped gracefully while still needed."),t&&this.yd.length>0){let e;return(e=this.Ld.Y_?this.hf(t):this.af(t)).then(()=>{this.sf()&&this.nf()})}}async af(t){if(We(t.code))return R(Ir,"RemoteStore error before completed handshake; resetting stream token: ",this.Ld.lastStreamToken),this.Ld.lastStreamToken=Ds(),this.Gc.ra(Ds()).catch(Ei)}async hf(t){if(We(e=t.code)&&e!==x.M){const e=this.yd.shift();return this.Ld.N_(),this.Jd.uf(e.batchId,t).then(()=>this.Wd())}var e}cf(){return new fr(this.ad)}async kd(){this.networkEnabled=!1,await this.jd(),this.Nd.set(k.l),await this.enableNetwork()}async lf(){this.Cd()&&(R(Ir,"RemoteStore restarting streams for new credential"),await this.kd())}async _f(t){this.isPrimary=t,t&&this.networkEnabled?await this.enableNetwork():t||(await this.jd(),this.Nd.set(k.l))}}const Pr="firestore_clients";function Vr(t,e){return p(-1===e.indexOf("_"),`Client key cannot contain '_', but was '${e}'`),`${Pr}_${t}_${e}`}const pr="firestore_mutations";function gr(t,e,s){let n=`${pr}_${t}_${s}`;return e.R()&&(n+=`_${e.uid}`),n}const yr="firestore_targets";function br(t,e){return`${yr}_${t}_${e}`}const vr="firestore_online_state";const Sr="firestore_sequence_number";const Dr="SharedClientState";class Cr{constructor(t,e,s,n){this.user=t,this.batchId=e,this.state=s,this.error=n,p(void 0!==n==("rejected"===s),"MutationMetadata must contain an error iff state is 'rejected'")}static df(t,e,s){const n=JSON.parse(s);let i="object"==typeof n&&-1!==["pending","acknowledged","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error),r=void 0;return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new L(n.error.code,n.error.message)),i?new Cr(t,e,n.state,r):(A(Dr,`Failed to parse mutation state for ID '${e}': ${s}`),null)}ff(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class kr{constructor(t,e,s){this.targetId=t,this.state=e,this.error=s,p(void 0!==s==("rejected"===e),"QueryTargetMetadata must contain an error iff state is 'rejected'")}static df(t,e){const s=JSON.parse(e);let n="object"==typeof s&&-1!==["not-current","current","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error),i=void 0;return n&&s.error&&(n="string"==typeof s.error.message&&"string"==typeof s.error.code)&&(i=new L(s.error.code,s.error.message)),n?new kr(t,s.state,i):(A(Dr,`Failed to parse target state for ID '${t}': ${e}`),null)}ff(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Nr{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static df(t,e){const s=JSON.parse(e);let n="object"==typeof s&&s.activeTargetIds instanceof Array,i=ns();for(let t=0;n&&t<s.activeTargetIds.length;++t)n=Re(s.activeTargetIds[t]),i=i.add(s.activeTargetIds[t]);return n?new Nr(t,i):(A(Dr,`Failed to parse client data for instance '${t}': ${e}`),null)}}class Fr{constructor(t,e){this.clientId=t,this.onlineState=e}static df(t){const e=JSON.parse(t);return"object"==typeof e&&e.onlineState in k&&"string"==typeof e.clientId?new Fr(e.clientId,k[e.onlineState]):(A(Dr,`Failed to parse online state: ${t}`),null)}}class $r{constructor(){this.activeTargetIds=ns()}mf(t){this.activeTargetIds=this.activeTargetIds.add(t)}Tf(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ff(){const t={activeTargetIds:this.activeTargetIds.At(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Mr{constructor(t,e,s,n,i){if(this.gu=t,this.platform=e,this.persistenceKey=s,this.Ef=n,this.Jd=null,this.Ed=null,this.Bo=null,this.wf={},this.If=this.Rf.bind(this),this.qu=!1,this.Af=[],!Mr.Nh(this.platform))throw new L(x.q,"LocalStorage is not available on this platform.");const r=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=i,this.Pf=Vr(this.persistenceKey,this.Ef),this.Vf=function(t){return`${Sr}_${t}`}(this.persistenceKey),this.wf[this.Ef]=new $r,this.pf=new RegExp(`^${Pr}_${r}_([^_]*)$`),this.gf=new RegExp(`^${pr}_${r}_(\\d+)(?:_(.*))?$`),this.yf=new RegExp(`^${yr}_${r}_(\\d+)$`),this.bf=function(t){return`${vr}_${t}`}(this.persistenceKey),this.platform.window.addEventListener("storage",this.If)}static Nh(t){return!(!t.window||null==t.window.localStorage)}async start(){p(!this.qu,"WebStorageSharedClientState already started"),p(null!==this.Jd,"syncEngine property must be set before calling start()"),p(null!==this.Ed,"onlineStateHandler property must be set before calling start()");const t=await this.Jd.lc();for(const e of t){if(e===this.Ef)continue;const t=this.getItem(Vr(this.persistenceKey,e));if(t){const s=Nr.df(e,t);s&&(this.wf[s.clientId]=s)}}this.vf();const e=this.storage.getItem(this.bf);if(e){const t=this.Sf(e);t&&this.Df(t)}for(const t of this.Af)this.Rf(t);this.Af=[],this.platform.window.addEventListener("unload",()=>this.oc()),this.qu=!0}Wo(t){this.setItem(this.Vf,JSON.stringify(t))}Cf(){let t=ns();return G(this.wf,(e,s)=>{t=t.ue(s.activeTargetIds)}),t}kf(t){for(const e in this.wf)if(this.wf.hasOwnProperty(e)&&this.wf[e].activeTargetIds.has(t))return!0;return!1}Nf(t){this.Ff(t,"pending")}$f(t,e,s){this.Ff(t,e,s),this.Mf(t)}xf(t){let e="not-current";if(this.kf(t)){const s=this.storage.getItem(br(this.persistenceKey,t));if(s){const n=kr.df(t,s);n&&(e=n.state)}}return this.Lf.mf(t),this.vf(),e}qf(t){this.Lf.Tf(t),this.vf()}Of(t){return this.Lf.activeTargetIds.has(t)}Bf(t){this.removeItem(br(this.persistenceKey,t))}Uf(t,e,s){this.Qf(t,e,s)}dl(t,e,s){e.forEach(t=>{this.Mf(t)}),this.currentUser=t,s.forEach(t=>{this.Nf(t)})}Wf(t){this.jf(t)}oc(){this.qu&&(this.platform.window.removeEventListener("storage",this.If),this.removeItem(this.Pf),this.qu=!1)}getItem(t){const e=this.storage.getItem(t);return R(Dr,"READ",t,e),e}setItem(t,e){R(Dr,"SET",t,e),this.storage.setItem(t,e)}removeItem(t){R(Dr,"REMOVE",t),this.storage.removeItem(t)}Rf(t){if(t.storageArea===this.storage){if(R(Dr,"EVENT",t.key,t.newValue),t.key===this.Pf)return void A("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.gu.lh(async()=>{if(this.qu){if(null!==t.key)if(this.pf.test(t.key)){if(null==t.newValue){const e=this.Kf(t.key);return this.Gf(e,null)}{const e=this.zf(t.key,t.newValue);if(e)return this.Gf(e.clientId,e)}}else if(this.gf.test(t.key)){if(null!==t.newValue){const e=this.Hf(t.key,t.newValue);if(e)return this.Jf(e)}}else if(this.yf.test(t.key)){if(null!==t.newValue){const e=this.Yf(t.key,t.newValue);if(e)return this.Xf(e)}}else if(t.key===this.bf){if(null!==t.newValue){const e=this.Sf(t.newValue);if(e)return this.Df(e)}}else if(t.key===this.Vf){p(!!this.Bo,"Missing sequenceNumberHandler");const e=function(t){let e=Gs.jo;if(null!=t)try{const s=JSON.parse(t);p("number"==typeof s,"Found non-numeric sequence number"),e=s}catch(t){A(Dr,"Failed to read sequence number from WebStorage",t)}return e}(t.newValue);e!==Gs.jo&&this.Bo(e)}}else this.Af.push(t)})}}get Lf(){return this.wf[this.Ef]}vf(){this.setItem(this.Pf,this.Lf.ff())}Ff(t,e,s){const n=new Cr(this.currentUser,t,e,s),i=gr(this.persistenceKey,this.currentUser,t);this.setItem(i,n.ff())}Mf(t){const e=gr(this.persistenceKey,this.currentUser,t);this.removeItem(e)}jf(t){const e={clientId:this.Ef,onlineState:k[t]};this.storage.setItem(this.bf,JSON.stringify(e))}Qf(t,e,s){const n=br(this.persistenceKey,t),i=new kr(t,e,s);this.setItem(n,i.ff())}Kf(t){const e=this.pf.exec(t);return e?e[1]:null}zf(t,e){const s=this.Kf(t);return p(null!==s,`Cannot parse client state key '${t}'`),Nr.df(s,e)}Hf(t,e){const s=this.gf.exec(t);p(null!==s,`Cannot parse mutation batch key '${t}'`);const n=Number(s[1]),i=void 0!==s[2]?s[2]:null;return Cr.df(new M(i),n,e)}Yf(t,e){const s=this.yf.exec(t);p(null!==s,`Cannot parse query target key '${t}'`);const n=Number(s[1]);return kr.df(n,e)}Sf(t){return Fr.df(t)}async Jf(t){if(t.user.uid===this.currentUser.uid)return this.Jd.Zf(t.batchId,t.state,t.error);R(Dr,`Ignoring mutation for non-active user ${t.user.uid}`)}Xf(t){return this.Jd.tm(t.targetId,t.state,t.error)}Gf(t,e){const s=this.Cf();e?this.wf[t]=e:delete this.wf[t];const n=this.Cf(),i=[],r=[];return n.forEach(async t=>{s.has(t)||i.push(t)}),s.forEach(async t=>{n.has(t)||r.push(t)}),this.Jd.em(i,r)}Df(t){this.wf[t.clientId]&&this.Ed(t.onlineState)}}class xr{constructor(){this.sm=new $r,this.nm={},this.Jd=null,this.Ed=null,this.Bo=null}Nf(t){}$f(t,e,s){}xf(t){return this.sm.mf(t),this.nm[t]||"not-current"}Uf(t,e,s){this.nm[t]=e}qf(t){this.sm.Tf(t)}Of(t){return this.sm.activeTargetIds.has(t)}Bf(t){delete this.nm[t]}Cf(){return this.sm.activeTargetIds}kf(t){return this.sm.activeTargetIds.has(t)}start(){return this.sm=new $r,Promise.resolve()}dl(t,e,s){}Wf(t){}oc(){}Wo(t){}}class Lr{constructor(t){this.key=t}}class qr{constructor(t){this.key=t}}class Or{constructor(t,e){this.query=t,this.im=e,this.rm=null,this.An=!1,this.om=es(),this.ln=es(),this.hm=new is(t.Ns.bind(t))}get am(){return this.im}um(t,e){const s=e?e.cm:new ls,n=e?e.hm:this.hm;let i=e?e.ln:this.ln,r=n,o=!1;const h=this.query.Ls()&&n.size===this.query.limit?n.last():null,a=this.query.qs()&&n.size===this.query.limit?n.first():null;if(t.Lt((t,e)=>{const u=n.get(t);let c=e instanceof _e?e:null;c&&(p(t.isEqual(c.key),"Mismatching keys found in document changes: "+t+" != "+c.key),c=this.query.matches(c)?c:null);const l=!!u&&this.ln.has(u.key),_=!!c&&(c.ve||this.ln.has(c.key)&&c.hasCommittedMutations);let d=!1;if(u&&c){u.data().isEqual(c.data())?l!==_&&(s.track({type:rs.rn,doc:c}),d=!0):this.lm(u,c)||(s.track({type:rs.in,doc:c}),d=!0,(h&&this.query.Ns(c,h)>0||a&&this.query.Ns(c,a)<0)&&(o=!0))}else!u&&c?(s.track({type:rs.sn,doc:c}),d=!0):u&&!c&&(s.track({type:rs.nn,doc:u}),d=!0,(h||a)&&(o=!0));d&&(c?(r=r.add(c),i=_?i.add(t):i.delete(t)):(r=r.delete(t),i=i.delete(t)))}),this.query.Ls()||this.query.qs())for(;r.size>this.query.limit;){const t=this.query.Ls()?r.last():r.first();r=r.delete(t.key),i=i.delete(t.key),s.track({type:rs.nn,doc:t})}return p(!o||!e,"View was refilled using docs that themselves needed refilling."),{hm:r,cm:s,_m:o,ln:i}}lm(t,e){return t.ve&&e.hasCommittedMutations&&!e.ve}To(t,e,s){p(!t._m,"Cannot apply changes that need a refill");const n=this.hm;this.hm=t.hm,this.ln=t.ln;const i=t.cm.un();i.sort((t,e)=>(function(t,e){const s=t=>{switch(t){case rs.sn:return 1;case rs.in:case rs.rn:return 2;case rs.nn:return 0;default:return V("Unknown ChangeType: "+t)}};return s(t)-s(e)})(t.type,e.type)||this.query.Ns(t.doc,e.doc)),this.dm(s);const r=e?this.fm():[],o=0===this.om.size&&this.An?hs.hn:hs.on,h=o!==this.rm;if(this.rm=o,0!==i.length||h){return{snapshot:new _s(this.query,t.hm,n,i,t.ln,o===hs.on,h,!1),mm:r}}return{mm:r}}Tm(t){return this.An&&t===k.m?(this.An=!1,this.To({hm:this.hm,cm:new ls,ln:this.ln,_m:!1},!1)):{mm:[]}}Em(t){return!this.im.has(t)&&(!!this.hm.has(t)&&!this.hm.get(t).ve)}dm(t){t&&(t.Pn.forEach(t=>this.im=this.im.add(t)),t.Vn.forEach(t=>p(this.im.has(t),`Modified document ${t} not found in view.`)),t.pn.forEach(t=>this.im=this.im.delete(t)),this.An=t.An)}fm(){if(!this.An)return[];const t=this.om;this.om=es(),this.hm.forEach(t=>{this.Em(t.key)&&(this.om=this.om.add(t.key))});const e=[];return t.forEach(t=>{this.om.has(t)||e.push(new qr(t))}),this.om.forEach(s=>{t.has(s)||e.push(new Lr(s))}),e}wm(t){this.im=t.Dl,this.om=es();const e=this.um(t.documents);return this.To(e,!0)}Im(){return _s.fn(this.query,this.hm,this.ln,this.rm===hs.on)}}const Br=5;class Ur{constructor(t,e,s,n){this.eh=t,this.Rm=e,this.updateFunction=s,this.rh=n,this.Am=Br,this.S_=new rr(this.eh,Hs.th)}Pm(){this.Vm()}Vm(){this.S_.w_(async()=>{const t=this.Rm.cf(),e=this.pm(t);e&&e.then(e=>{this.eh.lh(()=>t.commit().then(()=>{this.rh.resolve(e)}).catch(t=>{this.gm(t)}))}).catch(t=>{this.gm(t)})})}pm(t){try{const e=this.updateFunction(t);return!Ie(e)&&e.catch&&e.then?e:(this.rh.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.rh.reject(t),null}}gm(t){this.Am>0&&this.ym(t)?(this.Am-=1,this.eh.lh(()=>(this.Vm(),Promise.resolve()))):this.rh.reject(t)}ym(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!We(e)}return!1}}const Qr="SyncEngine";class Wr{constructor(t,e,s){this.query=t,this.targetId=e,this.view=s}}class jr{constructor(t){this.key=t,this.bm=!1}}class Kr{constructor(t,e,s,n){this.Gc=t,this.Rm=e,this.vm=s,this.currentUser=n,this.Sm=null,this.Dm=new Ms(t=>t.canonicalId()),this.Cm={},this.km=new Vt(Pt.lt),this.Nm={},this.Fm=new Os,this.$m={},this.Mm=new Map,this.xm=bn.ba(),this.isPrimary=void 0,this.onlineState=k.l}get Lm(){return!0===this.isPrimary}subscribe(t){p(null!==t,"SyncEngine listener cannot be null"),p(null===this.Sm,"SyncEngine already has a subscriber."),this.Sm=t}async listen(t){let e,s;this.qm("listen()");const n=this.Dm.get(t);if(n)e=n.targetId,this.vm.xf(e),s=n.view.Im();else{const n=await this.Gc.bl(t.ks()),i=this.vm.xf(n.targetId);e=n.targetId,s=await this.Om(t,e,"current"===i),this.isPrimary&&this.Rm.listen(n)}return this.Sm.G_([s]),e}async Om(t,e,s){const n=await this.Gc.Sl(t,!0),i=new Or(t,n.Dl),r=i.um(n.documents),o=fs.Rn(e,s&&this.onlineState!==k.m),h=i.To(r,!0===this.isPrimary,o);p(0===h.mm.length,"View returned limbo docs before target ack from the server."),p(!!h.snapshot,"applyChanges for new view should always return a snapshot");const a=new Wr(t,e,i);return this.Dm.set(t,a),this.Cm[e]||(this.Cm[e]=[]),this.Cm[e].push(t),h.snapshot}async Bm(t){const e=await this.Gc.Sl(t.query,!0),s=t.view.wm(e);return this.isPrimary&&this.Um(t.targetId,s.mm),s}async zd(t){this.qm("unlisten()");const e=this.Dm.get(t);p(!!e,"Trying to unlisten on query not found:"+t);const s=this.Cm[e.targetId];if(s.length>1)return this.Cm[e.targetId]=s.filter(e=>!e.isEqual(t)),void this.Dm.delete(t);if(this.isPrimary){this.vm.qf(e.targetId),this.vm.kf(e.targetId)||await this.Gc.vl(e.targetId,!1).then(()=>{this.vm.Bf(e.targetId),this.Rm.zd(e.targetId),this.Qm(e.targetId)}).catch(Ei)}else this.Qm(e.targetId),await this.Gc.vl(e.targetId,!0)}async write(t,e){this.qm("write()");const s=await this.Gc.El(t);this.vm.Nf(s.batchId),this.Wm(s.batchId,e),await this.jm(s.ho),await this.Rm.Wd()}runTransaction(t,e,s){new Ur(t,this.Rm,e,s).Pm()}async Al(t){this.qm("applyRemoteEvent()");try{const e=await this.Gc.Al(t);G(t.mn,(t,e)=>{const s=this.Nm[Number(t)];s&&(p(e.Pn.size+e.Vn.size+e.pn.size<=1,"Limbo resolution for single document contains multiple changes."),e.Pn.size>0?s.bm=!0:e.Vn.size>0?p(s.bm,"Received change for limbo target document without add."):e.pn.size>0&&(p(s.bm,"Received remove for limbo target document without add."),s.bm=!1))}),await this.jm(e,t)}catch(t){await Ei(t)}}Tm(t,e){if(this.isPrimary&&e===F.T||!this.isPrimary&&e===F.I){this.qm("applyOnlineStateChange()");const e=[];this.Dm.forEach((s,n)=>{const i=n.view.Tm(t);p(0===i.mm.length,"OnlineState should not affect limbo documents."),i.snapshot&&e.push(i.snapshot)}),this.Sm.Km(t),this.Sm.G_(e),this.onlineState=t,this.isPrimary&&this.vm.Wf(t)}}async Zd(t,e){this.qm("rejectListens()"),this.vm.Uf(t,"rejected",e);const s=this.Nm[t],n=s&&s.key;if(n){this.km=this.km.remove(n),delete this.Nm[t];let e=new Vt(Pt.lt);e=e.Nt(n,new de(n,Tt.ht()));const s=es().add(n),i=new ds(Tt.MIN,{},new yt(y),e,s);return this.Al(i)}await this.Gc.vl(t,!1).then(()=>this.Qm(t,e)).catch(Ei)}async Zf(t,e,s){this.qm("applyBatchState()");const n=await this.Gc.wl(t);null!==n?("pending"===e?await this.Rm.Wd():"acknowledged"===e||"rejected"===e?(this.Gm(t,s||null),this.Gc.kl(t)):V(`Unknown batchState: ${e}`),await this.jm(n)):R(Qr,"Cannot apply mutation batch with id: "+t)}async rf(t){this.qm("applySuccessfulWrite()");const e=t.batch.batchId;this.Gm(e,null),this.zm(e);try{const s=await this.Gc.sa(t);this.vm.$f(e,"acknowledged"),await this.jm(s)}catch(t){await Ei(t)}}async uf(t,e){this.qm("rejectFailedWrite()"),this.Gm(t,e),this.zm(t);try{const s=await this.Gc.Rl(t);this.vm.$f(t,"rejected",e),await this.jm(s)}catch(e){await Ei(e)}}async Hm(t){this.Rm.Cd()||R(Qr,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");const e=await this.Gc.da();if(e===xs)return void t.resolve();const s=this.Mm.get(e)||[];s.push(t),this.Mm.set(e,s)}zm(t){(this.Mm.get(t)||[]).forEach(t=>{t.resolve()}),this.Mm.delete(t)}Jm(t){this.Mm.forEach(e=>{e.forEach(e=>{e.reject(new L(x.v,t))})}),this.Mm.clear()}Wm(t,e){let s=this.$m[this.currentUser.A()];s||(s=new Vt(y)),s=s.Nt(t,e),this.$m[this.currentUser.A()]=s}Gm(t,e){let s=this.$m[this.currentUser.A()];if(s){const n=s.get(t);n&&(p(t===s.Mt(),"Mutation callbacks processed out-of-order?"),e?n.reject(e):n.resolve(),s=s.remove(t)),this.$m[this.currentUser.A()]=s}}Qm(t,e=null){this.vm.qf(t),p(this.Cm[t]&&0!==this.Cm[t].length,`There are no queries mapped to target id ${t}`);for(const s of this.Cm[t])this.Dm.delete(s),e&&this.Sm.Ym(s,e);if(delete this.Cm[t],this.isPrimary){const e=this.Fm.zr(t);this.Fm.Kr(t),e.forEach(t=>{this.Fm.Hr(t)||this.Xm(t)})}}Xm(t){const e=this.km.get(t);null!==e&&(this.Rm.zd(e),this.km=this.km.remove(t),delete this.Nm[e])}Um(t,e){for(const s of e)if(s instanceof Lr)this.Fm.Br(s.key,t),this.Zm(s);else if(s instanceof qr){R(Qr,"Document no longer in limbo: "+s.key),this.Fm.Qr(s.key,t),this.Fm.Hr(s.key)||this.Xm(s.key)}else V("Unknown limbo change: "+JSON.stringify(s))}Zm(t){const e=t.key;if(!this.km.get(e)){R(Qr,"New document in limbo: "+e);const t=this.xm.next(),s=pe.Rs(e.path);this.Nm[t]=new jr(e),this.Rm.listen(new Ue(s.ks(),t,Le.Gs,Gs.jo)),this.km=this.km.Nt(e,t)}}tT(){return this.km}async jm(t,e){const s=[],n=[],i=[];this.Dm.forEach((r,o)=>{i.push(Promise.resolve().then(()=>{const e=o.view.um(t);return e._m?this.Gc.Sl(o.query,!1).then(({documents:t})=>o.view.um(t,e)):e}).then(t=>{const i=e&&e.mn[o.targetId],r=o.view.To(t,!0===this.isPrimary,i);if(this.Um(o.targetId,r.mm),r.snapshot){this.isPrimary&&this.vm.Uf(o.targetId,r.snapshot.fromCache?"not-current":"current"),s.push(r.snapshot);const t=Ks.Oo(o.targetId,r.snapshot);n.push(t)}}))}),await Promise.all(i),this.Sm.G_(s),await this.Gc.pl(n)}qm(t){p(null!==this.Sm,"Trying to call "+t+" before calling subscribe().")}async lf(t){const e=!this.currentUser.isEqual(t);if(this.currentUser=t,e){this.Jm("'waitForPendingWrites' promise is rejected due to a user change.");const e=await this.Gc.dl(t);this.vm.dl(t,e.ml,e.Tl),await this.jm(e.fl)}await this.Rm.lf()}async _f(t){if(!0===t&&!0!==this.isPrimary){this.isPrimary=!0,await this.Rm._f(!0);const t=this.vm.Cf(),e=await this.eT(t.At());for(const t of e)this.Rm.listen(t)}else if(!1===t&&!1!==this.isPrimary){this.isPrimary=!1;const t=[];let e=Promise.resolve();K(this.Cm,(s,n)=>{this.vm.Of(s)?t.push(s):e=e.then(()=>(this.Qm(s),this.Gc.vl(s,!0))),this.Rm.zd(s)}),await e,await this.eT(t),this.sT(),await this.Rm._f(!1)}}sT(){K(this.Nm,t=>{this.Rm.zd(t)}),this.Fm.Gr(),this.Nm=[],this.km=new Vt(Pt.lt)}async eT(t){const e=[],s=[];for(const n of t){let t;const i=this.Cm[n];if(i&&0!==i.length){await this.Gc.vl(n,!0),t=await this.Gc.bl(i[0].ks());for(const t of i){const e=this.Dm.get(t);p(!!e,`No query view found for ${t}`);const n=await this.Bm(e);n.snapshot&&s.push(n.snapshot)}}else{p(!0===this.isPrimary,"A secondary tab should never have an active target without an active query.");const e=await this.Gc.Nl(n);p(!!e,`Target for id ${n} not found`),t=await this.Gc.bl(e),await this.Om(this.nT(e),n,!1)}e.push(t)}return this.Sm.G_(s),e}nT(t){return new pe(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,Pe.ds,t.startAt,t.endAt)}lc(){return this.Gc.lc()}async tm(t,e,s){if(this.isPrimary)R(Qr,"Ignoring unexpected query state notification.");else if(this.Cm[t])switch(e){case"current":case"not-current":{const s=await this.Gc.ru(),n=ds.In(t,"current"===e);await this.jm(s,n);break}case"rejected":await this.Gc.vl(t,!0),this.Qm(t,s);break;default:V("Unexpected target state: "+e)}}async em(t,e){if(this.isPrimary){for(const e of t){p(!this.Cm[e],"Trying to add an already active target");const t=await this.Gc.Nl(e);p(!!t,`Query data for active target ${e} not found`);const s=await this.Gc.bl(t);await this.Om(this.nT(t),s.targetId,!1),this.Rm.listen(s)}for(const t of e)this.Cm[t]&&await this.Gc.vl(t,!1).then(()=>{this.Rm.zd(t),this.Qm(t)}).catch(Ei)}}enableNetwork(){return this.Gc.zu(!0),this.Rm.enableNetwork()}disableNetwork(){return this.Gc.zu(!1),this.Rm.disableNetwork()}li(t){const e=this.Nm[t];if(e&&e.bm)return es().add(e.key);{let e=es();const s=this.Cm[t];if(!s)return e;for(const t of s){const s=this.Dm.get(t);p(!!s,`No query view found for ${t}`),e=e.ue(s.view.am)}return e}}}class Gr{constructor(){this.iT=null,this.targetId=0,this.rT=[]}}class zr{constructor(t){this.Jd=t,this.oT=new Ms(t=>t.canonicalId()),this.onlineState=k.l,this.hT=new Set,this.Jd.subscribe(this)}listen(t){const e=t.query;let s=!1,n=this.oT.get(e);if(n||(s=!0,n=new Gr,this.oT.set(e,n)),n.rT.push(t),p(!t.Tm(this.onlineState),"applyOnlineStateChange() shouldn't raise an event for brand-new listeners."),n.iT){t.aT(n.iT)&&this.uT()}return s?this.Jd.listen(e).then(t=>(n.targetId=t,t)):Promise.resolve(n.targetId)}async zd(t){const e=t.query;let s=!1;const n=this.oT.get(e);if(n){const e=n.rT.indexOf(t);e>=0&&(n.rT.splice(e,1),s=0===n.rT.length)}if(s)return this.oT.delete(e),this.Jd.zd(e)}G_(t){let e=!1;for(const s of t){const t=s.query,n=this.oT.get(t);if(n){for(const t of n.rT)t.aT(s)&&(e=!0);n.iT=s}}e&&this.uT()}Ym(t,e){const s=this.oT.get(t);if(s)for(const t of s.rT)t.onError(e);this.oT.delete(t)}Km(t){this.onlineState=t;let e=!1;this.oT.forEach((s,n)=>{for(const s of n.rT)s.Tm(t)&&(e=!0)}),e&&this.uT()}cT(t){this.hT.add(t),t.next()}lT(t){this.hT.delete(t)}uT(){this.hT.forEach(t=>{t.next()})}}class Hr{constructor(t,e,s){this.query=t,this._T=e,this.dT=!1,this.fT=null,this.onlineState=k.l,this.options=s||{}}aT(t){if(p(t.docChanges.length>0||t._n,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){const e=[];for(const s of t.docChanges)s.type!==rs.rn&&e.push(s);t=new _s(t.query,t.docs,t.cn,e,t.ln,t.fromCache,t._n,!0)}let e=!1;return this.dT?this.mT(t)&&(this._T.next(t),e=!0):this.TT(t,this.onlineState)&&(this.ET(t),e=!0),this.fT=t,e}onError(t){this._T.error(t)}Tm(t){this.onlineState=t;let e=!1;return this.fT&&!this.dT&&this.TT(this.fT,t)&&(this.ET(this.fT),e=!0),e}TT(t,e){if(p(!this.dT,"Determining whether to raise first event but already had first event"),!t.fromCache)return!0;const s=e!==k.m;return this.options.wT&&s?(p(t.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!t.docs.Tt()||e===k.m}mT(t){if(t.docChanges.length>0)return!0;const e=this.fT&&this.fT.hasPendingWrites!==t.hasPendingWrites;return!(!t._n&&!e)&&!0===this.options.includeMetadataChanges}ET(t){p(!this.dT,"Trying to raise initial events for second time"),t=_s.fn(t.query,t.docs,t.ln,t.fromCache),this.dT=!0,this._T.next(t)}}class Jr{ll(t){this.IT=t}Co(t,e,s,n){return p(void 0!==this.IT,"setLocalDocumentsView() not called"),e.Cs()?this.RT(t,e):s.isEqual(Tt.MIN)?this.RT(t,e):this.IT.vo(t,n).next(i=>{const r=this.AT(e,i);return(e.Ls()||e.qs())&&this._m(e.Ts,r,n,s)?this.RT(t,e):(w()<=E.DEBUG&&R("IndexFreeQueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),e.toString()),this.IT.Co(t,e,s).next(t=>(r.forEach(e=>{t=t.Nt(e.key,e)}),t)))})}AT(t,e){let s=new yt((e,s)=>t.Ns(e,s));return e.forEach((e,n)=>{n instanceof _e&&t.matches(n)&&(s=s.add(n))}),s}_m(t,e,s,n){if(s.size!==e.size)return!0;const i=t===Pe.ds?e.last():e.first();return!!i&&(i.hasPendingWrites||i.version.u(n)>0)}RT(t,e){return w()<=E.DEBUG&&R("IndexFreeQueryEngine","Using full collection scan to execute query: %s",e.toString()),this.IT.Co(t,e,Tt.MIN)}}class Yr{constructor(t,e){this.Po=t,this.Xh=e,this.Ao=[],this.PT=1,this.lastStreamToken=Ds(),this.VT=new yt(Bs.os)}ea(t){return Us.resolve(0===this.Ao.length)}sa(t,e,s){const n=e.batchId,i=this.pT(n,"acknowledged");p(0===i,"Can only acknowledge the first batch in the mutation queue");const r=this.Ao[i];return p(n===r.batchId,"Queue ordering failure: expected batch "+n+", got batch "+r.batchId),this.lastStreamToken=s,Us.resolve()}ia(t){return Us.resolve(this.lastStreamToken)}ra(t,e){return this.lastStreamToken=e,Us.resolve()}oa(t,e,s,n){p(0!==n.length,"Mutation batches should not be empty");const i=this.PT;if(this.PT++,this.Ao.length>0){p(this.Ao[this.Ao.length-1].batchId<i,"Mutation batchIDs must be monotonically increasing order")}const r=new Ls(i,e,s,n);this.Ao.push(r);for(const e of n)this.VT=this.VT.add(new Bs(e.key,i)),this.Po.aa(t,e.key.path.ft());return Us.resolve(r)}ua(t,e){return Us.resolve(this.gT(e))}la(t,e){const s=this.gT(e);return p(null!=s,"Failed to find local mutation batch."),Us.resolve(s.keys())}_a(t,e){const s=e+1,n=this.yT(s),i=n<0?0:n;return Us.resolve(this.Ao.length>i?this.Ao[i]:null)}da(){return Us.resolve(0===this.Ao.length?xs:this.PT-1)}fa(t){return Us.resolve(this.Ao.slice())}po(t,e){const s=new Bs(e,0),n=new Bs(e,Number.POSITIVE_INFINITY),i=[];return this.VT.oe([s,n],t=>{p(e.isEqual(t.key),"Should only iterate over a single key's batches");const s=this.gT(t.Jr);p(null!==s,"Batches in the index must exist in the main table"),i.push(s)}),Us.resolve(i)}Do(t,e){let s=new yt(y);return e.forEach(t=>{const e=new Bs(t,0),n=new Bs(t,Number.POSITIVE_INFINITY);this.VT.oe([e,n],e=>{p(t.isEqual(e.key),"For each key, should only iterate over a single key's batches"),s=s.add(e.Jr)})}),Us.resolve(this.bT(s))}Mo(t,e){p(!e.Bs(),"CollectionGroup queries should be handled in LocalDocumentsView");const s=e.path,n=s.length+1;let i=s;Pt.St(i)||(i=i.child(""));const r=new Bs(new Pt(i),0);let o=new yt(y);return this.VT.he(t=>{const e=t.key.path;return!!s.It(e)&&(e.length===n&&(o=o.add(t.Jr)),!0)},r),Us.resolve(this.bT(o))}bT(t){const e=[];return t.forEach(t=>{const s=this.gT(t);null!==s&&e.push(s)}),e}Ta(t,e){p(0===this.pT(e.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.Ao.shift();let s=this.VT;return Us.forEach(e.mutations,n=>{const i=new Bs(n.key,e.batchId);return s=s.delete(i),this.Xh.Ia(t,n.key)}).next(()=>{this.VT=s})}wa(t){}Hr(t,e){const s=new Bs(e,0),n=this.VT.ae(s);return Us.resolve(e.isEqual(n&&n.key))}Ra(t){return 0===this.Ao.length&&p(this.VT.Tt(),"Document leak -- detected dangling mutation references when queue is empty."),Us.resolve()}pT(t,e){const s=this.yT(t);return p(s>=0&&s<this.Ao.length,"Batches must exist to be "+e),s}yT(t){if(0===this.Ao.length)return 0;return t-this.Ao[0].batchId}gT(t){const e=this.yT(t);if(e<0||e>=this.Ao.length)return null;const s=this.Ao[e];return p(s.batchId===t,"If found batch must match"),s}}class Xr{constructor(t,e){this.Po=t,this.vT=e,this.docs=new Vt(Pt.lt),this.size=0}co(t,e,s){p(!s.isEqual(Tt.MIN),"Cannot add a document with a read time of zero");const n=e.key,i=this.docs.get(n),r=i?i.size:0,o=this.vT(e);return this.docs=this.docs.Nt(n,{Xa:e,size:o,readTime:s}),this.size+=o-r,this.Po.aa(t,n.path.ft())}_o(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}do(t,e){const s=this.docs.get(e);return Us.resolve(s?s.Xa:null)}getEntries(t,e){let s=He();return e.forEach(t=>{const e=this.docs.get(t);s=s.Nt(t,e?e.Xa:null)}),Us.resolve(s)}Co(t,e,s){p(!e.Bs(),"CollectionGroup queries should be handled in LocalDocumentsView");let n=Ye();const i=new Pt(e.path.child("")),r=this.docs.Bt(i);for(;r.Gt();){const{key:t,value:{Xa:i,readTime:o}}=r.Kt();if(!e.path.It(t.path))break;o.u(s)<=0||i instanceof _e&&e.matches(i)&&(n=n.Nt(i.key,i))}return Us.resolve(n)}ST(t,e){return Us.forEach(this.docs,t=>e(t))}ru(t,e){throw new Error("getNewDocumentChanges() is not supported with MemoryPersistence")}cu(t){return new Xr.lu(this)}du(t){return Us.resolve(this.size)}}Xr.lu=class extends Qs{constructor(t){super(),this.fu=t}To(t){const e=[];return this.ho.forEach((s,n)=>{n?e.push(this.fu.co(t,n,this.readTime)):this.fu._o(s)}),Us.ro(e)}fo(t,e){return this.fu.do(t,e)}mo(t,e){return this.fu.getEntries(t,e)}};class Zr{constructor(t){this.persistence=t,this.DT=new Ms(t=>t.canonicalId()),this.lastRemoteSnapshotVersion=Tt.MIN,this.highestTargetId=0,this.CT=0,this.kT=new Os,this.targetCount=0,this.va=bn.ya()}ei(t,e){return this.DT.forEach((t,s)=>e(s)),Us.resolve()}ka(t){return Us.resolve(this.lastRemoteSnapshotVersion)}Na(t){return Us.resolve(this.CT)}Sa(t){const e=this.va.after(this.highestTargetId);return this.highestTargetId=e,Us.resolve(e)}Fa(t,e,s){return s&&(this.lastRemoteSnapshotVersion=s),e>this.CT&&(this.CT=e),Us.resolve()}Ma(t){this.DT.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.highestTargetId=e),t.sequenceNumber>this.CT&&(this.CT=t.sequenceNumber)}$a(t,e){return p(!this.DT.has(e.target),"Adding a target that already exists"),this.Ma(e),this.targetCount+=1,Us.resolve()}La(t,e){return p(this.DT.has(e.target),"Updating a non-existent target"),this.Ma(e),Us.resolve()}qa(t,e){return p(this.targetCount>0,"Removing a target from an empty cache"),p(this.DT.has(e.target),"Removing a non-existent target from the cache"),this.DT.delete(e.target),this.kT.Kr(e.targetId),this.targetCount-=1,Us.resolve()}Ba(t,e,s){let n=0;const i=[];return this.DT.forEach((r,o)=>{o.sequenceNumber<=e&&null===s.get(o.targetId)&&(this.DT.delete(r),i.push(this.Oa(t,o.targetId)),n++)}),Us.ro(i).next(()=>n)}Wa(t){return Us.resolve(this.targetCount)}ja(t,e){const s=this.DT.get(e)||null;return Us.resolve(s)}_i(t,e){return V("Not yet implemented.")}Ka(t,e,s){this.kT.Ur(e,s);const n=this.persistence.Xh,i=[];return n&&e.forEach(e=>{i.push(n.Br(t,e))}),Us.ro(i)}Ga(t,e,s){this.kT.jr(e,s);const n=this.persistence.Xh,i=[];return n&&e.forEach(e=>{i.push(n.Qr(t,e))}),Us.ro(i)}Oa(t,e){return this.kT.Kr(e),Us.resolve()}za(t,e){const s=this.kT.zr(e);return Us.resolve(s)}Hr(t,e){return Us.resolve(this.kT.Hr(e))}}const to="MemoryPersistence";class eo{constructor(t,e){this.clientId=t,this.NT={},this.ju=new Gs(0),this.bu=!1,this.bu=!0,this.Xh=e(this),this.$u=new Zr(this);this.Po=new Ln,this.Ro=new Xr(this.Po,t=>this.Xh.FT(t))}static $T(t,e,s){return new eo(t,t=>new io(t,new oi(e),s))}static MT(t){return new eo(t,t=>new no(t))}oc(){return this.bu=!1,Promise.resolve()}get qu(){return this.bu}async lc(){return[this.clientId]}Ku(t){return t(!0)}Gu(){}zu(t){}mc(){return this.Po}_c(t){let e=this.NT[t.A()];return e||(e=new Yr(this.Po,this.Xh),this.NT[t.A()]=e),e}dc(){return this.$u}fc(){return this.Ro}runTransaction(t,e,s){R(to,"Starting transaction:",t);const n=new so(this.ju.next());return this.Xh.xT(),s(n).next(t=>this.Xh.LT(n).next(()=>t)).no().then(t=>(n.Io(),t))}qT(t,e){return Us.oo(function(t){const e=[];return G(t,(t,s)=>e.push(s)),e}(this.NT).map(s=>()=>s.Hr(t,e)))}}class so extends Ws{constructor(t){super(),this.pu=t}}class no{constructor(t){this.persistence=t,this.wc=null,this.OT=null}get BT(){if(this.OT)return this.OT;throw V("orphanedDocuments is only valid during a transaction.")}pc(t){this.wc=t}Br(t,e){return this.BT.delete(e),Us.resolve()}Qr(t,e){return this.BT.add(e),Us.resolve()}Ia(t,e){return this.BT.add(e),Us.resolve()}removeTarget(t,e){const s=this.persistence.dc();return s.za(t,e.targetId).next(t=>{t.forEach(t=>this.BT.add(t))}).next(()=>s.qa(t,e))}xT(){this.OT=new Set}LT(t){const e=this.persistence.fc().cu();return Us.forEach(this.BT,s=>this.UT(t,s).next(t=>{t||e._o(s)})).next(()=>(this.OT=null,e.apply(t)))}bc(t,e){return this.UT(t,e).next(t=>{t?this.BT.delete(e):this.BT.add(e)})}FT(t){return 0}UT(t,e){return Us.oo([()=>this.persistence.dc().Hr(t,e),()=>this.persistence.qT(t,e),()=>Us.resolve(this.wc.Hr(e))])}}class io{constructor(t,e,s){this.persistence=t,this.serializer=e,this.wc=null,this.QT=new Ms(t=>nn(t.path)),this.Ic=new Si(this,s)}xT(){}LT(t){return Us.resolve()}ei(t,e){return this.persistence.dc().ei(t,e)}Rc(t){const e=this.WT(t);return this.persistence.dc().Wa(t).next(t=>e.next(e=>t+e))}WT(t){let e=0;return this.Pc(t,t=>{e++}).next(()=>e)}Pc(t,e){return Us.forEach(this.QT,(s,n)=>this.gc(t,s,n).next(t=>t?Us.resolve():e(n)))}pc(t){this.wc=t}Ba(t,e,s){return this.persistence.dc().Ba(t,e,s)}yc(t,e){let s=0;const n=this.persistence.fc(),i=n.cu();return n.ST(t,n=>this.gc(t,n,e).next(t=>{t||(s++,i._o(n))})).next(()=>i.apply(t)).next(()=>s)}Ia(t,e){return this.QT.set(e,t.pu),Us.resolve()}removeTarget(t,e){const s=e.Js(t.pu);return this.persistence.dc().La(t,s)}Br(t,e){return this.QT.set(e,t.pu),Us.resolve()}Qr(t,e){return this.QT.set(e,t.pu),Us.resolve()}bc(t,e){return this.QT.set(e,t.pu),Us.resolve()}FT(t){const e=this.serializer.Tu(t,t.version);let s;if(e.document)s=e.document;else if(e.unknownDocument)s=e.unknownDocument;else{if(!e.noDocument)throw V("Unknown remote document type");s=e.noDocument}return JSON.stringify(s).length}gc(t,e,s){return Us.oo([()=>this.persistence.qT(t,e),()=>Us.resolve(this.wc.Hr(e)),()=>this.persistence.dc().Hr(t,e),()=>{const t=this.QT.get(e);return Us.resolve(void 0!==t&&t>s)}])}vc(t){return this.persistence.fc().du(t)}}const ro="FirestoreClient",oo=11,ho=20,ao=22;class uo{constructor(t,e){this.cacheSizeBytes=t,this.synchronizeTabs=e}Lu(){return gi.Oc(this.cacheSizeBytes)}}class co{}class lo{constructor(t,e,s,n){this.platform=t,this.jT=e,this.credentials=s,this.eh=n,this.clientId=g.i()}start(t){this.KT();const e=new zs,s=new zs;let n=!1;return this.credentials.K(i=>{n?this.eh.lh(()=>this.lf(i)):(n=!0,this.GT(t,s,i).then(t=>this.zT(i,t)).then(e.resolve,e.reject))}),this.eh.lh(()=>e.promise),s.promise}enableNetwork(){return this.KT(),this.eh.enqueue(()=>this.Jd.enableNetwork())}GT(t,e,s){return t instanceof uo?this.HT(s,t).then(t=>(e.resolve(),t)).catch(t=>{if(e.reject(t),!this.JT(t))throw t;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),this.YT()}):(e.resolve(),this.YT())}JT(t){return t instanceof L?t.code===x.$||t.code===x.q:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(t.code===ao||t.code===ho||t.code===oo)}KT(){if(this.eh.wh)throw new L(x.$,"The client has already been terminated.")}HT(t,e){const s=Ti.Ec(this.jT),n=new vs(this.jT.o,{fi:!0});return Promise.resolve().then(async()=>{if(e.synchronizeTabs&&!Mr.Nh(this.platform))throw new L(x.q,"IndexedDB persistence is only available on platforms that support LocalStorage.");const i=e.Lu();this.vm=e.synchronizeTabs?new Mr(this.eh,this.platform,s,this.clientId,t):new xr;const r=await Ti.xu({allowTabSynchronization:e.synchronizeTabs,persistenceKey:s,clientId:this.clientId,platform:this.platform,gu:this.eh,serializer:n,Lu:i,yu:this.vm});return this.persistence=r,r.Xh.Ic})}YT(){return this.persistence=eo.MT(this.clientId),this.vm=new xr,Promise.resolve(null)}zT(t,e){return R(ro,"Initializing. user=",t.uid),this.platform.XT(this.jT).then(async s=>{const n=new Jr;this.Gc=new Ci(this.persistence,n,t),await this.Gc.start(),e&&(this.ZT=new vi(e,this.eh,this.Gc));const i=this.platform.tE(),r=this.platform.eE(this.jT.o),o=new dr(this.eh,s,this.credentials,r);this.Rm=new Ar(this.Gc,o,this.eh,t=>this.Jd.Tm(t,F.T),i),this.Jd=new Kr(this.Gc,this.Rm,this.vm,t),this.vm.Ed=t=>this.Jd.Tm(t,F.I),this.Rm.Jd=this.Jd,this.vm.Jd=this.Jd,this.sE=new zr(this.Jd),await this.vm.start(),await this.Rm.start(),await this.persistence.Ku(async t=>{await this.Jd._f(t),this.ZT&&(t&&!this.ZT.qu?this.ZT.start():t||this.ZT.stop())}),await this.persistence.Gu(async()=>{await this.terminate()})})}lf(t){return this.eh.yh(),R(ro,"Credential Changed. Current user: "+t.uid),this.Jd.lf(t)}disableNetwork(){return this.KT(),this.eh.enqueue(()=>this.Jd.disableNetwork())}terminate(){return this.eh.Vh(async()=>{this.ZT&&this.ZT.stop(),await this.Rm.oc(),await this.vm.oc(),await this.persistence.oc(),this.credentials.G()})}waitForPendingWrites(){this.KT();const t=new zs;return this.eh.lh(()=>this.Jd.Hm(t)),t.promise}listen(t,e,s){this.KT();const n=new Hr(t,e,s);return this.eh.lh(()=>this.sE.listen(n)),n}zd(t){this.nE||this.eh.lh(()=>this.sE.zd(t))}iE(t){return this.KT(),this.eh.enqueue(()=>this.Gc.yl(t)).then(t=>{if(t instanceof _e)return t;if(t instanceof de)return null;throw new L(x.O,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})}rE(t){return this.KT(),this.eh.enqueue(async()=>{const e=await this.Gc.Sl(t,!0),s=new Or(t,e.Dl),n=s.um(e.documents);return s.To(n,!1).snapshot})}write(t){this.KT();const e=new zs;return this.eh.lh(()=>this.Jd.write(t,e)),e.promise}o(){return this.jT.o}cT(t){this.KT(),this.eh.lh(()=>(this.sE.cT(t),Promise.resolve()))}lT(t){this.nE||this.sE.lT(t)}get nE(){return this.eh.wh}transaction(t){this.KT();const e=new zs;return this.eh.lh(()=>(this.Jd.runTransaction(this.eh,t,e),Promise.resolve())),e.promise}}class _o{constructor(t){this.observer=t,this.muted=!1}next(t){this.oE(this.observer.next,t)}error(t){this.oE(this.observer.error,t)}hE(){this.muted=!0}oE(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}}function fo(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const s=t;for(const t of e)if(t in s&&"function"==typeof s[t])return!0;return!1}(t,["next","error","complete"])}const mo="firestore.googleapis.com",To=!0,Eo=!0,wo=!1,Io=gi.Qc,Ro=!1;class Ao{constructor(t){if(void 0===t.host){if(void 0!==t.ssl)throw new L(x.D,"Can't provide ssl option if host option is not set");this.host=mo,this.ssl=To}else et("settings","non-empty string","host",t.host),this.host=t.host,st("settings","boolean","ssl",t.ssl),this.ssl=j(t.ssl,To);if(ut("settings",t,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),st("settings","object","credentials",t.credentials),this.credentials=t.credentials,st("settings","boolean","timestampsInSnapshots",t.timestampsInSnapshots),!0===t.timestampsInSnapshots?A("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===t.timestampsInSnapshots&&A("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=j(t.timestampsInSnapshots,Eo),st("settings","number","cacheSizeBytes",t.cacheSizeBytes),void 0===t.cacheSizeBytes)this.cacheSizeBytes=gi.jc;else{if(t.cacheSizeBytes!==Io&&t.cacheSizeBytes<gi.Wc)throw new L(x.D,`cacheSizeBytes must be at least ${gi.Wc}`);this.cacheSizeBytes=t.cacheSizeBytes}st("settings","boolean","experimentalForceLongPolling",t.experimentalForceLongPolling),this.forceLongPolling=void 0===t.experimentalForceLongPolling?wo:t.experimentalForceLongPolling}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.timestampsInSnapshots===t.timestampsInSnapshots&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.forceLongPolling===t.forceLongPolling}}class Po{constructor(t,e){if(this.aE=null,this.uE=new Xs,this.INTERNAL={delete:async()=>{this.cE(),await this.lE.terminate()}},"object"==typeof t.options){const s=t;this.aE=s,this._E=Po.dE(s),this.fE=s.name,this.mE=new B(e)}else{const e=t;if(!e.projectId)throw new L(x.D,"Must provide projectId");this._E=new C(e.projectId,e.database),this.fE="[DEFAULT]",this.mE=new O}this.TE=new Ao({}),this.EE=this.wE(this._E)}settings(t){if(J("Firestore.settings",arguments,1),Z("Firestore.settings","object",1,t),W(t,"persistence"))throw new L(x.D,'"persistence" is now specified with a separate call to firestore.enablePersistence().');const e=new Ao(t);if(this.lE&&!this.TE.isEqual(e))throw new L(x.$,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this.TE=e,void 0!==e.credentials&&(this.mE=function(t){if(!t)return new O;switch(t.type){case"gapi":const e=t.IE;return p(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty),"unexpected gapi interface"),new Q(e,t.tt||"0");case"provider":return t.IE;default:throw new L(x.D,"makeCredentialsProvider failed due to invalid credential type")}}(e.credentials))}enableNetwork(){return this.cE(),this.lE.enableNetwork()}disableNetwork(){return this.cE(),this.lE.disableNetwork()}enablePersistence(t){if(this.lE)throw new L(x.$,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");let e=!1;return t&&(void 0!==t.experimentalTabSynchronization&&A("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),e=j(void 0!==t.synchronizeTabs?t.synchronizeTabs:t.experimentalTabSynchronization,Ro)),this.RE(new uo(this.TE.cacheSizeBytes,e))}clearPersistence(){const t=Ti.Ec(this.AE()),e=new zs;return this.uE.Ih(async()=>{try{if(void 0!==this.lE&&!this.lE.nE)throw new L(x.$,"Persistence cannot be cleared after this Firestore instance is initialized.");await Ti.clearPersistence(t),e.resolve()}catch(t){e.reject(t)}}),e.promise}terminate(){return this.app._removeServiceInstance("firestore"),this.INTERNAL.delete()}get PE(){return this.cE(),this.lE.nE}waitForPendingWrites(){return this.cE(),this.lE.waitForPendingWrites()}onSnapshotsInSync(t){if(this.cE(),fo(t))return this.VE(t);{Z("Firestore.onSnapshotsInSync","function",1,t);const e={next:t};return this.VE(e)}}VE(t){const e=new _o({next:()=>{t.next&&t.next()},error:t=>{throw V("Uncaught Error in onSnapshotsInSync")}});return this.lE.cT(e),()=>{e.hE(),this.lE.lT(e)}}cE(){return this.lE||this.RE(new co),this.lE}AE(){return new S(this._E,this.fE,this.TE.host,this.TE.ssl,this.TE.forceLongPolling)}RE(t){p(!!this.TE.host,"FirestoreSettings.host is not set"),p(!this.lE,"configureClient() called multiple times");const e=this.AE();return this.lE=new lo(Ss.t(),e,this.mE,this.uE),this.lE.start(t)}wE(t){return new Hi(e=>{if(e instanceof go){const s=t,n=e.firestore._E;if(!n.isEqual(s))throw new L(x.D,"Document reference is for database "+`${n.projectId}/${n.database} but should be `+`for database ${s.projectId}/${s.database}`);return new zi(t,e.pE)}return e})}static dE(t){const e=t.options;if(!W(e,"projectId"))throw new L(x.D,'"projectId" not provided in firebase.initializeApp.');const s=e.projectId;if(!s||"string"!=typeof s)throw new L(x.D,"projectId must be a string in FirebaseApp.options");return new C(s)}get app(){if(!this.aE)throw new L(x.$,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this.aE}collection(t){return J("Firestore.collection",arguments,1),Z("Firestore.collection","non-empty string",1,t),this.cE(),new Co(It.Vt(t),this)}doc(t){return J("Firestore.doc",arguments,1),Z("Firestore.doc","non-empty string",1,t),this.cE(),go.gE(It.Vt(t),this)}collectionGroup(t){if(J("Firestore.collectionGroup",arguments,1),Z("Firestore.collectionGroup","non-empty string",1,t),t.indexOf("/")>=0)throw new L(x.D,`Invalid collection ID '${t}' passed to function `+"Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.cE(),new So(new pe(It.pt,t),this)}runTransaction(t){return J("Firestore.runTransaction",arguments,1),Z("Firestore.runTransaction","function",1,t),this.cE().transaction(e=>t(new Vo(this,e)))}batch(){return this.cE(),new po(this)}static get logLevel(){switch(w()){case E.DEBUG:return"debug";case E.ERROR:return"error";case E.SILENT:return"silent";default:return V("Unknown log level: "+w())}}static setLogLevel(t){switch(J("Firestore.setLogLevel",arguments,1),Z("Firestore.setLogLevel","non-empty string",1,t),t){case"debug":I(E.DEBUG);break;case"error":I(E.ERROR);break;case"silent":I(E.SILENT);break;default:throw new L(x.D,"Invalid log level: "+t)}}yE(){return this.TE.timestampsInSnapshots}}class Vo{constructor(t,e){this.bE=t,this.vE=e}get(t){J("Transaction.get",arguments,1);const e=$o("Transaction.get",t,this.bE);return this.vE.od([e.pE]).then(t=>{if(!t||1!==t.length)return V("Mismatch in docs returned from document lookup.");const s=t[0];if(s instanceof de)return new bo(this.bE,e.pE,null,!1,!1,e.SE);if(s instanceof _e)return new bo(this.bE,e.pE,s,!1,!1,e.SE);throw V(`BatchGetDocumentsRequest returned unexpected document type: ${s.constructor.name}`)})}set(t,e,s){X("Transaction.set",arguments,2,3);const n=$o("Transaction.set",t,this.bE);s=ko("Transaction.set",s);const[i,r]=xo(n.SE,e,"Transaction.set"),o=s.merge||s.mergeFields?this.bE.EE.e_(r,i,s.mergeFields):this.bE.EE.Zl(r,i);return this.vE.set(n.pE,o),this}update(t,e,s,...n){let i,r;return"string"==typeof e||e instanceof ki?(Y("Transaction.update",arguments,3),i=$o("Transaction.update",t,this.bE),r=this.bE.EE.i_("Transaction.update",e,s,n)):(J("Transaction.update",arguments,2),i=$o("Transaction.update",t,this.bE),r=this.bE.EE.s_("Transaction.update",e)),this.vE.update(i.pE,r),this}delete(t){J("Transaction.delete",arguments,1);const e=$o("Transaction.delete",t,this.bE);return this.vE.delete(e.pE),this}}class po{constructor(t){this.bE=t,this.DE=[],this.CE=!1}set(t,e,s){X("WriteBatch.set",arguments,2,3),this.kE();const n=$o("WriteBatch.set",t,this.bE);s=ko("WriteBatch.set",s);const[i,r]=xo(n.SE,e,"WriteBatch.set"),o=s.merge||s.mergeFields?this.bE.EE.e_(r,i,s.mergeFields):this.bE.EE.Zl(r,i);return this.DE=this.DE.concat(o.ql(n.pE,Ut.NONE)),this}update(t,e,s,...n){let i,r;return this.kE(),"string"==typeof e||e instanceof ki?(Y("WriteBatch.update",arguments,3),i=$o("WriteBatch.update",t,this.bE),r=this.bE.EE.i_("WriteBatch.update",e,s,n)):(J("WriteBatch.update",arguments,2),i=$o("WriteBatch.update",t,this.bE),r=this.bE.EE.s_("WriteBatch.update",e)),this.DE=this.DE.concat(r.ql(i.pE,Ut.exists(!0))),this}delete(t){J("WriteBatch.delete",arguments,1),this.kE();const e=$o("WriteBatch.delete",t,this.bE);return this.DE=this.DE.concat(new Gt(e.pE,Ut.NONE)),this}async commit(){if(this.kE(),this.CE=!0,this.DE.length>0)return this.bE.cE().write(this.DE)}kE(){if(this.CE)throw new L(x.$,"A write batch can no longer be used after commit() has been called.")}}class go{constructor(t,e,s){this.pE=t,this.firestore=e,this.SE=s,this.lE=this.firestore.cE()}static gE(t,e,s){if(t.length%2!=0)throw new L(x.D,"Invalid document reference. Document references must have an even number of segments, but "+`${t.Pt()} has ${t.length}`);return new go(new Pt(t),e,s)}get id(){return this.pE.path.wt()}get parent(){return new Co(this.pE.path.ft(),this.firestore,this.SE)}get path(){return this.pE.path.Pt()}collection(t){if(J("DocumentReference.collection",arguments,1),Z("DocumentReference.collection","non-empty string",1,t),!t)throw new L(x.D,"Must provide a non-empty collection name to collection()");const e=It.Vt(t);return new Co(this.pE.path.child(e),this.firestore)}isEqual(t){if(!(t instanceof go))throw ct("isEqual","DocumentReference",1,t);return this.firestore===t.firestore&&this.pE.isEqual(t.pE)&&this.SE===t.SE}set(t,e){X("DocumentReference.set",arguments,1,2),e=ko("DocumentReference.set",e);const[s,n]=xo(this.SE,t,"DocumentReference.set"),i=e.merge||e.mergeFields?this.firestore.EE.e_(n,s,e.mergeFields):this.firestore.EE.Zl(n,s);return this.lE.write(i.ql(this.pE,Ut.NONE))}update(t,e,...s){let n;return"string"==typeof t||t instanceof ki?(Y("DocumentReference.update",arguments,2),n=this.firestore.EE.i_("DocumentReference.update",t,e,s)):(J("DocumentReference.update",arguments,1),n=this.firestore.EE.s_("DocumentReference.update",t)),this.lE.write(n.ql(this.pE,Ut.exists(!0)))}delete(){return J("DocumentReference.delete",arguments,0),this.lE.write([new Gt(this.pE,Ut.NONE)])}onSnapshot(...t){X("DocumentReference.onSnapshot",arguments,1,4);let e,s={includeMetadataChanges:!1},n=0;"object"!=typeof t[n]||fo(t[n])||(ut("DocumentReference.onSnapshot",s=t[n],["includeMetadataChanges"]),st("DocumentReference.onSnapshot","boolean","includeMetadataChanges",s.includeMetadataChanges),n++);const i={includeMetadataChanges:s.includeMetadataChanges};return fo(t[n])?e=t[n]:(Z("DocumentReference.onSnapshot","function",n,t[n]),tt("DocumentReference.onSnapshot","function",n+1,t[n+1]),tt("DocumentReference.onSnapshot","function",n+2,t[n+2]),e={next:t[n],error:t[n+1],complete:t[n+2]}),this.NE(i,e)}NE(t,e){let s=t=>{console.error("Uncaught Error in onSnapshot:",t)};e.error&&(s=e.error.bind(e));const n=new _o({next:t=>{if(e.next){p(t.docs.size<=1,"Too many documents returned on a document query");const s=t.docs.get(this.pE);e.next(new bo(this.firestore,this.pE,s,t.fromCache,t.hasPendingWrites,this.SE))}},error:s}),i=this.lE.listen(pe.Rs(this.pE.path),n,t);return()=>{n.hE(),this.lE.zd(i)}}get(t){return X("DocumentReference.get",arguments,0,1),Fo("DocumentReference.get",t),new Promise((e,s)=>{t&&"cache"===t.source?this.firestore.cE().iE(this.pE).then(t=>{e(new bo(this.firestore,this.pE,t,!0,t instanceof _e&&t.ve,this.SE))},s):this.FE(e,s,t)})}FE(t,e,s){const n=this.NE({includeMetadataChanges:!0,wT:!0},{next:i=>{n(),!i.exists&&i.metadata.fromCache?e(new L(x.O,"Failed to get document because the client is offline.")):i.exists&&i.metadata.fromCache&&s&&"server"===s.source?e(new L(x.O,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):t(i)},error:e})}withConverter(t){return new go(this.pE,this.firestore,t)}}class yo{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class bo{constructor(t,e,s,n,i,r){this.bE=t,this.pE=e,this.$E=s,this.ME=n,this.xE=i,this.SE=r}data(t){if(X("DocumentSnapshot.data",arguments,0,1),t=No("DocumentSnapshot.data",t),this.$E){if(this.SE){const e=new vo(this.bE,this.pE,this.$E,this.ME,this.xE);return this.SE.fromFirestore(e,t)}return this.LE(this.$E.data(),Ht.Je(t,this.bE.yE()))}}get(t,e){if(X("DocumentSnapshot.get",arguments,1,2),e=No("DocumentSnapshot.get",e),this.$E){const s=this.$E.data().field(Xi("DocumentSnapshot.get",t));if(null!==s)return this.qE(s,Ht.Je(e,this.bE.yE()))}}get id(){return this.pE.path.wt()}get ref(){return new go(this.pE,this.bE,this.SE)}get exists(){return null!==this.$E}get metadata(){return new yo(this.xE,this.ME)}isEqual(t){if(!(t instanceof bo))throw ct("isEqual","DocumentSnapshot",1,t);return this.bE===t.bE&&this.ME===t.ME&&this.pE.isEqual(t.pE)&&(null===this.$E?null===t.$E:this.$E.isEqual(t.$E))&&this.SE===t.SE}LE(t,e){const s={};return t.forEach((t,n)=>{s[t]=this.qE(n,e)}),s}qE(t,e){if(t instanceof ue)return this.LE(t,e);if(t instanceof ce)return this.OE(t,e);if(t instanceof he){const s=t.value(e),n=this.bE.cE().o();return t.o.isEqual(n)||A(`Document ${this.pE.path} contains a document `+"reference within a different database ("+`${t.o.projectId}/${t.o.database}) which is not `+"supported. It will be treated as a reference in the current "+`database (${n.projectId}/${n.database}) `+"instead."),new go(s,this.bE,this.SE)}return t.value(e)}OE(t,e){return t.me.map(t=>this.qE(t,e))}}class vo extends bo{data(t){const e=super.data(t);return p(void 0!==e,"Document in a QueryDocumentSnapshot should exist"),e}}class So{constructor(t,e,s){this.BE=t,this.firestore=e,this.SE=s}where(t,e,s){J("Query.where",arguments,3),at("Query.where",3,s);let n;!function(t,e,s,n){if(!e.some(t=>t===n))throw new L(x.D,`Invalid value ${ht(n)} provided to function `+`${t}() for its ${_t(s)} argument. Acceptable `+`values: ${e.join(", ")}`)}("Query.where",["<","<=","==",">=",">","array-contains","in","array-contains-any"],2,e);const i=Xi("Query.where",t),r=ye.Vt(e);if(i.yt()){if(r===ye.ARRAY_CONTAINS||r===ye.ARRAY_CONTAINS_ANY)throw new L(x.D,`Invalid Query. You can't perform '${r.toString()}' `+"queries on FieldPath.documentId().");if(r===ye.IN){this.UE(s,r);const t=[];for(const e of s)t.push(this.QE(e));n=new ce(t)}else n=this.QE(s)}else r!==ye.IN&&r!==ye.ARRAY_CONTAINS_ANY||this.UE(s,r),n=this.firestore.EE.r_("Query.where",s,r===ye.IN);const o=be.create(i,r,n);return this.WE(o),new So(this.BE.Vs(o),this.firestore,this.SE)}orderBy(t,e){let s;if(X("Query.orderBy",arguments,1,2),tt("Query.orderBy","non-empty string",2,e),void 0===e||"asc"===e)s=Ne.ASCENDING;else{if("desc"!==e)throw new L(x.D,`Function Query.orderBy() has unknown direction '${e}', `+"expected 'asc' or 'desc'.");s=Ne.DESCENDING}if(null!==this.BE.startAt)throw new L(x.D,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this.BE.endAt)throw new L(x.D,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");const n=Xi("Query.orderBy",t),i=new $e(n,s);return this.jE(i),new So(this.BE.gs(i),this.firestore,this.SE)}limit(t){return J("Query.limit",arguments,1),Z("Query.limit","number",1,t),lt("Query.limit",1,t),new So(this.BE.ys(t),this.firestore,this.SE)}limitToLast(t){return J("Query.limitToLast",arguments,1),Z("Query.limitToLast","number",1,t),lt("Query.limitToLast",1,t),new So(this.BE.bs(t),this.firestore,this.SE)}startAt(t,...e){Y("Query.startAt",arguments,1);const s=this.KE("Query.startAt",t,e,!0);return new So(this.BE.vs(s),this.firestore,this.SE)}startAfter(t,...e){Y("Query.startAfter",arguments,1);const s=this.KE("Query.startAfter",t,e,!1);return new So(this.BE.vs(s),this.firestore,this.SE)}endBefore(t,...e){Y("Query.endBefore",arguments,1);const s=this.KE("Query.endBefore",t,e,!0);return new So(this.BE.Ss(s),this.firestore,this.SE)}endAt(t,...e){Y("Query.endAt",arguments,1);const s=this.KE("Query.endAt",t,e,!1);return new So(this.BE.Ss(s),this.firestore,this.SE)}isEqual(t){if(!(t instanceof So))throw ct("isEqual","Query",1,t);return this.firestore===t.firestore&&this.BE.isEqual(t.BE)}withConverter(t){return new So(this.BE,this.firestore,t)}KE(t,e,s,n){if(at(t,1,e),e instanceof bo){if(s.length>0)throw new L(x.D,`Too many arguments provided to ${t}().`);const i=e;if(!i.exists)throw new L(x.k,"Can't use a DocumentSnapshot that doesn't exist for "+`${t}().`);return this.GE(t,i.$E,n)}{const i=[e].concat(s);return this.zE(t,i,n)}}GE(t,e,s){const n=[];for(const t of this.BE.orderBy)if(t.field.yt())n.push(new he(this.firestore._E,e.key));else{const s=e.field(t.field);if(s instanceof re)throw new L(x.D,'Invalid query. You are trying to start or end a query using a document for which the field "'+t.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){const e=t.field.Pt();throw new L(x.D,"Invalid query. You are trying to start or end a query using a "+`document for which the field '${e}' (used as the `+"orderBy) does not exist.")}n.push(s)}return new Fe(n,s)}zE(t,e,s){const n=this.BE.ms;if(e.length>n.length)throw new L(x.D,`Too many arguments provided to ${t}(). `+"The number of arguments must be less than or equal to the number of Query.orderBy() clauses");const i=[];for(let s=0;s<e.length;s++){const r=e[s];if(n[s].field.yt()){if("string"!=typeof r)throw new L(x.D,"Invalid query. Expected a string for document ID in "+`${t}(), but got a ${typeof r}`);if(!this.BE.Bs()&&-1!==r.indexOf("/"))throw new L(x.D,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), "+`the value passed to ${t}() must be a plain document ID, but `+`'${r}' contains a slash.`);const e=this.BE.path.child(It.Vt(r));if(!Pt.St(e))throw new L(x.D,"Invalid query. When querying a collection group and ordering by "+`FieldPath.documentId(), the value passed to ${t}() must result in a `+`valid document path, but '${e}' is not because it contains an odd number `+"of segments.");const s=new Pt(e);i.push(new he(this.firestore._E,s))}else{const e=this.firestore.EE.r_(t,r);i.push(e)}}return new Fe(i,s)}onSnapshot(...t){X("Query.onSnapshot",arguments,1,4);let e,s={},n=0;return"object"!=typeof t[n]||fo(t[n])||(ut("Query.onSnapshot",s=t[n],["includeMetadataChanges"]),st("Query.onSnapshot","boolean","includeMetadataChanges",s.includeMetadataChanges),n++),fo(t[n])?e=t[n]:(Z("Query.onSnapshot","function",n,t[n]),tt("Query.onSnapshot","function",n+1,t[n+1]),tt("Query.onSnapshot","function",n+2,t[n+2]),e={next:t[n],error:t[n+1],complete:t[n+2]}),this.HE(this.BE),this.NE(s,e)}NE(t,e){let s=t=>{console.error("Uncaught Error in onSnapshot:",t)};e.error&&(s=e.error.bind(e));const n=new _o({next:t=>{e.next&&e.next(new Do(this.firestore,this.BE,t,this.SE))},error:s}),i=this.firestore.cE(),r=i.listen(this.BE,n,t);return()=>{n.hE(),i.zd(r)}}HE(t){if(t.qs()&&0===t.ms.length)throw new L(x.q,"limitToLast() queries require specifying at least one orderBy() clause")}get(t){return X("Query.get",arguments,0,1),Fo("Query.get",t),this.HE(this.BE),new Promise((e,s)=>{t&&"cache"===t.source?this.firestore.cE().rE(this.BE).then(t=>{e(new Do(this.firestore,this.BE,t,this.SE))},s):this.FE(e,s,t)})}FE(t,e,s){const n=this.NE({includeMetadataChanges:!0,wT:!0},{next:i=>{n(),i.metadata.fromCache&&s&&"server"===s.source?e(new L(x.O,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):t(i)},error:e})}QE(t){if("string"==typeof t){if(""===t)throw new L(x.D,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this.BE.Bs()&&-1!==t.indexOf("/"))throw new L(x.D,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but "+`'${t}' contains a '/' character.`);const e=this.BE.path.child(It.Vt(t));if(!Pt.St(e))throw new L(x.D,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, "+`but '${e}' is not because it has an odd number of segments (${e.length}).`);return new he(this.firestore._E,new Pt(e))}if(t instanceof go){const e=t;return new he(this.firestore._E,e.pE)}throw new L(x.D,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+`${ht(t)}.`)}UE(t,e){if(!Array.isArray(t)||0===t.length)throw new L(x.D,"Invalid Query. A non-empty array is required for "+`'${e.toString()}' filters.`);if(t.length>10)throw new L(x.D,`Invalid Query. '${e.toString()}' filters support a `+"maximum of 10 elements in the value array.");if(t.indexOf(null)>=0)throw new L(x.D,`Invalid Query. '${e.toString()}' filters cannot contain 'null' `+"in the value array.");if(t.filter(t=>Number.isNaN(t)).length>0)throw new L(x.D,`Invalid Query. '${e.toString()}' filters cannot contain 'NaN' `+"in the value array.")}WE(t){if(t instanceof be){const e=[ye.ARRAY_CONTAINS,ye.ARRAY_CONTAINS_ANY],s=[ye.IN,ye.ARRAY_CONTAINS_ANY],n=e.indexOf(t.op)>=0,i=s.indexOf(t.op)>=0;if(t.ps()){const e=this.BE.As();if(null!==e&&!e.isEqual(t.field))throw new L(x.D,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have"+` inequality filters on '${e.toString()}'`+` and '${t.field.toString()}'`);const s=this.BE.Ps();null!==s&&this.JE(t.field,s)}else if(i||n){let r=null;if(i&&(r=this.BE.Os(s)),null===r&&n&&(r=this.BE.Os(e)),null!=r)throw r===t.op?new L(x.D,"Invalid query. You cannot use more than one "+`'${t.op.toString()}' filter.`):new L(x.D,`Invalid query. You cannot use '${t.op.toString()}' filters `+`with '${r.toString()}' filters.`)}}}jE(t){if(null===this.BE.Ps()){const e=this.BE.As();null!==e&&this.JE(e,t.field)}}JE(t,e){if(!e.isEqual(t))throw new L(x.D,"Invalid query. You have a where filter with an inequality "+`(<, <=, >, or >=) on field '${t.toString()}' `+`and so you must also use '${t.toString()}' `+"as your first Query.orderBy(), but your first Query.orderBy() "+`is on field '${e.toString()}' instead.`)}}class Do{constructor(t,e,s,n){this.bE=t,this.YE=e,this.XE=s,this.SE=n,this.ZE=null,this.tw=null,this.metadata=new yo(s.hasPendingWrites,s.fromCache)}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get empty(){return this.XE.docs.Tt()}get size(){return this.XE.docs.size}forEach(t,e){X("QuerySnapshot.forEach",arguments,1,2),Z("QuerySnapshot.forEach","function",1,t),this.XE.docs.forEach(s=>{t.call(e,this.ew(s))})}get query(){return new So(this.YE,this.bE,this.SE)}docChanges(t){t&&(ut("QuerySnapshot.docChanges",t,["includeMetadataChanges"]),st("QuerySnapshot.docChanges","boolean","includeMetadataChanges",t.includeMetadataChanges));const e=!(!t||!t.includeMetadataChanges);if(e&&this.XE.dn)throw new L(x.D,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this.ZE&&this.tw===e||(this.ZE=function(t,e,s,n){if(s.cn.Tt()){let e,i=0;return s.docChanges.map(r=>{const o=new vo(t,r.doc.key,r.doc,s.fromCache,s.ln.has(r.doc.key),n);return p(r.type===rs.sn,"Invalid event type for first snapshot"),p(!e||s.query.Ns(e,r.doc)<0,"Got added events in wrong order"),e=r.doc,{type:"added",doc:o,oldIndex:-1,newIndex:i++}})}{let i=s.cn;return s.docChanges.filter(t=>e||t.type!==rs.rn).map(e=>{const r=new vo(t,e.doc.key,e.doc,s.fromCache,s.ln.has(e.doc.key),n);let o=-1,h=-1;return e.type!==rs.sn&&(p((o=i.indexOf(e.doc.key))>=0,"Index for document not found"),i=i.delete(e.doc.key)),e.type!==rs.nn&&(h=(i=i.add(e.doc)).indexOf(e.doc.key)),{type:Mo(e.type),doc:r,oldIndex:o,newIndex:h}})}}(this.bE,e,this.XE,this.SE),this.tw=e),this.ZE}isEqual(t){if(!(t instanceof Do))throw ct("isEqual","QuerySnapshot",1,t);return this.bE===t.bE&&this.YE.isEqual(t.YE)&&this.XE.isEqual(t.XE)&&this.SE===t.SE}ew(t){return new vo(this.bE,t.key,t,this.metadata.fromCache,this.XE.ln.has(t.key),this.SE)}}["length","forEach","map",..."undefined"!=typeof Symbol?[Symbol.iterator]:[]].forEach(t=>{try{Object.defineProperty(Do.prototype.docChanges,t,{get:()=>(function(){throw new L(x.D,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')})()})}catch(t){}});class Co extends So{constructor(t,e,s){if(super(pe.Rs(t),e,s),this.sw=t,t.length%2!=1)throw new L(x.D,"Invalid collection reference. Collection references must have an odd number of segments, but "+`${t.Pt()} has ${t.length}`)}get id(){return this.BE.path.wt()}get parent(){const t=this.BE.path.ft();return t.Tt()?null:new go(new Pt(t),this.firestore)}get path(){return this.BE.path.Pt()}doc(t){if(X("CollectionReference.doc",arguments,0,1),0===arguments.length&&(t=g.i()),Z("CollectionReference.doc","non-empty string",1,t),""===t)throw new L(x.D,"Document path must be a non-empty string");const e=It.Vt(t);return go.gE(this.BE.path.child(e),this.firestore,this.SE)}add(t){J("CollectionReference.add",arguments,1),Z("CollectionReference.add","object",1,t);const e=this.doc();return e.set(t).then(()=>e)}withConverter(t){return new Co(this.sw,this.firestore,t)}}function ko(t,e){if(void 0===e)return{merge:!1};if(ut(t,e,["merge","mergeFields"]),st(t,"boolean","merge",e.merge),nt(t,"mergeFields","a string or a FieldPath",e.mergeFields,t=>"string"==typeof t||t instanceof ki),void 0!==e.mergeFields&&void 0!==e.merge)throw new L(x.D,`Invalid options passed to function ${t}(): You cannot specify both "merge" `+'and "mergeFields".');return e}function No(t,e){return void 0===e?{}:(ut(t,e,["serverTimestamps"]),it(t,0,"serverTimestamps",e.serverTimestamps,["estimate","previous","none"]),e)}function Fo(t,e){tt(t,"object",1,e),e&&(ut(t,e,["source"]),it(t,0,"source",e.source,["default","server","cache"]))}function $o(t,e,s){if(e instanceof go){if(e.firestore!==s)throw new L(x.D,"Provided document reference is from a different Firestore instance.");return e}throw ct(t,"DocumentReference",1,e)}function Mo(t){switch(t){case rs.sn:return"added";case rs.in:case rs.rn:return"modified";case rs.nn:return"removed";default:return V("Unknown change type: "+t)}}function xo(t,e,s){let n;return t?(n=t.toFirestore(e),s="toFirestore() in "+s):n=e,[n,s]}const Lo=Cs(Po,"Use firebase.firestore() instead."),qo=Cs(Vo,"Use firebase.firestore().runTransaction() instead."),Oo=Cs(po,"Use firebase.firestore().batch() instead."),Bo=Cs(go,"Use firebase.firestore().doc() instead."),Uo=Cs(bo),Qo=Cs(vo),Wo=Cs(So),jo=Cs(Do),Ko=Cs(Co,"Use firebase.firestore().collection() instead."),Go={Firestore:Lo,GeoPoint:ft,Timestamp:mt,Blob:$s,Transaction:qo,WriteBatch:Oo,DocumentReference:Bo,DocumentSnapshot:Uo,Query:Wo,QueryDocumentSnapshot:Qo,QuerySnapshot:jo,CollectionReference:Ko,FieldPath:ki,FieldValue:Oi,setLogLevel:Po.setLogLevel,CACHE_SIZE_UNLIMITED:Io};function zo(t){t.INTERNAL.registerComponent(new u("firestore",t=>{const e=t.getProvider("app").getImmediate();return new Po(e,t.getProvider("auth-internal"))},"PUBLIC").setServiceProps(function(t){p(t&&"object"==typeof t,"shallowCopy() expects object parameter.");const e={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}(Go)))}class Ho{Dd(t){}oc(){}}const Jo="ConnectivityMonitor";class Yo{constructor(){this.nw=()=>this.iw(),this.rw=()=>this.ow(),this.hw=[],this.aw()}Dd(t){this.hw.push(t)}oc(){window.removeEventListener("online",this.nw),window.removeEventListener("offline",this.rw)}aw(){window.addEventListener("online",this.nw),window.addEventListener("offline",this.rw)}iw(){R(Jo,"Network connectivity changed: AVAILABLE");for(const t of this.hw)t(0)}ow(){R(Jo,"Network connectivity changed: UNAVAILABLE");for(const t of this.hw)t(1)}static Nh(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}class Xo{constructor(t){this.uw=t.uw,this.cw=t.cw}j_(t){p(!this.lw,"Called onOpen on stream twice!"),this.lw=t}O_(t){p(!this._w,"Called onClose on stream twice!"),this._w=t}onMessage(t){p(!this.dw,"Called onMessage on stream twice!"),this.dw=t}close(){this.cw()}send(t){this.uw(t)}fw(){p(void 0!==this.lw,"Cannot call onOpen because no callback was set"),this.lw()}mw(t){p(void 0!==this._w,"Cannot call onClose because no callback was set"),this._w(t)}Tw(t){p(void 0!==this.dw,"Cannot call onMessage because no callback was set"),this.dw(t)}}const Zo="Connection",th="google.firestore.v1.Firestore",eh="v1",sh={BatchGetDocuments:"batchGet",Commit:"commit"},nh="gl-js/ fire/"+m,ih=15;class rh{constructor(t){this.o=t.o;const e=t.ssl?"https":"http";this.Ew=e+"://"+t.host,this.forceLongPolling=t.forceLongPolling}ww(t,e){if(e)for(const s in e.U)e.U.hasOwnProperty(s)&&(t[s]=e.U[s]);t["X-Goog-Api-Client"]=nh}rd(t,e,s){const n=this.Iw(t);return new Promise((i,r)=>{const o=new c;o.listenOnce(l.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case _.NO_ERROR:const e=o.getResponseJson();R(Zo,"XHR received:",JSON.stringify(e)),i(e);break;case _.TIMEOUT:R(Zo,'RPC "'+t+'" timed out'),r(new L(x.C,"Request time out"));break;case _.HTTP_ERROR:const s=o.getStatus();if(R(Zo,'RPC "'+t+'" failed with status:',s,"response text:",o.getResponseText()),s>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace("_","-");return Object.values(x).indexOf(e)>=0?e:x.S}(t.status);r(new L(e,t.message))}else r(new L(x.S,"Server responded with status "+o.getStatus()))}else R(Zo,'RPC "'+t+'" failed'),r(new L(x.O,"Connection failed."));break;default:V('RPC "'+t+'" failed with unanticipated webchannel error '+o.getLastErrorCode()+": "+o.getLastError()+", giving up.")}}finally{R(Zo,'RPC "'+t+'" completed.')}});const h=Object.assign({},e);delete h.database;const a=JSON.stringify(h);R(Zo,"XHR sending: ",n+" "+a);const u={"Content-Type":"text/plain"};this.ww(u,s),o.send(n,"POST",a,u,ih)})}hd(t,e,s){return this.rd(t,e,s)}K_(t,e){const s=[this.Ew,"/",th,"/",t,"/channel"],n=d(),u={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.o.projectId}/databases/${this.o.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.ww(u.initMessageHeaders,e),i()||r()||o()||h()||a()||(u.httpHeadersOverwriteParam="$httpHeaders");const c=s.join("");R(Zo,"Creating WebChannel: "+c+" "+u);const l=n.createWebChannel(c,u);let _=!1,m=!1;const T=new Xo({uw:t=>{m?R(Zo,"Not sending because WebChannel is closed:",t):(_||(R(Zo,"Opening WebChannel transport."),l.open(),_=!0),R(Zo,"WebChannel sending:",t),l.send(t))},cw:()=>l.close()}),E=(t,e)=>{l.listen(t,t=>{try{e(t)}catch(t){setTimeout(()=>{throw t},0)}})};return E(f.EventType.OPEN,()=>{m||R(Zo,"WebChannel transport opened.")}),E(f.EventType.CLOSE,()=>{m||(m=!0,R(Zo,"WebChannel transport closed"),T.mw())}),E(f.EventType.ERROR,t=>{m||(m=!0,R(Zo,"WebChannel transport errored:",t),T.mw(new L(x.O,"The operation could not be completed")))}),E(f.EventType.MESSAGE,t=>{var e;if(!m){const s=t.data[0];p(!!s,"Got a webchannel message without data.");const n=s,i=n.error||(null===(e=n[0])||void 0===e?void 0:e.error);if(i){R(Zo,"WebChannel received error:",i);const t=i.status;let e=function(t){const e=Oe[t];if(void 0!==e)return je(e)}(t),s=i.message;void 0===e&&(e=x.INTERNAL,s="Unknown error status: "+t+" with message "+i.message),m=!0,T.mw(new L(e,s)),l.close()}else R(Zo,"WebChannel received:",s),T.Tw(s)}}),setTimeout(()=>{T.fw()},0),T}Iw(t){const e=sh[t];return p(void 0!==e,"Unknown REST mapping for: "+t),this.Ew+"/"+eh+"/projects/"+this.o.projectId+"/databases/"+this.o.database+"/documents:"+e}}Ss.Sr(new class{constructor(){this.di="",this.Dr="undefined"!=typeof atob}get document(){return"undefined"!=typeof document?document:null}get window(){return"undefined"!=typeof window?window:null}XT(t){return Promise.resolve(new rh(t))}tE(){return Yo.Nh()?new Yo:new Ho}eE(t){return new vs(t,{fi:!0})}s(t){return JSON.stringify(t)}atob(t){return atob(t)}btoa(t){return btoa(t)}});const oh="@firebase/firestore",hh="1.9.3";function ah(t){zo(t),t.registerVersion(oh,hh)}ah(t);export{ah as __PRIVATE_registerFirestore};
//# sourceMappingURL=index.esm2017.min.js.map
